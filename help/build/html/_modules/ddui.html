

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>ddui &mdash; DataDrivenInputMask 0.1 documentation</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="DataDrivenInputMask 0.1 documentation" href="../index.html" />
    <link rel="up" title="Module code" href="index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">DataDrivenInputMask 0.1 documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for ddui</h1><div class="highlight"><pre>
<span class="c"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">ddui</span>
<span class="sd">--------</span>
<span class="sd">Classes that make up or steer the DataDrivenUI</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">/***************************************************************************</span>
<span class="sd"> DataDrivenInputMask</span>
<span class="sd">                                 A QGIS plugin</span>
<span class="sd"> Applies a data-driven input mask to any PostGIS-Layer</span>
<span class="sd">                              -------------------</span>
<span class="sd">        begin                : 2012-06-21</span>
<span class="sd">        copyright            : (C) 2012 by Bernhard Strรถbl / Kommunale Immobilien Jena</span>
<span class="sd">        email                : bernhard.stroebl@jena.de</span>
<span class="sd"> ***************************************************************************/</span>

<span class="sd">/***************************************************************************</span>
<span class="sd"> *                                                                         *</span>
<span class="sd"> *   This program is free software; you can redistribute it and/or modify  *</span>
<span class="sd"> *   it under the terms of the GNU General Public License as published by  *</span>
<span class="sd"> *   the Free Software Foundation; either version 2 of the License, or     *</span>
<span class="sd"> *   (at your option) any later version.                                   *</span>
<span class="sd"> *                                                                         *</span>
<span class="sd"> ***************************************************************************/</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c"># Import the PyQt and QGIS libraries</span>
<span class="kn">from</span> <span class="nn">PyQt4</span> <span class="kn">import</span> <span class="n">QtCore</span><span class="p">,</span>  <span class="n">QtGui</span><span class="p">,</span>  <span class="n">QtSql</span>
<span class="kn">from</span> <span class="nn">qgis.core</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">dderror</span> <span class="kn">import</span> <span class="n">DdError</span><span class="p">,</span>  <span class="n">DbError</span>
<span class="kn">from</span> <span class="nn">ddattribute</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">dddialog</span> <span class="kn">import</span> <span class="n">DdDialog</span>

<div class="viewcode-block" id="DdFormHelper"><a class="viewcode-back" href="../autodoc.html#ddui.DdFormHelper">[docs]</a><span class="k">class</span> <span class="nc">DdFormHelper</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">thisDialog</span><span class="p">,</span> <span class="n">layerId</span><span class="p">,</span> <span class="n">featureId</span><span class="p">):</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">QgsApplication</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span>
        <span class="n">ddManager</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">ddManager</span>
        <span class="n">lIface</span> <span class="o">=</span> <span class="n">ddManager</span><span class="o">.</span><span class="n">iface</span><span class="o">.</span><span class="n">legendInterface</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">aLayer</span> <span class="ow">in</span> <span class="n">lIface</span><span class="o">.</span><span class="n">layers</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">aLayer</span><span class="o">.</span><span class="n">id</span><span class="p">()</span> <span class="o">==</span> <span class="n">layerId</span><span class="p">:</span>
                <span class="c">#QtGui.QMessageBox.information(None,  &quot;&quot;, aLayer.name())</span>
                <span class="c">#thisDialog.hide()</span>
                <span class="n">feat</span> <span class="o">=</span> <span class="n">QgsFeature</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">QGis</span><span class="o">.</span><span class="n">QGIS_VERSION_INT</span> <span class="o">&gt;=</span> <span class="mi">10900</span><span class="p">:</span>
                    <span class="n">featureFound</span> <span class="o">=</span> <span class="n">aLayer</span><span class="o">.</span><span class="n">getFeatures</span><span class="p">(</span><span class="n">QgsFeatureRequest</span><span class="p">()</span><span class="o">.</span><span class="n">setFilterFid</span><span class="p">(</span><span class="n">featureId</span><span class="p">)</span><span class="o">.</span><span class="n">setFlags</span><span class="p">(</span><span class="n">QgsFeatureRequest</span><span class="o">.</span><span class="n">NoGeometry</span><span class="p">))</span><span class="o">.</span><span class="n">nextFeature</span><span class="p">(</span><span class="n">feat</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">featureFound</span> <span class="o">=</span> <span class="n">aLayer</span><span class="o">.</span><span class="n">featureAtId</span><span class="p">(</span><span class="n">featureId</span><span class="p">,</span>  <span class="n">feat</span><span class="p">,</span>  <span class="bp">False</span><span class="p">,</span>  <span class="bp">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">featureFound</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">ddManager</span><span class="o">.</span><span class="n">showFeatureForm</span><span class="p">(</span><span class="n">aLayer</span><span class="p">,</span>  <span class="n">feat</span><span class="p">)</span>
                    <span class="c">#QtGui.QMessageBox.information(None,  &quot;&quot;, str(thisDialog))</span>
                    <span class="n">thisDialog</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">result</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">thisDialog</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">thisDialog</span><span class="o">.</span><span class="n">reject</span><span class="p">()</span>
                <span class="k">break</span>

        <span class="c">#self.prntWidget = self.thisDialog.parentWidget()</span>
        <span class="c">#QtGui.QMessageBox.information(None,  &quot;&quot;,  str(self.prntWidget))</span>
</div>
<div class="viewcode-block" id="ddFormInit1"><a class="viewcode-back" href="../autodoc.html#ddui.ddFormInit1">[docs]</a><span class="k">def</span> <span class="nf">ddFormInit1</span><span class="p">(</span><span class="n">dialog</span><span class="p">,</span> <span class="n">layerId</span><span class="p">,</span> <span class="n">featureId</span><span class="p">):</span>
    <span class="n">dialog</span><span class="o">.</span><span class="n">setProperty</span><span class="p">(</span><span class="s">&quot;helper&quot;</span><span class="p">,</span> <span class="n">DdFormHelper</span><span class="p">(</span><span class="n">dialog</span><span class="p">,</span> <span class="n">layerId</span><span class="p">,</span> <span class="n">featureId</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="ddFormInit"><a class="viewcode-back" href="../autodoc.html#ddui.ddFormInit">[docs]</a><span class="k">def</span> <span class="nf">ddFormInit</span><span class="p">(</span><span class="n">dialog</span><span class="p">,</span> <span class="n">layerId</span><span class="p">,</span> <span class="n">featureId</span><span class="p">):</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">QgsApplication</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span>
    <span class="n">ddManager</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">ddManager</span>
    <span class="n">lIface</span> <span class="o">=</span> <span class="n">ddManager</span><span class="o">.</span><span class="n">iface</span><span class="o">.</span><span class="n">legendInterface</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">aLayer</span> <span class="ow">in</span> <span class="n">lIface</span><span class="o">.</span><span class="n">layers</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">aLayer</span><span class="o">.</span><span class="n">id</span><span class="p">()</span> <span class="o">==</span> <span class="n">layerId</span><span class="p">:</span>
            <span class="c">#QtGui.QMessageBox.information(None,  &quot;&quot;, aLayer.name())</span>
            <span class="c">#thisDialog.hide()</span>
            <span class="n">feat</span> <span class="o">=</span> <span class="n">QgsFeature</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">QGis</span><span class="o">.</span><span class="n">QGIS_VERSION_INT</span> <span class="o">&gt;=</span> <span class="mi">10900</span><span class="p">:</span>
                <span class="n">featureFound</span> <span class="o">=</span> <span class="n">aLayer</span><span class="o">.</span><span class="n">getFeatures</span><span class="p">(</span><span class="n">QgsFeatureRequest</span><span class="p">()</span><span class="o">.</span><span class="n">setFilterFid</span><span class="p">(</span><span class="n">featureId</span><span class="p">)</span><span class="o">.</span><span class="n">setFlags</span><span class="p">(</span><span class="n">QgsFeatureRequest</span><span class="o">.</span><span class="n">NoGeometry</span><span class="p">))</span><span class="o">.</span><span class="n">nextFeature</span><span class="p">(</span><span class="n">feat</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">featureFound</span> <span class="o">=</span> <span class="n">aLayer</span><span class="o">.</span><span class="n">featureAtId</span><span class="p">(</span><span class="n">featureId</span><span class="p">,</span>  <span class="n">feat</span><span class="p">,</span>  <span class="bp">False</span><span class="p">,</span>  <span class="bp">True</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">featureFound</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">layerValues</span> <span class="o">=</span> <span class="n">ddManager</span><span class="o">.</span><span class="n">ddLayers</span><span class="p">[</span><span class="n">aLayer</span><span class="o">.</span><span class="n">id</span><span class="p">()]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">ddManager</span><span class="o">.</span><span class="n">initLayer</span><span class="p">(</span><span class="n">aLayer</span><span class="p">,</span>  <span class="n">skip</span> <span class="o">=</span> <span class="p">[])</span>
                    <span class="n">layerValues</span> <span class="o">=</span> <span class="n">ddManager</span><span class="o">.</span><span class="n">ddLayers</span><span class="p">[</span><span class="n">aLayer</span><span class="o">.</span><span class="n">id</span><span class="p">()]</span>

                <span class="c">#QtGui.QMessageBox.information(None, &quot;&quot;, str(layerValues[2]))</span>
                <span class="n">db</span> <span class="o">=</span> <span class="n">layerValues</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">ui</span> <span class="o">=</span> <span class="n">layerValues</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">dlg</span> <span class="o">=</span> <span class="n">DdDialog</span><span class="p">(</span><span class="n">ddManager</span><span class="p">,</span>  <span class="n">ui</span><span class="p">,</span>  <span class="n">aLayer</span><span class="p">,</span>  <span class="n">feat</span><span class="p">,</span>  <span class="n">db</span><span class="p">,</span>  <span class="n">dialog</span><span class="p">)</span>
                <span class="n">dlg</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">result</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">layer</span><span class="o">.</span><span class="n">setModified</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="DdManager"><a class="viewcode-back" href="../autodoc.html#ddui.DdManager">[docs]</a><span class="k">class</span> <span class="nc">DdManager</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;DdManager manages all masks in the current project&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">iface</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">iface</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ddLayers</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__debug</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">title</span><span class="p">,</span>  <span class="nb">str</span><span class="p">):</span>
        <span class="n">QtGui</span><span class="o">.</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">information</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span>  <span class="n">title</span><span class="p">,</span>  <span class="nb">str</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;&lt;ddui.DdManager&gt;&quot;</span>

<div class="viewcode-block" id="DdManager.initLayer"><a class="viewcode-back" href="../autodoc.html#ddui.DdManager.initLayer">[docs]</a>    <span class="k">def</span> <span class="nf">initLayer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">layer</span><span class="p">,</span>  <span class="n">skip</span> <span class="o">=</span> <span class="p">[],</span>  <span class="n">labels</span> <span class="o">=</span> <span class="p">{},</span>  <span class="n">fieldOrder</span> <span class="o">=</span> <span class="p">[],</span>  <span class="n">showParents</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>  <span class="n">createAction</span> <span class="o">=</span> <span class="bp">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;api method initLayer: initialize the layer with a data-driven input mask&#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="mi">0</span> <span class="o">!=</span> <span class="n">layer</span><span class="o">.</span><span class="n">type</span><span class="p">():</span>   <span class="c"># not a vector layer</span>
            <span class="n">DdError</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s">&quot;DdError&quot;</span><span class="p">,</span> <span class="s">&quot;Layer is not a vector layer: &quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span>
                                                           <span class="n">QtGui</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">UnicodeUTF8</span><span class="p">)</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="p">()))</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QString</span><span class="p">(</span><span class="s">u&#39;PostgreSQL&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">layer</span><span class="o">.</span><span class="n">dataProvider</span><span class="p">()</span><span class="o">.</span><span class="n">storageType</span><span class="p">()</span><span class="o">.</span><span class="n">left</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="p">:</span>
                <span class="n">DdError</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s">&quot;DdError&quot;</span><span class="p">,</span> <span class="s">&quot;Layer is not a PostgreSQL layer: &quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span>
                                                               <span class="n">QtGui</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">UnicodeUTF8</span><span class="p">)</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="p">()))</span>
                <span class="k">return</span> <span class="bp">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__createDb</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
                <span class="n">layerSrc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__analyzeSource</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
                <span class="n">relation</span> <span class="o">=</span> <span class="n">layerSrc</span><span class="p">[</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QString</span><span class="p">(</span><span class="s">u&quot;table&quot;</span><span class="p">)]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;&quot;.&quot;&#39;</span><span class="p">)</span>
                <span class="n">schema</span> <span class="o">=</span> <span class="n">relation</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
                <span class="n">table</span> <span class="o">=</span> <span class="n">relation</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
                <span class="c">#QtGui.QMessageBox.information(None, &quot;&quot;,  schema + &#39;.&#39; + table)</span>
                <span class="n">thisTable</span> <span class="o">=</span> <span class="n">DdTable</span><span class="p">(</span><span class="n">schemaName</span> <span class="o">=</span> <span class="n">schema</span><span class="p">,</span>  <span class="n">tableName</span> <span class="o">=</span> <span class="n">table</span><span class="p">,</span>  <span class="n">title</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
                <span class="n">thisTable</span><span class="o">.</span><span class="n">oid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getOid</span><span class="p">(</span><span class="n">thisTable</span><span class="p">,</span>  <span class="n">db</span><span class="p">)</span>
                <span class="n">comment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getComment</span><span class="p">(</span><span class="n">thisTable</span><span class="p">,</span>  <span class="n">db</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">comment</span><span class="p">:</span>
                    <span class="n">thisTable</span><span class="o">.</span><span class="n">comment</span> <span class="o">=</span> <span class="n">comment</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__isTable</span><span class="p">(</span><span class="n">thisTable</span><span class="p">,</span>  <span class="n">db</span><span class="p">):</span>
                    <span class="n">DdError</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s">&quot;DdError&quot;</span><span class="p">,</span> <span class="s">&quot;Layer is not a PostgreSQL table: &quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span>
                                                                       <span class="n">QtGui</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">UnicodeUTF8</span><span class="p">)</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="p">()))</span>
                    <span class="k">return</span> <span class="bp">None</span>

                <span class="n">ddui</span> <span class="o">=</span> <span class="n">DataDrivenUi</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iface</span><span class="p">)</span>
                <span class="n">ui</span> <span class="o">=</span> <span class="n">ddui</span><span class="o">.</span><span class="n">createUi</span><span class="p">(</span><span class="n">thisTable</span><span class="p">,</span>  <span class="n">db</span><span class="p">,</span>  <span class="n">skip</span><span class="p">,</span>  <span class="n">labels</span><span class="p">,</span>  <span class="n">fieldOrder</span><span class="p">,</span>  <span class="n">showParents</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ddLayers</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">id</span><span class="p">(),</span>  <span class="bp">None</span><span class="p">)</span> <span class="c"># remove entries if they exist</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ddLayers</span><span class="p">[</span><span class="n">layer</span><span class="o">.</span><span class="n">id</span><span class="p">()]</span> <span class="o">=</span> <span class="p">[</span><span class="n">thisTable</span><span class="p">,</span>  <span class="n">db</span><span class="p">,</span>  <span class="n">ui</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__connectSignals</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">createAction</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
 </div>
<div class="viewcode-block" id="DdManager.addAction"><a class="viewcode-back" href="../autodoc.html#ddui.DdManager.addAction">[docs]</a>    <span class="k">def</span> <span class="nf">addAction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">layer</span><span class="p">,</span>  <span class="n">actionName</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QString</span><span class="p">(</span><span class="s">u&#39;showDdForm&#39;</span><span class="p">)):</span>
        <span class="sd">&#39;&#39;&#39;api method to add an action to the layer with a self defined name&#39;&#39;&#39;</span>
        
        <span class="n">createAction</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="c">#check if the action is already attached</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">actions</span><span class="p">()</span><span class="o">.</span><span class="n">size</span><span class="p">()):</span>
            <span class="n">act</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">actions</span><span class="p">()</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">act</span><span class="o">.</span><span class="n">name</span><span class="p">()</span> <span class="o">==</span> <span class="n">actionName</span><span class="p">:</span>
                <span class="n">createAction</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="n">createAction</span><span class="p">:</span>
            <span class="n">layer</span><span class="o">.</span><span class="n">actions</span><span class="p">()</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>  <span class="n">actionName</span><span class="p">,</span> <span class="c"># actionType 1: Python</span>
                                 <span class="n">QtCore</span><span class="o">.</span><span class="n">QString</span><span class="p">(</span><span class="s">&quot;app=QgsApplication.instance();ddManager=app.ddManager;ddManager.showDdForm([% $id %]);&quot;</span><span class="p">))</span>
    </div>
<div class="viewcode-block" id="DdManager.removeAction"><a class="viewcode-back" href="../autodoc.html#ddui.DdManager.removeAction">[docs]</a>    <span class="k">def</span> <span class="nf">removeAction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">layer</span><span class="p">,</span>  <span class="n">actionName</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;api method to remove an action from the layer&#39;&#39;&#39;</span>
        
        <span class="n">wereActions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">actions</span><span class="p">()</span><span class="o">.</span><span class="n">size</span><span class="p">()):</span>
            <span class="n">act</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">actions</span><span class="p">()</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">act</span><span class="o">.</span><span class="n">name</span><span class="p">()</span> <span class="o">!=</span> <span class="n">actionName</span><span class="p">:</span>
                <span class="n">wereActions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">act</span><span class="p">)</span>
                
        <span class="n">layer</span><span class="o">.</span><span class="n">actions</span><span class="p">()</span><span class="o">.</span><span class="n">clearActions</span><span class="p">()</span>
        
        <span class="k">for</span> <span class="n">act</span> <span class="ow">in</span> <span class="n">wereActions</span><span class="p">:</span>
            <span class="n">layer</span><span class="o">.</span><span class="n">actions</span><span class="p">()</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="n">act</span><span class="o">.</span><span class="n">type</span><span class="p">(),</span>  <span class="n">act</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">act</span><span class="o">.</span><span class="n">action</span><span class="p">())</span>
        </div>
<div class="viewcode-block" id="DdManager.showFeatureForm"><a class="viewcode-back" href="../autodoc.html#ddui.DdManager.showFeatureForm">[docs]</a>    <span class="k">def</span> <span class="nf">showFeatureForm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">layer</span><span class="p">,</span>  <span class="n">feature</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;api method showFeatureForm: show the data-driven input mask for a layer and a feature&#39;&#39;&#39;</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">layerValues</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ddLayers</span><span class="p">[</span><span class="n">layer</span><span class="o">.</span><span class="n">id</span><span class="p">()]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initLayer</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span>  <span class="n">skip</span> <span class="o">=</span> <span class="p">[])</span>
            <span class="n">layerValues</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ddLayers</span><span class="p">[</span><span class="n">layer</span><span class="o">.</span><span class="n">id</span><span class="p">()]</span>

        <span class="c">#QtGui.QMessageBox.information(None, &quot;&quot;, str(layerValues[2]))</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">layerValues</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">ui</span> <span class="o">=</span> <span class="n">layerValues</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">dlg</span> <span class="o">=</span> <span class="n">DdDialog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">ui</span><span class="p">,</span>  <span class="n">layer</span><span class="p">,</span>  <span class="n">feature</span><span class="p">,</span>  <span class="n">db</span><span class="p">)</span>
        <span class="n">dlg</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">result</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">layer</span><span class="o">.</span><span class="n">setModified</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">result</span>
</div>
<div class="viewcode-block" id="DdManager.showDdForm"><a class="viewcode-back" href="../autodoc.html#ddui.DdManager.showDdForm">[docs]</a>    <span class="k">def</span> <span class="nf">showDdForm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">fid</span><span class="p">):</span>
        <span class="n">aLayer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iface</span><span class="o">.</span><span class="n">activeLayer</span><span class="p">()</span>
        <span class="n">feat</span> <span class="o">=</span> <span class="n">QgsFeature</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">QGis</span><span class="o">.</span><span class="n">QGIS_VERSION_INT</span> <span class="o">&gt;=</span> <span class="mi">10900</span><span class="p">:</span>
            <span class="n">featureFound</span> <span class="o">=</span> <span class="n">aLayer</span><span class="o">.</span><span class="n">getFeatures</span><span class="p">(</span><span class="n">QgsFeatureRequest</span><span class="p">()</span><span class="o">.</span><span class="n">setFilterFid</span><span class="p">(</span><span class="n">fid</span><span class="p">)</span><span class="o">.</span><span class="n">setFlags</span><span class="p">(</span><span class="n">QgsFeatureRequest</span><span class="o">.</span><span class="n">NoGeometry</span><span class="p">))</span><span class="o">.</span><span class="n">nextFeature</span><span class="p">(</span><span class="n">feat</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">featureFound</span> <span class="o">=</span> <span class="n">aLayer</span><span class="o">.</span><span class="n">featureAtId</span><span class="p">(</span><span class="n">fid</span><span class="p">,</span>  <span class="n">feat</span><span class="p">,</span>  <span class="bp">False</span><span class="p">,</span>  <span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">featureFound</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">showFeatureForm</span><span class="p">(</span><span class="n">aLayer</span><span class="p">,</span>  <span class="n">feat</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="DdManager.setUi"><a class="viewcode-back" href="../autodoc.html#ddui.DdManager.setUi">[docs]</a>    <span class="k">def</span> <span class="nf">setUi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">layer</span><span class="p">,</span>  <span class="n">ui</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;api method to exchange the default ui with a custom ui&#39;&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">layerValues</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ddLayers</span><span class="p">[</span><span class="n">layer</span><span class="o">.</span><span class="n">id</span><span class="p">()]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initLayer</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span>  <span class="n">skip</span> <span class="o">=</span> <span class="p">[])</span>
            <span class="n">layerValues</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ddLayers</span><span class="p">[</span><span class="n">layer</span><span class="o">.</span><span class="n">id</span><span class="p">()]</span>

        <span class="c">#QtGui.QMessageBox.information(None, &quot;&quot;, str(layerValues[2]))</span>
        <span class="n">thisTable</span> <span class="o">=</span> <span class="n">layerValues</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">layerValues</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ddLayers</span><span class="p">[</span><span class="n">layer</span><span class="o">.</span><span class="n">id</span><span class="p">()]</span> <span class="o">=</span> <span class="p">[</span><span class="n">thisTable</span><span class="p">,</span>  <span class="n">db</span><span class="p">,</span>  <span class="n">ui</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="DdManager.setDb"><a class="viewcode-back" href="../autodoc.html#ddui.DdManager.setDb">[docs]</a>    <span class="k">def</span> <span class="nf">setDb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">layer</span><span class="p">,</span>  <span class="n">db</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;api method to set the db for a layer&#39;&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">layerValues</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ddLayers</span><span class="p">[</span><span class="n">layer</span><span class="o">.</span><span class="n">id</span><span class="p">()]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initLayer</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span>  <span class="n">skip</span> <span class="o">=</span> <span class="p">[])</span>
            <span class="n">layerValues</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ddLayers</span><span class="p">[</span><span class="n">layer</span><span class="o">.</span><span class="n">id</span><span class="p">()]</span>

        <span class="n">thisTable</span> <span class="o">=</span> <span class="n">layerValues</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ui</span> <span class="o">=</span> <span class="n">layerValues</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ddLayers</span><span class="p">[</span><span class="n">layer</span><span class="o">.</span><span class="n">id</span><span class="p">()]</span> <span class="o">=</span> <span class="p">[</span><span class="n">thisTable</span><span class="p">,</span>  <span class="n">db</span><span class="p">,</span>  <span class="n">ui</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="DdManager.findPostgresLayer"><a class="viewcode-back" href="../autodoc.html#ddui.DdManager.findPostgresLayer">[docs]</a>    <span class="k">def</span> <span class="nf">findPostgresLayer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span>  <span class="n">ddTable</span><span class="p">):</span>
        <span class="n">layerList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iface</span><span class="o">.</span><span class="n">legendInterface</span><span class="p">()</span><span class="o">.</span><span class="n">layers</span><span class="p">()</span>
        <span class="n">procLayer</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># ini</span>

        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">layerList</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">QgsVectorLayer</span><span class="p">):</span>
                <span class="n">src</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">source</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">src</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s">&quot;table=</span><span class="se">\&quot;</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">ddTable</span><span class="o">.</span><span class="n">schemaName</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">.</span><span class="se">\&quot;</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">ddTable</span><span class="o">.</span><span class="n">tableName</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">)</span> <span class="ow">and</span> \
                    <span class="n">src</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">databaseName</span><span class="p">())</span> <span class="ow">and</span> \
                    <span class="n">src</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">hostName</span><span class="p">()):</span>
                    <span class="n">procLayer</span> <span class="o">=</span> <span class="n">layer</span>
                    <span class="k">break</span>

        <span class="k">return</span> <span class="n">procLayer</span>
</div>
<div class="viewcode-block" id="DdManager.loadPostGISLayer"><a class="viewcode-back" href="../autodoc.html#ddui.DdManager.loadPostGISLayer">[docs]</a>    <span class="k">def</span> <span class="nf">loadPostGISLayer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">db</span><span class="p">,</span> <span class="n">ddTable</span><span class="p">,</span> <span class="n">displayName</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">geomColumn</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QString</span><span class="p">(),</span> <span class="n">whereClause</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">keyColumn</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">displayName</span><span class="p">:</span>
            <span class="n">displayName</span> <span class="o">=</span> <span class="n">ddTable</span><span class="o">.</span><span class="n">schemaName</span> <span class="o">+</span> <span class="s">&quot;.&quot;</span> <span class="o">+</span> <span class="n">ddTable</span><span class="o">.</span><span class="n">tableName</span>

        <span class="n">uri</span> <span class="o">=</span> <span class="n">QgsDataSourceURI</span><span class="p">()</span>
        <span class="n">thisPort</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">port</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">thisPort</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">thisPort</span> <span class="o">=</span> <span class="mi">5432</span>

        <span class="c"># set host name, port, database name, username and password</span>
        <span class="n">uri</span><span class="o">.</span><span class="n">setConnection</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">hostName</span><span class="p">(),</span> <span class="nb">str</span><span class="p">(</span><span class="n">thisPort</span><span class="p">),</span> <span class="n">db</span><span class="o">.</span><span class="n">databaseName</span><span class="p">(),</span> <span class="n">db</span><span class="o">.</span><span class="n">userName</span><span class="p">(),</span> <span class="n">db</span><span class="o">.</span><span class="n">password</span><span class="p">())</span>
        <span class="c"># set database schema, table name, geometry column and optionaly subset (WHERE clause)</span>

        <span class="n">uri</span><span class="o">.</span><span class="n">setDataSource</span><span class="p">(</span><span class="n">ddTable</span><span class="o">.</span><span class="n">schemaName</span><span class="p">,</span> <span class="n">ddTable</span><span class="o">.</span><span class="n">tableName</span><span class="p">,</span> <span class="n">geomColumn</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">whereClause</span><span class="p">:</span>
            <span class="n">uri</span><span class="o">.</span><span class="n">setSql</span><span class="p">(</span><span class="n">whereClause</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">keyColumn</span><span class="p">:</span>
            <span class="n">uri</span><span class="o">.</span><span class="n">setKeyColumn</span><span class="p">(</span><span class="n">keyColumn</span><span class="p">)</span>
        <span class="n">vlayer</span> <span class="o">=</span> <span class="n">QgsVectorLayer</span><span class="p">(</span><span class="n">uri</span><span class="o">.</span><span class="n">uri</span><span class="p">(),</span> <span class="n">displayName</span><span class="p">,</span> <span class="s">&quot;postgres&quot;</span><span class="p">)</span>
        <span class="n">QgsMapLayerRegistry</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">addMapLayers</span><span class="p">([</span><span class="n">vlayer</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">vlayer</span>
</div>
<div class="viewcode-block" id="DdManager.quit"><a class="viewcode-back" href="../autodoc.html#ddui.DdManager.quit">[docs]</a>    <span class="k">def</span> <span class="nf">quit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">ddLayer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ddLayers</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">db</span> <span class="o">=</span> <span class="n">ddLayer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__disconnectDb</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>

    <span class="c">#Slots</span></div>
<div class="viewcode-block" id="DdManager.editingStarted"><a class="viewcode-back" href="../autodoc.html#ddui.DdManager.editingStarted">[docs]</a>    <span class="k">def</span> <span class="nf">editingStarted</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">layer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iface</span><span class="o">.</span><span class="n">activeLayer</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">layerValues</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ddLayers</span><span class="p">[</span><span class="n">layer</span><span class="o">.</span><span class="n">id</span><span class="p">()]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initLayer</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span>  <span class="n">skip</span> <span class="o">=</span> <span class="p">[])</span>
            <span class="n">layerValues</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ddLayers</span><span class="p">[</span><span class="n">layer</span><span class="o">.</span><span class="n">id</span><span class="p">()]</span>

        <span class="c">#QtGui.QMessageBox.information(None, &quot;&quot;, str(layerValues[2]))</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">layerValues</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">db</span><span class="p">:</span>
            <span class="n">db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ceateDb</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setDb</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span>  <span class="n">db</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">db</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
            <span class="n">DdError</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s">&quot;DdError&quot;</span><span class="p">,</span> <span class="s">&quot;Error starting transaction on DB &quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span>
                                                           <span class="n">QtGui</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">UnicodeUTF8</span><span class="p">)</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">databaseName</span><span class="p">()))</span>
            <span class="k">return</span> <span class="bp">None</span>
        </div>
<div class="viewcode-block" id="DdManager.editingStopped"><a class="viewcode-back" href="../autodoc.html#ddui.DdManager.editingStopped">[docs]</a>    <span class="k">def</span> <span class="nf">editingStopped</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">layer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iface</span><span class="o">.</span><span class="n">activeLayer</span><span class="p">()</span>
        <span class="n">db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ddLayers</span><span class="p">[</span><span class="n">layer</span><span class="o">.</span><span class="n">id</span><span class="p">()][</span><span class="mi">1</span><span class="p">]</span>
        <span class="c">#QtGui.QMessageBox.information(None, &quot;modified&quot;, str(layer.isModified()))</span>
        <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">isModified</span><span class="p">():</span>
            <span class="c">#QtGui.QMessageBox.information(None, &quot;modified&quot;, &quot;rolling back&quot;)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">():</span>
                <span class="n">DdError</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s">&quot;DdError&quot;</span><span class="p">,</span> <span class="s">&quot;Error rolling back transaction on DB &quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span>
                                                           <span class="n">QtGui</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">UnicodeUTF8</span><span class="p">)</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">hostName</span><span class="p">())</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">databaseName</span><span class="p">()))</span>
                <span class="k">return</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c">#QtGui.QMessageBox.information(None, &quot;not modified&quot;, &quot;committing&quot;)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">():</span>
                <span class="n">DdError</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s">&quot;DdError&quot;</span><span class="p">,</span> <span class="s">&quot;Error committing transaction on DB &quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span>
                                                           <span class="n">QtGui</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">UnicodeUTF8</span><span class="p">)</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">hostName</span><span class="p">())</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">databaseName</span><span class="p">()))</span>
                <span class="k">return</span> <span class="bp">None</span>

        <span class="c"># better keep the connection, if too many connections exist we must change this</span>
        <span class="c">#self.__disconnectDb(db)</span>
        <span class="c">#self.setDb(layer,  None)</span>
</div>
    <span class="k">def</span> <span class="nf">__getComment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">thisTable</span><span class="p">,</span>  <span class="n">db</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; query the DB to get a table&#39;s comment&#39;&#39;&#39;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">QtSql</span><span class="o">.</span><span class="n">QSqlQuery</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
        <span class="n">sQuery</span> <span class="o">=</span> <span class="s">&quot;SELECT description FROM pg_description </span><span class="se">\</span>
<span class="s">        WHERE objoid = :oid AND objsubid = 0&quot;</span>
        <span class="c"># objsubid = 0 is the table, objsubid &gt; 0 are comments on fields</span>
        <span class="n">query</span><span class="o">.</span><span class="n">prepare</span><span class="p">(</span><span class="n">sQuery</span><span class="p">)</span>
        <span class="n">query</span><span class="o">.</span><span class="n">bindValue</span><span class="p">(</span><span class="s">&quot;:oid&quot;</span><span class="p">,</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QVariant</span><span class="p">(</span><span class="n">thisTable</span><span class="o">.</span><span class="n">oid</span><span class="p">))</span>
        <span class="n">query</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span>

        <span class="n">comment</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">isActive</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">query</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">while</span> <span class="n">query</span><span class="o">.</span><span class="n">next</span><span class="p">():</span>
                    <span class="n">comment</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">toString</span><span class="p">()</span>
                    <span class="k">break</span>
                <span class="n">query</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">DbError</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">comment</span>

    <span class="k">def</span> <span class="nf">__getOid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">thisTable</span><span class="p">,</span>  <span class="n">db</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; query the DB to get a table&#39;s oid&#39;&#39;&#39;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">QtSql</span><span class="o">.</span><span class="n">QSqlQuery</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
        <span class="n">sQuery</span> <span class="o">=</span> <span class="s">&quot;SELECT c.oid FROM pg_class c </span><span class="se">\</span>
<span class="s">        JOIN pg_namespace n ON c.relnamespace = n.oid </span><span class="se">\</span>
<span class="s">        WHERE n.nspname = :schema AND c.relname = :table&quot;</span>
        <span class="n">query</span><span class="o">.</span><span class="n">prepare</span><span class="p">(</span><span class="n">sQuery</span><span class="p">)</span>
        <span class="n">query</span><span class="o">.</span><span class="n">bindValue</span><span class="p">(</span><span class="s">&quot;:schema&quot;</span><span class="p">,</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QVariant</span><span class="p">(</span><span class="n">thisTable</span><span class="o">.</span><span class="n">schemaName</span><span class="p">))</span>
        <span class="n">query</span><span class="o">.</span><span class="n">bindValue</span><span class="p">(</span><span class="s">&quot;:table&quot;</span><span class="p">,</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QVariant</span><span class="p">(</span><span class="n">thisTable</span><span class="o">.</span><span class="n">tableName</span><span class="p">))</span>
        <span class="n">query</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span>

        <span class="n">oid</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">isActive</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">query</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">while</span> <span class="n">query</span><span class="o">.</span><span class="n">next</span><span class="p">():</span>
                    <span class="n">oid</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">toInt</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">break</span>
                <span class="n">query</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">DbError</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">oid</span>

    <span class="k">def</span> <span class="nf">__isTable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">thisTable</span><span class="p">,</span>  <span class="n">db</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;checks if the given relation is a table&#39;&#39;&#39;</span>

        <span class="n">query</span> <span class="o">=</span> <span class="n">QtSql</span><span class="o">.</span><span class="n">QSqlQuery</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
        <span class="n">sQuery</span> <span class="o">=</span> <span class="s">&quot;SELECT * FROM pg_tables WHERE schemaname = :schema AND tablename = :table&quot;</span>
        <span class="n">query</span><span class="o">.</span><span class="n">prepare</span><span class="p">(</span><span class="n">sQuery</span><span class="p">)</span>
        <span class="n">query</span><span class="o">.</span><span class="n">bindValue</span><span class="p">(</span><span class="s">&quot;:schema&quot;</span><span class="p">,</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QVariant</span><span class="p">(</span><span class="n">thisTable</span><span class="o">.</span><span class="n">schemaName</span><span class="p">))</span>
        <span class="n">query</span><span class="o">.</span><span class="n">bindValue</span><span class="p">(</span><span class="s">&quot;:table&quot;</span><span class="p">,</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QVariant</span><span class="p">(</span><span class="n">thisTable</span><span class="o">.</span><span class="n">tableName</span><span class="p">))</span>
        <span class="n">query</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">isActive</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">query</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
                <span class="k">return</span> <span class="bp">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">query</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
                <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">DbError</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">__connectSignals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">layer</span><span class="p">):</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">editingStarted</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">editingStarted</span><span class="p">)</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">editingStopped</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">editingStopped</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__analyzeSource</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">layer</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Split the layer&#39;s source information and return them as a dict&#39;&#39;&#39;</span>
        <span class="n">src</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">source</span><span class="p">()</span>
        <span class="n">srcList</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">anElement</span> <span class="ow">in</span> <span class="n">srcList</span><span class="p">:</span>
            <span class="n">aPair</span> <span class="o">=</span> <span class="n">anElement</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;&#39;&quot;</span><span class="p">,</span>  <span class="s">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;=&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="mi">2</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">aPair</span><span class="p">):</span>
                <span class="n">result</span><span class="p">[</span><span class="n">aPair</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">aPair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">__connectDb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">qSqlDatabaseName</span><span class="p">,</span>  <span class="n">host</span><span class="p">,</span>  <span class="n">database</span><span class="p">,</span>  <span class="n">port</span><span class="p">,</span>  <span class="n">username</span><span class="p">,</span>  <span class="n">passwd</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;connect to the PostgreSQL DB&#39;&#39;&#39;</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">QtSql</span><span class="o">.</span><span class="n">QSqlDatabase</span><span class="o">.</span><span class="n">addDatabase</span> <span class="p">(</span><span class="s">&quot;QPSQL&quot;</span><span class="p">,</span>  <span class="n">qSqlDatabaseName</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">setHostName</span><span class="p">(</span><span class="n">host</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">setPort</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">setDatabaseName</span><span class="p">(</span><span class="n">database</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">setUserName</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">setPassword</span><span class="p">(</span><span class="n">passwd</span><span class="p">)</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
            <span class="n">DdError</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s">&quot;DdError&quot;</span><span class="p">,</span> <span class="s">&quot;Could not connect to PostgreSQL database:&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span>
                                                 <span class="n">QtGui</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">UnicodeUTF8</span><span class="p">)</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">database</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">db</span>

    <span class="k">def</span> <span class="nf">__createDb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">layer</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;create a QtSql.QSqlDatabase object  for the DB-connection this layer comes from&#39;&#39;&#39;</span>
        <span class="n">layerSrc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__analyzeSource</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
        <span class="n">db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__connectDb</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">id</span><span class="p">(),</span>  <span class="n">layerSrc</span><span class="p">[</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QString</span><span class="p">(</span><span class="s">u&quot;host&quot;</span><span class="p">)],</span>  <span class="n">layerSrc</span><span class="p">[</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QString</span><span class="p">(</span><span class="s">u&quot;dbname&quot;</span><span class="p">)],</span>
            <span class="n">layerSrc</span><span class="p">[</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QString</span><span class="p">(</span><span class="s">u&quot;port&quot;</span><span class="p">)]</span><span class="o">.</span><span class="n">toInt</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span>  <span class="n">layerSrc</span><span class="p">[</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QString</span><span class="p">(</span><span class="s">u&quot;user&quot;</span><span class="p">)],</span>
            <span class="n">layerSrc</span><span class="p">[</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QString</span><span class="p">(</span><span class="s">u&quot;password&quot;</span><span class="p">)])</span>
        <span class="k">return</span> <span class="n">db</span>

    <span class="k">def</span> <span class="nf">__disconnectDb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">db</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;disconnect from the DB&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">db</span><span class="p">:</span>
            <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">db</span> <span class="o">=</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="DataDrivenUi"><a class="viewcode-back" href="../autodoc.html#ddui.DataDrivenUi">[docs]</a><span class="k">class</span> <span class="nc">DataDrivenUi</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Creates the DataDrivenUi</span>
<span class="sd">    </span>
<span class="sd">    When subclassing this class, you want to rewrite createUi and use DdManager&#39;s setUi</span>
<span class="sd">    method to apply your custom ui to the layer&#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">iface</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">iface</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;&lt;ddui.DataDrivenUi&gt;&quot;</span>

    <span class="k">def</span> <span class="nf">__createForms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">thisTable</span><span class="p">,</span>  <span class="n">db</span><span class="p">,</span>  <span class="n">skip</span><span class="p">,</span>  <span class="n">labels</span><span class="p">,</span>  <span class="n">fieldOrder</span><span class="p">,</span>  <span class="n">showParents</span><span class="p">,</span>  <span class="n">showChildren</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;create the forms (DdFom instances) shown in the tabs of  the Dialog (DdDialog instance)&quot;&quot;&quot;</span>
        <span class="n">ddForms</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ddAttributes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getAttributes</span><span class="p">(</span><span class="n">thisTable</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span>  <span class="n">labels</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">anAtt</span> <span class="ow">in</span> <span class="n">ddAttributes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">anAtt</span><span class="o">.</span><span class="n">isPK</span><span class="p">:</span>
                <span class="c">#QtGui.QMessageBox.information(None, &quot;debug&quot;,  anAtt.name + &quot; isPK&quot;)</span>
                <span class="n">n2mAttributes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getN2mAttributes</span><span class="p">(</span><span class="n">db</span><span class="p">,</span>  <span class="n">thisTable</span><span class="p">,</span>  <span class="n">anAtt</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>  <span class="n">anAtt</span><span class="o">.</span><span class="n">num</span><span class="p">,</span>  <span class="n">labels</span><span class="p">,</span>  <span class="n">showChildren</span><span class="p">)</span>
                <span class="n">ddAttributes</span> <span class="o">=</span> <span class="n">ddAttributes</span> <span class="o">+</span> <span class="n">n2mAttributes</span>

        <span class="c">#check if we need a QToolBox</span>
        <span class="n">needsToolBox</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ddAttributes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span>

        <span class="n">unorderedAttributes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="c"># loop through the attributes and get one-line types (QLineEdit, QComboBox) first</span>
        <span class="k">for</span> <span class="n">anAttribute</span> <span class="ow">in</span> <span class="n">ddAttributes</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="n">anAttribute</span><span class="o">.</span><span class="n">name</span>

            <span class="n">nextAtt</span> <span class="o">=</span> <span class="bp">False</span>
             <span class="c">#check if this attribute is supposed to be skipped</span>
            <span class="k">for</span> <span class="n">skipName</span> <span class="ow">in</span> <span class="n">skip</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">skipName</span> <span class="o">==</span> <span class="n">anAttribute</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                    <span class="c">#QtGui.QMessageBox.information(None, &quot;debug&quot;,  &quot;skipping &quot; + anAttribute.name)</span>
                    <span class="n">nextAtt</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">break</span>

            <span class="k">if</span> <span class="n">nextAtt</span><span class="p">:</span>
                <span class="k">continue</span> <span class="c"># skip it</span>

            <span class="k">if</span> <span class="n">anAttribute</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s">&quot;text&quot;</span> <span class="ow">or</span> <span class="n">anAttribute</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s">&quot;n2m&quot;</span> <span class="ow">or</span> <span class="n">anAttribute</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s">&quot;table&quot;</span><span class="p">:</span>
                <span class="n">needsToolBox</span> <span class="o">=</span> <span class="bp">True</span>
                
            <span class="n">unorderedAttributes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">anAttribute</span><span class="p">)</span>
        
        <span class="c"># create an ordered list of attributes</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fieldOrder</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">orderedAttributes</span> <span class="o">=</span> <span class="p">[]</span>
            
            <span class="k">for</span> <span class="n">aFieldName</span> <span class="ow">in</span> <span class="n">fieldOrder</span><span class="p">:</span>
                <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">while</span> <span class="n">counter</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">unorderedAttributes</span><span class="p">):</span>
                    <span class="n">anAttribute</span> <span class="o">=</span> <span class="n">unorderedAttributes</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

                    <span class="k">if</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QString</span><span class="p">(</span><span class="n">aFieldName</span><span class="p">)</span> <span class="o">==</span> <span class="n">anAttribute</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                        <span class="n">orderedAttributes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">anAttribute</span><span class="p">)</span>
                        <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">unorderedAttributes</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span>  <span class="n">anAttribute</span><span class="p">)</span>
                    
                    <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="c"># put the rest in</span>
            <span class="n">orderedAttributes</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">unorderedAttributes</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">orderedAttributes</span> <span class="o">=</span> <span class="n">unorderedAttributes</span>
            <span class="c">#QtGui.QMessageBox.information(None, &quot;attribute&quot;,  anAttribute.name)</span>
        
        <span class="n">ddFormWidget</span> <span class="o">=</span> <span class="n">DdFormWidget</span><span class="p">(</span><span class="n">thisTable</span><span class="p">,</span>  <span class="n">needsToolBox</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">anAttribute</span> <span class="ow">in</span> <span class="n">orderedAttributes</span><span class="p">:</span>
            <span class="c">#QtGui.QMessageBox.information(None, &quot;orderedAttribute&quot;,  anAttribute.name)</span>
            <span class="k">if</span> <span class="n">anAttribute</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s">&quot;text&quot;</span><span class="p">:</span>
                <span class="n">ddInputWidget</span> <span class="o">=</span> <span class="n">DdTextEdit</span><span class="p">(</span><span class="n">anAttribute</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">anAttribute</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s">&quot;n2m&quot;</span><span class="p">:</span>

                <span class="k">if</span> <span class="n">anAttribute</span><span class="o">.</span><span class="n">subType</span> <span class="o">==</span> <span class="s">&quot;list&quot;</span><span class="p">:</span>
                    <span class="n">ddInputWidget</span> <span class="o">=</span> <span class="n">DdN2mListWidget</span><span class="p">(</span><span class="n">anAttribute</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">anAttribute</span><span class="o">.</span><span class="n">subType</span> <span class="o">==</span> <span class="s">&quot;tree&quot;</span><span class="p">:</span>
                    <span class="n">ddInputWidget</span> <span class="o">=</span> <span class="n">DdN2mTreeWidget</span><span class="p">(</span><span class="n">anAttribute</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">anAttribute</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s">&quot;table&quot;</span><span class="p">:</span>
                <span class="n">ddInputWidget</span> <span class="o">=</span> <span class="n">DdN2mTableWidget</span><span class="p">(</span><span class="n">anAttribute</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="c"># on line attributes</span>
                <span class="k">if</span> <span class="n">anAttribute</span><span class="o">.</span><span class="n">isFK</span><span class="p">:</span>
                    <span class="n">ddInputWidget</span> <span class="o">=</span> <span class="n">DdComboBox</span><span class="p">(</span><span class="n">anAttribute</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">anAttribute</span><span class="o">.</span><span class="n">isTypeFloat</span><span class="p">():</span>
                        <span class="n">ddInputWidget</span> <span class="o">=</span> <span class="n">DdLineEditDouble</span><span class="p">(</span><span class="n">anAttribute</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">anAttribute</span><span class="o">.</span><span class="n">isTypeInt</span><span class="p">():</span>
                        <span class="n">ddInputWidget</span> <span class="o">=</span> <span class="n">DdLineEditInt</span><span class="p">(</span><span class="n">anAttribute</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">anAttribute</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s">&quot;bool&quot;</span><span class="p">:</span>
                            <span class="n">ddInputWidget</span> <span class="o">=</span> <span class="n">DdCheckBox</span><span class="p">(</span><span class="n">anAttribute</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">anAttribute</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s">&quot;date&quot;</span><span class="p">:</span>
                            <span class="n">ddInputWidget</span> <span class="o">=</span> <span class="n">DdDateEdit</span><span class="p">(</span><span class="n">anAttribute</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">ddInputWidget</span> <span class="o">=</span> <span class="n">DdLineEdit</span><span class="p">(</span><span class="n">anAttribute</span><span class="p">)</span>

            <span class="n">ddFormWidget</span><span class="o">.</span><span class="n">addInputWidget</span><span class="p">(</span><span class="n">ddInputWidget</span><span class="p">)</span>

        <span class="n">ddForms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ddFormWidget</span><span class="p">)</span>

        <span class="c">#QtGui.QMessageBox.information(None, &quot;attributes for&quot;,  thisTable.tableName + &quot;: \n&quot; + msg)</span>

        <span class="k">if</span> <span class="n">showParents</span><span class="p">:</span>
            <span class="c"># do not show this table in the parent&#39;s form</span>
            <span class="n">skip</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thisTable</span><span class="o">.</span><span class="n">tableName</span><span class="p">)</span>
            <span class="c"># go recursivly into thisTable&#39;s parents</span>
            <span class="k">for</span> <span class="n">aParent</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">getParents</span><span class="p">(</span><span class="n">thisTable</span><span class="p">,</span>  <span class="n">db</span><span class="p">):</span>
                <span class="n">parentForms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__createForms</span><span class="p">(</span><span class="n">aParent</span><span class="p">,</span>  <span class="n">db</span><span class="p">,</span>  <span class="n">skip</span><span class="p">,</span>  <span class="n">labels</span><span class="p">,</span>  <span class="n">fieldOrder</span><span class="p">,</span>  <span class="n">showParents</span><span class="p">,</span>  <span class="bp">False</span><span class="p">)</span>
                <span class="n">ddForms</span> <span class="o">=</span> <span class="n">ddForms</span> <span class="o">+</span> <span class="n">parentForms</span>

        <span class="k">return</span> <span class="n">ddForms</span>

<div class="viewcode-block" id="DataDrivenUi.createUi"><a class="viewcode-back" href="../autodoc.html#ddui.DataDrivenUi.createUi">[docs]</a>    <span class="k">def</span> <span class="nf">createUi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">thisTable</span><span class="p">,</span>  <span class="n">db</span><span class="p">,</span>  <span class="n">skip</span> <span class="o">=</span> <span class="p">[],</span>  <span class="n">labels</span> <span class="o">=</span> <span class="p">{},</span>  <span class="n">fieldOrder</span> <span class="o">=</span> <span class="p">[],</span>  <span class="n">showParents</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>  <span class="n">showChildren</span> <span class="o">=</span> <span class="bp">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;creates a default ui for this table (DdTable instance)</span>
<span class="sd">        skip is an array with field names to not show</span>
<span class="sd">        labels is a dict with entries: &quot;fieldname&quot;: &quot;label&quot;</span>
<span class="sd">        fieldOrder is an array containing the field names in the order they should be shown&#39;&#39;&#39;</span>

        <span class="n">ui</span> <span class="o">=</span> <span class="n">DdDialogWidget</span><span class="p">()</span>
        <span class="n">forms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__createForms</span><span class="p">(</span><span class="n">thisTable</span><span class="p">,</span>  <span class="n">db</span><span class="p">,</span>  <span class="n">skip</span><span class="p">,</span>  <span class="n">labels</span><span class="p">,</span>  <span class="n">fieldOrder</span><span class="p">,</span>  <span class="n">showParents</span><span class="p">,</span>  <span class="n">showChildren</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ddFormWidget</span> <span class="ow">in</span> <span class="n">forms</span><span class="p">:</span>
            <span class="n">ui</span><span class="o">.</span><span class="n">addFormWidget</span><span class="p">(</span><span class="n">ddFormWidget</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ui</span>
</div>
<div class="viewcode-block" id="DataDrivenUi.getParent"><a class="viewcode-back" href="../autodoc.html#ddui.DataDrivenUi.getParent">[docs]</a>    <span class="k">def</span> <span class="nf">getParent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">thisTable</span><span class="p">,</span>  <span class="n">db</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; deprecated&#39;&#39;&#39;</span>
        <span class="c">#Problem: eine Tabelle kann mehrere Eltern haben</span>

        <span class="n">query</span> <span class="o">=</span> <span class="n">QtSql</span><span class="o">.</span><span class="n">QSqlQuery</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
        <span class="n">sQuery</span> <span class="o">=</span> <span class="s">&quot;SELECT c.oid, n.nspname, c.relname </span><span class="se">\</span>
<span class="s">        FROM pg_inherits i </span><span class="se">\</span>
<span class="s">        JOIN pg_class c ON i.inhparent = c.oid </span><span class="se">\</span>
<span class="s">        JOIN pg_namespace n ON c.relnamespace = n.oid </span><span class="se">\</span>
<span class="s">        WHERE i.inhrelid = :oid&quot;</span>
        <span class="n">query</span><span class="o">.</span><span class="n">prepare</span><span class="p">(</span><span class="n">sQuery</span><span class="p">)</span>
        <span class="n">query</span><span class="o">.</span><span class="n">bindValue</span><span class="p">(</span><span class="s">&quot;:oid&quot;</span><span class="p">,</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QVariant</span><span class="p">(</span><span class="n">thisTable</span><span class="o">.</span><span class="n">oid</span><span class="p">))</span>
        <span class="n">query</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span>

        <span class="n">parentTable</span> <span class="o">=</span> <span class="n">DdTable</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">isActive</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">query</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">while</span> <span class="n">query</span><span class="o">.</span><span class="n">next</span><span class="p">():</span>
                    <span class="n">oid</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">toInt</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">schema</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">toString</span><span class="p">()</span>
                    <span class="n">table</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">toString</span><span class="p">()</span>
                    <span class="n">parentTable</span><span class="o">.</span><span class="n">oid</span> <span class="o">=</span> <span class="n">oid</span>
                    <span class="n">parentTable</span><span class="o">.</span><span class="n">schemaName</span> <span class="o">=</span> <span class="n">schema</span>
                    <span class="n">parentTable</span><span class="o">.</span><span class="n">tableName</span> <span class="o">=</span> <span class="n">table</span>
                    <span class="k">break</span>
                <span class="n">query</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">DbError</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">parentTable</span>
</div>
<div class="viewcode-block" id="DataDrivenUi.getParents"><a class="viewcode-back" href="../autodoc.html#ddui.DataDrivenUi.getParents">[docs]</a>    <span class="k">def</span> <span class="nf">getParents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">thisTable</span><span class="p">,</span>  <span class="n">db</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; query the DB to get a table&#39;s parents if any</span>
<span class="sd">        A table has a parent if its primary key is defined on one field only and is at the same time</span>
<span class="sd">        a foreign key to another table&#39;s primary key. Thus there is a 1:1</span>
<span class="sd">        relationship between the two.&#39;&#39;&#39;</span>

        <span class="n">query</span> <span class="o">=</span> <span class="n">QtSql</span><span class="o">.</span><span class="n">QSqlQuery</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
        <span class="n">sQuery</span> <span class="o">=</span> <span class="s">&quot;SELECT </span><span class="se">\</span>
<span class="s">               c.oid, ns.nspname, c.relname, COALESCE(d.description,&#39;&#39;) </span><span class="se">\</span>
<span class="s">            FROM pg_attribute att </span><span class="se">\</span>
<span class="s">                JOIN (SELECT * FROM pg_constraint WHERE contype = &#39;f&#39;) fcon ON att.attrelid = fcon.conrelid AND att.attnum = ANY (fcon.conkey) </span><span class="se">\</span>
<span class="s">                JOIN (SELECT * FROM pg_constraint WHERE contype = &#39;p&#39;) pcon ON att.attrelid = pcon.conrelid AND att.attnum = ANY (pcon.conkey) </span><span class="se">\</span>
<span class="s">                JOIN pg_class c ON fcon.confrelid = c.oid </span><span class="se">\</span>
<span class="s">                JOIN pg_namespace ns ON c.relnamespace = ns.oid </span><span class="se">\</span>
<span class="s">                LEFT JOIN (SELECT * FROM pg_description WHERE objsubid = 0) d ON c.oid = d.objoid </span><span class="se">\</span>
<span class="s">            WHERE att.attnum &gt; 0 </span><span class="se">\</span>
<span class="s">                AND att.attisdropped = false </span><span class="se">\</span>
<span class="s">                AND att.attrelid = :oid </span><span class="se">\</span>
<span class="s">                AND array_length(pcon.conkey, 1) = 1&quot;</span>
        <span class="c"># AND array_length(pcon.conkey, 1) = 1:</span>
        <span class="c"># if we have a combined PK we are in a n-to-m relational table</span>
        <span class="c"># pg_description.objsubid = 0 for description on tables</span>
        <span class="n">query</span><span class="o">.</span><span class="n">prepare</span><span class="p">(</span><span class="n">sQuery</span><span class="p">)</span>
        <span class="n">query</span><span class="o">.</span><span class="n">bindValue</span><span class="p">(</span><span class="s">&quot;:oid&quot;</span><span class="p">,</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QVariant</span><span class="p">(</span><span class="n">thisTable</span><span class="o">.</span><span class="n">oid</span><span class="p">))</span>
        <span class="n">query</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span>

        <span class="n">parents</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">isActive</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">query</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">while</span> <span class="n">query</span><span class="o">.</span><span class="n">next</span><span class="p">():</span>
                    <span class="n">oid</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">toInt</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">schema</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">toString</span><span class="p">()</span>
                    <span class="n">table</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">toString</span><span class="p">()</span>
                    <span class="n">comment</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">toString</span><span class="p">()</span>
                    <span class="n">parentTable</span> <span class="o">=</span> <span class="n">DdTable</span><span class="p">(</span><span class="n">oid</span><span class="p">,</span>  <span class="n">schema</span><span class="p">,</span>  <span class="n">table</span><span class="p">,</span>  <span class="n">comment</span><span class="p">)</span>
                    <span class="n">parents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parentTable</span><span class="p">)</span>

                <span class="n">query</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">DbError</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

        <span class="c">#myParents = &quot;myParents:&quot;</span>
        <span class="c">#for aParent in parents:</span>
        <span class="c">#    myParents = myParents + &quot; &quot; + aParent.tableName</span>

        <span class="c">#QtGui.QMessageBox.information(None, &quot;getParents&quot;,  &quot;called with &quot; + thisTable.tableName + &quot;\n&quot; + myParents)</span>

        <span class="k">return</span> <span class="n">parents</span>
</div>
<div class="viewcode-block" id="DataDrivenUi.getN2mAttributes"><a class="viewcode-back" href="../autodoc.html#ddui.DataDrivenUi.getN2mAttributes">[docs]</a>    <span class="k">def</span> <span class="nf">getN2mAttributes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">db</span><span class="p">,</span>  <span class="n">thisTable</span><span class="p">,</span>  <span class="n">attName</span><span class="p">,</span>  <span class="n">attNum</span><span class="p">,</span>  <span class="n">labels</span><span class="p">,</span>  <span class="n">showChildren</span><span class="p">):</span>
        <span class="c"># find those tables (n2mtable) where our pk is a fk</span>
        <span class="c">#QtGui.QMessageBox.information(None, &quot;Debug&quot;, &quot;getN2mAttributes:&quot; + thisTable.tableName)</span>
        <span class="n">n2mAttributes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">pkQuery</span> <span class="o">=</span> <span class="n">QtSql</span><span class="o">.</span><span class="n">QSqlQuery</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
        <span class="n">sPkQuery</span> <span class="o">=</span> <span class="s">&quot;SELECT array_length(pk.conkey, 1), att.attname, att.attnum, c.oid as table_oid,n.nspname,c.relname, f.numfields, COALESCE(d.description,&#39;&#39;) as comment, COALESCE(inpk.in,0) as inpk </span><span class="se">\</span>
<span class="s">                FROM pg_attribute att </span><span class="se">\</span>
<span class="s">                JOIN (SELECT * FROM pg_constraint WHERE contype = &#39;f&#39;) fk ON att.attrelid = fk.conrelid AND att.attnum = ANY (fk.conkey) </span><span class="se">\</span>
<span class="s">                JOIN (SELECT * FROM pg_constraint WHERE contype = &#39;p&#39;) pk ON pk.conrelid = fk.conrelid </span><span class="se">\</span>
<span class="s">                LEFT JOIN (SELECT 1 AS in, conrelid, conkey FROM pg_constraint where contype = &#39;p&#39;) inpk ON inpk.conrelid = fk.conrelid AND att.attnum = ANY (inpk.conkey) </span><span class="se">\</span>
<span class="s">                JOIN pg_class c ON fk.conrelid = c.oid </span><span class="se">\</span>
<span class="s">                JOIN pg_namespace n ON c.relnamespace = n.oid </span><span class="se">\</span>
<span class="s">                LEFT JOIN pg_description d ON c.oid = d.objoid AND 0 = d.objsubid </span><span class="se">\</span>
<span class="s">                JOIN(SELECT attrelid, count(attrelid) as numfields </span><span class="se">\</span>
<span class="s">                     FROM pg_attribute </span><span class="se">\</span>
<span class="s">                     WHERE attnum &gt; 0 </span><span class="se">\</span>
<span class="s">                        AND attisdropped = false </span><span class="se">\</span>
<span class="s">                     GROUP BY attrelid) f ON c.oid = f.attrelid </span><span class="se">\</span>
<span class="s">                WHERE fk.confrelid = :oid </span><span class="se">\</span>
<span class="s">                    AND :attNum = ANY(fk.confkey) &quot;</span>
                    <span class="c">#  0 = d.objsubid: comment on table only, not on its columns</span>
        <span class="n">pkQuery</span><span class="o">.</span><span class="n">prepare</span><span class="p">(</span><span class="n">sPkQuery</span><span class="p">)</span>
        <span class="c">#QtGui.QMessageBox.information(None, str(attNum), str(thisTable.oid))</span>
        <span class="n">pkQuery</span><span class="o">.</span><span class="n">bindValue</span><span class="p">(</span><span class="s">&quot;:oid&quot;</span><span class="p">,</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QVariant</span><span class="p">(</span><span class="n">thisTable</span><span class="o">.</span><span class="n">oid</span><span class="p">))</span>
        <span class="n">pkQuery</span><span class="o">.</span><span class="n">bindValue</span><span class="p">(</span><span class="s">&quot;:attNum&quot;</span><span class="p">,</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QVariant</span><span class="p">(</span><span class="n">attNum</span><span class="p">))</span>
        <span class="n">pkQuery</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">pkQuery</span><span class="o">.</span><span class="n">isActive</span><span class="p">():</span>
            <span class="k">while</span> <span class="n">pkQuery</span><span class="o">.</span><span class="n">next</span><span class="p">():</span>
                <span class="n">numPkFields</span> <span class="o">=</span> <span class="n">pkQuery</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">toInt</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">relationFeatureIdField</span> <span class="o">=</span> <span class="n">pkQuery</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">toString</span><span class="p">()</span>
                <span class="n">fkAttNum</span> <span class="o">=</span> <span class="n">pkQuery</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">toString</span><span class="p">()</span> <span class="c">#is the attribute number in n2mtable</span>
                <span class="n">relationOid</span> <span class="o">=</span> <span class="n">pkQuery</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">toString</span><span class="p">()</span>
                <span class="n">relationSchema</span> <span class="o">=</span> <span class="n">pkQuery</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">toString</span><span class="p">()</span>
                <span class="n">relationTable</span> <span class="o">=</span> <span class="n">pkQuery</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">toString</span><span class="p">()</span>
                <span class="n">numFields</span> <span class="o">=</span> <span class="n">pkQuery</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">toInt</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">relationComment</span> <span class="o">=</span> <span class="n">pkQuery</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span><span class="o">.</span><span class="n">toString</span><span class="p">()</span>
                <span class="n">inPk</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">pkQuery</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="o">.</span><span class="n">toInt</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">ddRelationTable</span> <span class="o">=</span> <span class="n">DdTable</span><span class="p">(</span><span class="n">relationOid</span><span class="p">,</span>  <span class="n">relationSchema</span><span class="p">,</span>  <span class="n">relationTable</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">inPk</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">numPkFields</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>

                        <span class="k">if</span> <span class="n">showChildren</span><span class="p">:</span>
                            <span class="c"># show 1:1 related tables, too</span>
                            <span class="n">subType</span> <span class="o">=</span> <span class="s">&quot;table&quot;</span>
                            <span class="n">maxRows</span> <span class="o">=</span> <span class="mi">1</span>
                            <span class="n">showParents</span> <span class="o">=</span> <span class="bp">True</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">continue</span>
                    <span class="k">elif</span> <span class="n">numPkFields</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">numFields</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="c"># get the related table i.e. the table where the other FK field is the PK</span>
                            <span class="n">relatedQuery</span> <span class="o">=</span> <span class="n">QtSql</span><span class="o">.</span><span class="n">QSqlQuery</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
                            <span class="n">sRelatedQuery</span> <span class="o">=</span> <span class="s">&quot;SELECT c.oid, n.nspname, c.relname, att.attname </span><span class="se">\</span>
<span class="s">                                FROM pg_constraint con </span><span class="se">\</span>
<span class="s">                                    JOIN pg_class c ON con.confrelid = c.oid </span><span class="se">\</span>
<span class="s">                                    JOIN pg_namespace n ON c.relnamespace = n.oid </span><span class="se">\</span>
<span class="s">                                    JOIN (</span><span class="se">\</span>
<span class="s">                                        SELECT * </span><span class="se">\</span>
<span class="s">                                        FROM pg_attribute </span><span class="se">\</span>
<span class="s">                                        WHERE attnum &gt; 0 </span><span class="se">\</span>
<span class="s">                                            AND attisdropped = false </span><span class="se">\</span>
<span class="s">                                            AND attnum != :attNum1 </span><span class="se">\</span>
<span class="s">                                        ) att ON con.conrelid = att.attrelid </span><span class="se">\</span>
<span class="s">                                WHERE conrelid = :relationOid </span><span class="se">\</span>
<span class="s">                                    AND contype = &#39;f&#39; </span><span class="se">\</span>
<span class="s">                                    AND :attNum2 != ANY(conkey)&quot;</span>
                            <span class="c"># we do not want the table where we came from in the results, therefore :attNum != ANY(confkey)</span>
                            <span class="c"># JOIN pg_class c ON con.confrelid = c.oid -- referenced table</span>
                            <span class="c"># WHERE conrelid = :relationOid -- table this constraint is on</span>
                            <span class="c"># AND contype = &#39;f&#39; -- foreign key constraint</span>
                            <span class="c"># AND :attNum2 != ANY(conkey) -- list of constrained columns</span>
                            <span class="n">relatedQuery</span><span class="o">.</span><span class="n">prepare</span><span class="p">(</span><span class="n">sRelatedQuery</span><span class="p">)</span>
                            <span class="n">relatedQuery</span><span class="o">.</span><span class="n">bindValue</span><span class="p">(</span><span class="s">&quot;:relationOid&quot;</span><span class="p">,</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QVariant</span><span class="p">(</span><span class="n">relationOid</span><span class="p">))</span>
                            <span class="n">relatedQuery</span><span class="o">.</span><span class="n">bindValue</span><span class="p">(</span><span class="s">&quot;:attNum1&quot;</span><span class="p">,</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QVariant</span><span class="p">(</span><span class="n">fkAttNum</span><span class="p">))</span>
                            <span class="n">relatedQuery</span><span class="o">.</span><span class="n">bindValue</span><span class="p">(</span><span class="s">&quot;:attNum2&quot;</span><span class="p">,</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QVariant</span><span class="p">(</span><span class="n">fkAttNum</span><span class="p">))</span>
                            <span class="n">relatedQuery</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span>

                            <span class="k">if</span> <span class="n">relatedQuery</span><span class="o">.</span><span class="n">isActive</span><span class="p">():</span>

                                <span class="k">if</span> <span class="n">relatedQuery</span><span class="o">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c">#no relatedTable but a Table with two PK columns</span>
                                    <span class="n">subType</span> <span class="o">=</span> <span class="s">&quot;table&quot;</span>
                                    <span class="n">maxRows</span> <span class="o">=</span> <span class="mi">1</span>
                                    <span class="n">showParents</span> <span class="o">=</span> <span class="bp">False</span>
                                    <span class="c">#QtGui.QMessageBox.information(None, &quot;relatedQuery.size()&quot;, str(relatedQuery.size()))</span>
                                <span class="k">elif</span> <span class="n">relatedQuery</span><span class="o">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                    <span class="k">while</span> <span class="n">relatedQuery</span><span class="o">.</span><span class="n">next</span><span class="p">():</span>
                                        <span class="n">relatedOid</span> <span class="o">=</span> <span class="n">relatedQuery</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">toInt</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                                        <span class="n">relatedSchema</span> <span class="o">=</span> <span class="n">relatedQuery</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">toString</span><span class="p">()</span>
                                        <span class="n">relatedTable</span> <span class="o">=</span> <span class="n">relatedQuery</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">toString</span><span class="p">()</span>
                                        <span class="n">relationRelatedIdField</span> <span class="o">=</span> <span class="n">relatedQuery</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">toString</span><span class="p">()</span>
                                        <span class="n">ddRelatedTable</span> <span class="o">=</span> <span class="n">DdTable</span><span class="p">(</span><span class="n">relatedOid</span><span class="p">,</span>  <span class="n">relatedSchema</span><span class="p">,</span>  <span class="n">relatedTable</span><span class="p">)</span>
                                    <span class="n">relatedQuery</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>

                                    <span class="n">relatedFieldsQuery</span> <span class="o">=</span> <span class="n">QtSql</span><span class="o">.</span><span class="n">QSqlQuery</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
                                    <span class="n">relatedFieldsQuery</span><span class="o">.</span><span class="n">prepare</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__attributeQuery</span><span class="p">(</span><span class="s">&quot;att.attnum&quot;</span><span class="p">))</span>
                                    <span class="n">relatedFieldsQuery</span><span class="o">.</span><span class="n">bindValue</span><span class="p">(</span><span class="s">&quot;:oid&quot;</span><span class="p">,</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QVariant</span><span class="p">(</span><span class="n">relatedOid</span><span class="p">))</span>
                                    <span class="n">relatedFieldsQuery</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span>

                                    <span class="k">if</span> <span class="n">relatedFieldsQuery</span><span class="o">.</span><span class="n">isActive</span><span class="p">():</span>
                                        <span class="k">if</span> <span class="n">relatedFieldsQuery</span><span class="o">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                                            <span class="n">subType</span> <span class="o">=</span> <span class="s">&quot;list&quot;</span>
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="n">subType</span> <span class="o">=</span> <span class="s">&quot;tree&quot;</span>
                                            <span class="c">#QtGui.QMessageBox.information(None, &quot;Debug&quot;, &quot;tree: &quot; + relatedSchema + &quot;.&quot; + relatedTable + &quot;.&quot; + relationRelatedIdField)</span>

                                        <span class="n">relatedIdField</span> <span class="o">=</span> <span class="bp">None</span>
                                        <span class="n">relatedDisplayCandidate</span> <span class="o">=</span> <span class="bp">None</span>
                                        <span class="n">relatedDisplayField</span> <span class="o">=</span> <span class="bp">None</span>
                                        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>

                                        <span class="n">fieldList</span> <span class="o">=</span> <span class="p">[]</span>

                                        <span class="k">while</span> <span class="n">relatedFieldsQuery</span><span class="o">.</span><span class="n">next</span><span class="p">():</span>
                                            <span class="n">relatedAttName</span> <span class="o">=</span> <span class="n">relatedFieldsQuery</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">toString</span><span class="p">()</span>
                                            <span class="n">relatedAttNum</span> <span class="o">=</span> <span class="n">relatedFieldsQuery</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">toInt</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                                            <span class="n">relatedAttNotNull</span> <span class="o">=</span> <span class="n">relatedFieldsQuery</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">toBool</span><span class="p">()</span>
                                            <span class="n">relatedAttHasDefault</span> <span class="o">=</span> <span class="n">relatedFieldsQuery</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">toBool</span><span class="p">()</span>
                                            <span class="n">relatedAttIsChild</span> <span class="o">=</span> <span class="n">relatedFieldsQuery</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">toBool</span><span class="p">()</span>
                                            <span class="n">relatedAttLength</span> <span class="o">=</span> <span class="n">relatedFieldsQuery</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">toInt</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                                            <span class="n">relatedAttTyp</span> <span class="o">=</span> <span class="n">relatedFieldsQuery</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">toString</span><span class="p">()</span>
                                            <span class="n">relatedAttComment</span> <span class="o">=</span> <span class="n">relatedFieldsQuery</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span><span class="o">.</span><span class="n">toString</span><span class="p">()</span>
                                            <span class="n">relatedAttDefault</span> <span class="o">=</span> <span class="n">relatedFieldsQuery</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="o">.</span><span class="n">toString</span><span class="p">()</span>
                                            <span class="n">relatedAttConstraint</span> <span class="o">=</span> <span class="n">relatedFieldsQuery</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span><span class="o">.</span><span class="n">toString</span><span class="p">()</span>

                                            <span class="k">if</span> <span class="n">relatedAttConstraint</span> <span class="o">==</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QString</span><span class="p">(</span><span class="s">&quot;p&quot;</span><span class="p">):</span> <span class="c"># PK of the related table</span>
                                                <span class="n">relatedIdField</span> <span class="o">=</span> <span class="n">relatedAttName</span>

                                            <span class="k">if</span> <span class="n">relatedAttTyp</span> <span class="o">==</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QString</span><span class="p">(</span><span class="s">&quot;varchar&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">relatedAttTyp</span> <span class="o">==</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QString</span><span class="p">(</span><span class="s">&quot;char&quot;</span><span class="p">):</span>

                                                <span class="k">if</span> <span class="n">relatedAttNotNull</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">relatedDisplayField</span><span class="p">:</span> <span class="c"># we use the first one</span>
                                                    <span class="n">relatedDisplayField</span> <span class="o">=</span> <span class="n">relatedAttName</span>

                                                <span class="c">#we display only char attributes</span>
                                                <span class="n">fieldList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">relatedAttName</span><span class="p">)</span>

                                        <span class="n">relatedFieldsQuery</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>

                                        <span class="k">if</span> <span class="ow">not</span> <span class="n">relatedDisplayCandidate</span><span class="p">:</span> <span class="c"># there was no string field</span>
                                            <span class="n">relatedDisplayCandidate</span> <span class="o">=</span> <span class="n">relatedIdField</span>

                                        <span class="k">if</span> <span class="ow">not</span> <span class="n">relatedDisplayField</span><span class="p">:</span> <span class="c"># there was no notNull string field</span>
                                            <span class="n">relatedDisplayField</span> <span class="o">=</span> <span class="n">relatedDisplayCandidate</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">DbError</span><span class="p">(</span><span class="n">relatedFieldsQuery</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">relatedQuery</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
                                    <span class="k">continue</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">DbError</span><span class="p">(</span><span class="n">relatedQuery</span><span class="p">)</span>

                        <span class="k">elif</span> <span class="n">numFields</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">subType</span> <span class="o">=</span> <span class="s">&quot;table&quot;</span>
                            <span class="n">maxRows</span> <span class="o">=</span> <span class="bp">None</span>
                            <span class="n">showParents</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">else</span><span class="p">:</span> <span class="c"># 1:n relation</span>
                    <span class="n">subType</span> <span class="o">=</span> <span class="s">&quot;table&quot;</span>
                    <span class="n">maxRows</span> <span class="o">=</span> <span class="bp">None</span>
                    <span class="n">showParents</span> <span class="o">=</span> <span class="bp">False</span>
                    
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">attLabel</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">relationTable</span><span class="p">)]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">attLabel</span> <span class="o">=</span> <span class="bp">None</span>

                <span class="k">if</span> <span class="n">subType</span> <span class="o">==</span> <span class="s">&quot;table&quot;</span><span class="p">:</span>
                    <span class="n">attributes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getAttributes</span><span class="p">(</span><span class="n">ddRelationTable</span><span class="p">,</span>  <span class="n">db</span><span class="p">,</span>  <span class="p">{})</span>
                    <span class="n">ddAtt</span> <span class="o">=</span> <span class="n">DdTableAttribute</span><span class="p">(</span><span class="n">ddRelationTable</span><span class="p">,</span>  <span class="n">relationComment</span><span class="p">,</span>  <span class="n">attLabel</span><span class="p">,</span> <span class="n">relationFeatureIdField</span><span class="p">,</span>  <span class="n">attributes</span><span class="p">,</span>  <span class="n">maxRows</span><span class="p">,</span>  <span class="n">showParents</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ddAtt</span> <span class="o">=</span> <span class="n">DdN2mAttribute</span><span class="p">(</span><span class="n">ddRelationTable</span><span class="p">,</span>  <span class="n">ddRelatedTable</span><span class="p">,</span>  \
                                       <span class="n">subType</span><span class="p">,</span>  <span class="n">relationComment</span><span class="p">,</span>  <span class="n">attLabel</span><span class="p">,</span>  \
                                       <span class="n">relationFeatureIdField</span><span class="p">,</span> <span class="n">relationRelatedIdField</span><span class="p">,</span>  <span class="n">relatedIdField</span><span class="p">,</span>  <span class="n">relatedDisplayField</span><span class="p">,</span>  <span class="n">fieldList</span><span class="p">)</span>

                <span class="n">n2mAttributes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ddAtt</span><span class="p">)</span>
            <span class="n">pkQuery</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">DbError</span><span class="p">(</span><span class="n">pkQuery</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">n2mAttributes</span>
</div>
<div class="viewcode-block" id="DataDrivenUi.getAttributes"><a class="viewcode-back" href="../autodoc.html#ddui.DataDrivenUi.getAttributes">[docs]</a>    <span class="k">def</span> <span class="nf">getAttributes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">thisTable</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span>  <span class="n">labels</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; query the DB and create DdAttributes&#39;&#39;&#39;</span>
        <span class="n">ddAttributes</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">query</span> <span class="o">=</span> <span class="n">QtSql</span><span class="o">.</span><span class="n">QSqlQuery</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
        <span class="n">sQuery</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__attributeQuery</span><span class="p">(</span><span class="s">&quot;att.attnum&quot;</span><span class="p">)</span>

        <span class="n">query</span><span class="o">.</span><span class="n">prepare</span><span class="p">(</span><span class="n">sQuery</span><span class="p">)</span>
        <span class="n">query</span><span class="o">.</span><span class="n">bindValue</span><span class="p">(</span><span class="s">&quot;:oid&quot;</span><span class="p">,</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QVariant</span><span class="p">(</span><span class="n">thisTable</span><span class="o">.</span><span class="n">oid</span><span class="p">))</span>
        <span class="n">query</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span>

        <span class="n">retValue</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">isActive</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">query</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">foreignKeys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getForeignKeys</span><span class="p">(</span><span class="n">thisTable</span><span class="p">,</span>  <span class="n">db</span><span class="p">)</span>

                <span class="k">while</span> <span class="n">query</span><span class="o">.</span><span class="n">next</span><span class="p">():</span>
                    <span class="n">attName</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">toString</span><span class="p">()</span>
                    <span class="n">attNum</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">toInt</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">attNotNull</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">toBool</span><span class="p">()</span>
                    <span class="n">attHasDefault</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">toBool</span><span class="p">()</span>
                    <span class="n">attIsChild</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">toBool</span><span class="p">()</span>
                    <span class="n">attLength</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">toInt</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">attTyp</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">toString</span><span class="p">()</span>
                    <span class="n">attComment</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span><span class="o">.</span><span class="n">toString</span><span class="p">()</span>
                    <span class="n">attDefault</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="o">.</span><span class="n">toString</span><span class="p">()</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">isSupportedType</span><span class="p">(</span><span class="n">attTyp</span><span class="p">):</span>
                        <span class="k">continue</span>

                    <span class="n">attConstraint</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span><span class="o">.</span><span class="n">toString</span><span class="p">()</span>
                    <span class="n">constrainedAttNums</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">toString</span><span class="p">()</span>
                    <span class="n">isPK</span> <span class="o">=</span> <span class="n">attConstraint</span> <span class="o">==</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QString</span><span class="p">(</span><span class="s">&quot;p&quot;</span><span class="p">)</span> <span class="c"># PrimaryKey</span>

                    <span class="k">if</span> <span class="n">isPK</span><span class="p">:</span>
                        <span class="n">constrainedAttNums</span> <span class="o">=</span> <span class="n">constrainedAttNums</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;{&quot;</span><span class="p">,</span>  <span class="s">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;}&quot;</span><span class="p">,</span>  <span class="s">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">constrainedAttNums</span> <span class="o">=</span> <span class="p">[]</span>

                    <span class="k">if</span> <span class="n">isPK</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">constrainedAttNums</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="c"># if table has a single PK we do not care if it is a FK, too because we</span>
                        <span class="c"># do not treat a parent in a 1:1 relation as lookup table</span>
                        <span class="n">normalAtt</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span> <span class="c"># is this attribute a FK</span>
                            <span class="n">fk</span> <span class="o">=</span> <span class="n">foreignKeys</span><span class="p">[</span><span class="n">attNum</span><span class="p">]</span>

                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">attLabel</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">attName</span><span class="p">)]</span>
                            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                                <span class="n">attLabel</span> <span class="o">=</span> <span class="n">attName</span> <span class="o">+</span> <span class="s">&quot; (&quot;</span> <span class="o">+</span> <span class="n">fk</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot;)&quot;</span>

                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">fkComment</span> <span class="o">=</span> <span class="n">fk</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                                <span class="c">#QtGui.QMessageBox.information(None, &quot;&quot;,  &quot;no fkComment for &quot; + attName)</span>
                                <span class="n">fkComment</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QString</span><span class="p">()</span>

                            <span class="k">if</span> <span class="n">attComment</span><span class="o">.</span><span class="n">isEmpty</span><span class="p">():</span>
                                <span class="n">attComment</span> <span class="o">=</span> <span class="n">fkComment</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">fkComment</span><span class="o">.</span><span class="n">isEmpty</span><span class="p">():</span>
                                    <span class="n">attComment</span> <span class="o">=</span> <span class="n">attComment</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">(&quot;</span> <span class="o">+</span> <span class="n">fkComment</span> <span class="o">+</span> <span class="s">&quot;)&quot;</span>

                            <span class="n">ddAtt</span> <span class="o">=</span> <span class="n">DdFkLayerAttribute</span><span class="p">(</span><span class="n">thisTable</span><span class="p">,</span>  <span class="n">attTyp</span><span class="p">,</span>  <span class="n">attNotNull</span><span class="p">,</span>  <span class="n">attName</span><span class="p">,</span>  <span class="n">attComment</span><span class="p">,</span>  <span class="n">attNum</span><span class="p">,</span>  <span class="n">isPK</span><span class="p">,</span> <span class="n">attDefault</span><span class="p">,</span>  <span class="n">attHasDefault</span><span class="p">,</span>  <span class="n">fk</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>  <span class="n">attLabel</span><span class="p">)</span>
                            <span class="n">normalAtt</span> <span class="o">=</span> <span class="bp">False</span>
                        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                            <span class="c"># no fk defined</span>
                            <span class="n">normalAtt</span> <span class="o">=</span> <span class="bp">True</span>

                    <span class="k">if</span> <span class="n">normalAtt</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">attLabel</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">attName</span><span class="p">)]</span>
                        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                            <span class="n">attLabel</span> <span class="o">=</span> <span class="bp">None</span>

                        <span class="n">ddAtt</span> <span class="o">=</span> <span class="n">DdLayerAttribute</span><span class="p">(</span><span class="n">thisTable</span><span class="p">,</span>  <span class="n">attTyp</span><span class="p">,</span>  <span class="n">attNotNull</span><span class="p">,</span>  <span class="n">attName</span><span class="p">,</span>  <span class="n">attComment</span><span class="p">,</span>  <span class="n">attNum</span><span class="p">,</span>  <span class="n">isPK</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span>  <span class="n">attDefault</span><span class="p">,</span>  <span class="n">attHasDefault</span><span class="p">,</span>  <span class="n">attLength</span><span class="p">,</span>  <span class="n">attLabel</span><span class="p">)</span>

                    <span class="n">ddAttributes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ddAtt</span><span class="p">)</span>

                <span class="n">query</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">DbError</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ddAttributes</span>
</div>
<div class="viewcode-block" id="DataDrivenUi.isSupportedType"><a class="viewcode-back" href="../autodoc.html#ddui.DataDrivenUi.isSupportedType">[docs]</a>    <span class="k">def</span> <span class="nf">isSupportedType</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">typ</span><span class="p">):</span>
        <span class="n">supportedAttributeTypes</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;int2&quot;</span><span class="p">,</span> <span class="s">&quot;int4&quot;</span><span class="p">,</span>  <span class="s">&quot;int8&quot;</span><span class="p">,</span>  <span class="s">&quot;char&quot;</span><span class="p">,</span>  <span class="s">&quot;varchar&quot;</span><span class="p">,</span>  <span class="s">&quot;float4&quot;</span><span class="p">,</span> <span class="s">&quot;float8&quot;</span><span class="p">,</span>  <span class="s">&quot;text&quot;</span><span class="p">,</span>  <span class="s">&quot;bool&quot;</span><span class="p">,</span>  <span class="s">&quot;date&quot;</span><span class="p">]</span>
        <span class="n">supported</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">for</span> <span class="n">aTyp</span> <span class="ow">in</span> <span class="n">supportedAttributeTypes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">aTyp</span> <span class="o">==</span> <span class="n">typ</span><span class="p">:</span>
                <span class="n">supported</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">break</span>

        <span class="k">return</span> <span class="n">supported</span>
</div>
<div class="viewcode-block" id="DataDrivenUi.getForeignKeys"><a class="viewcode-back" href="../autodoc.html#ddui.DataDrivenUi.getForeignKeys">[docs]</a>    <span class="k">def</span> <span class="nf">getForeignKeys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">thisTable</span><span class="p">,</span> <span class="n">db</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;querys this table&#39;s foreign keys and returns a dict</span>
<span class="sd">        attnum: [QString: Type of the lookup field, QString: sql to query lookup values, QString: Name of the value field in the lookup table, QString: Comment on lookup table]&#39;&#39;&#39;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">QtSql</span><span class="o">.</span><span class="n">QSqlQuery</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
        <span class="n">sQuery</span> <span class="o">=</span> <span class="s">&quot;SELECT </span><span class="se">\</span>
<span class="s">                att.attnum, </span><span class="se">\</span>
<span class="s">                t.typname as typ, </span><span class="se">\</span>
<span class="s">                CAST(valatt.attnotnull as integer) as notnull, </span><span class="se">\</span>
<span class="s">                valatt.attname, </span><span class="se">\</span>
<span class="s">                (((((((&#39;SELECT &#39; || quote_ident(valatt.attname)) || &#39; as value, &#39;)  || quote_ident(refatt.attname)) || &#39; as key FROM &#39;) || quote_ident(ns.nspname)) || &#39;.&#39;) || quote_ident(c.relname)) || &#39;;&#39; AS sql_key, </span><span class="se">\</span>
<span class="s">                (((((((&#39;SELECT &#39; || quote_ident(refatt.attname)) || &#39; as value, &#39;)  || quote_ident(refatt.attname)) || &#39; as key FROM &#39;) || quote_ident(ns.nspname)) || &#39;.&#39;) || quote_ident(c.relname)) || &#39;;&#39; AS default_sql, </span><span class="se">\</span>
<span class="s">                COALESCE(d.description, &#39;&#39;) as comment, </span><span class="se">\</span>
<span class="s">                COALESCE(valcon.contype, &#39;x&#39;) as valcontype </span><span class="se">\</span>
<span class="s">            FROM pg_attribute att </span><span class="se">\</span>
<span class="s">                JOIN (SELECT * FROM pg_constraint WHERE contype = &#39;f&#39;) con ON att.attrelid = con.conrelid AND att.attnum = ANY (con.conkey) </span><span class="se">\</span>
<span class="s">                JOIN pg_class c ON con.confrelid = c.oid </span><span class="se">\</span>
<span class="s">                JOIN pg_namespace ns ON c.relnamespace = ns.oid </span><span class="se">\</span>
<span class="s">                JOIN pg_attribute refatt ON con.confrelid = refatt.attrelid AND con.confkey[1] = refatt.attnum </span><span class="se">\</span>
<span class="s">                JOIN pg_attribute valatt ON con.confrelid = valatt.attrelid </span><span class="se">\</span>
<span class="s">                LEFT JOIN pg_constraint valcon ON valatt.attrelid = valcon.conrelid AND valatt.attnum = ANY (valcon.conkey)</span><span class="se">\</span>
<span class="s">                JOIN pg_type t ON valatt.atttypid = t.oid </span><span class="se">\</span>
<span class="s">                LEFT JOIN pg_description d ON con.confrelid = d.objoid AND 0 = d.objsubid </span><span class="se">\</span>
<span class="s">            WHERE att.attnum &gt; 0 </span><span class="se">\</span>
<span class="s">                AND att.attisdropped = false </span><span class="se">\</span>
<span class="s">                AND valatt.attnum &gt; 0 </span><span class="se">\</span>
<span class="s">                AND valatt.attisdropped = false </span><span class="se">\</span>
<span class="s">                AND att.attrelid = :oid </span><span class="se">\</span>
<span class="s">            ORDER BY att.attnum, valatt.attnum&quot;</span>
        <span class="c"># Query returns all fields in the lookup table for each attnum</span>
        <span class="c"># JOIN valcon  in order to not display any fields that are FKs themsselves</span>
        <span class="c"># add &quot;AND valatt.attnum != con.confkey[1]&quot;  if you want to keep PKs out</span>
        <span class="n">query</span><span class="o">.</span><span class="n">prepare</span><span class="p">(</span><span class="n">sQuery</span><span class="p">)</span>
        <span class="n">query</span><span class="o">.</span><span class="n">bindValue</span><span class="p">(</span><span class="s">&quot;:oid&quot;</span><span class="p">,</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QVariant</span><span class="p">(</span><span class="n">thisTable</span><span class="o">.</span><span class="n">oid</span><span class="p">))</span>
        <span class="n">query</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span>

        <span class="n">foreignKeys</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">isActive</span><span class="p">():</span>
            <span class="k">while</span> <span class="n">query</span><span class="o">.</span><span class="n">next</span><span class="p">():</span>
                <span class="n">attNum</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">toInt</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">fieldType</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">toString</span><span class="p">()</span>
                <span class="n">notNull</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">toBool</span><span class="p">()</span>
                <span class="n">valAttName</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">toString</span><span class="p">()</span>
                <span class="n">keySql</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">toString</span><span class="p">()</span>
                <span class="n">defaultSql</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">toString</span><span class="p">()</span>
                <span class="n">comment</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">toString</span><span class="p">()</span>
                <span class="n">contype</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span><span class="o">.</span><span class="n">toString</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">contype</span> <span class="o">==</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QString</span><span class="p">(</span><span class="s">&quot;f&quot;</span><span class="p">):</span>
                    <span class="k">continue</span>

               <span class="c"># QtGui.QMessageBox.information(None, &quot;&quot;,  str(attNum) + &quot;: &quot; + fieldType + &quot; &quot; + valAttName + &quot; &quot; + keySql)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fk</span> <span class="o">=</span> <span class="n">foreignKeys</span><span class="p">[</span><span class="n">attNum</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">fk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QString</span><span class="p">(</span><span class="s">&quot;varchar&quot;</span><span class="p">):</span> <span class="c"># we do not already have a varchar field as value field</span>
                    <span class="c"># find a field with a suitable type</span>
                        <span class="k">if</span> <span class="n">notNull</span> <span class="ow">and</span> <span class="p">(</span><span class="n">fieldType</span> <span class="o">==</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QString</span><span class="p">(</span><span class="s">&quot;varchar&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">fieldType</span> <span class="o">==</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QString</span><span class="p">(</span><span class="s">&quot;char&quot;</span><span class="p">)):</span>
                            <span class="n">foreignKeys</span><span class="p">[</span><span class="n">attNum</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">fieldType</span><span class="p">,</span>  <span class="n">keySql</span><span class="p">,</span>  <span class="n">valAttName</span><span class="p">,</span>  <span class="n">comment</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">notNull</span> <span class="ow">and</span> <span class="p">(</span><span class="n">fieldType</span> <span class="o">==</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QString</span><span class="p">(</span><span class="s">&quot;varchar&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">fieldType</span> <span class="o">==</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QString</span><span class="p">(</span><span class="s">&quot;char&quot;</span><span class="p">)):</span>
                        <span class="n">foreignKeys</span><span class="p">[</span><span class="n">attNum</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">fieldType</span><span class="p">,</span>  <span class="n">keySql</span><span class="p">,</span>  <span class="n">valAttName</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span> <span class="c"># put the first in</span>
                        <span class="n">foreignKeys</span><span class="p">[</span><span class="n">attNum</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">fieldType</span><span class="p">,</span>  <span class="n">defaultSql</span><span class="p">,</span>  <span class="n">valAttName</span><span class="p">,</span>  <span class="n">comment</span><span class="p">]</span>

            <span class="n">query</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">DbError</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">foreignKeys</span>
</div>
    <span class="k">def</span> <span class="nf">__attributeQuery</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">order</span> <span class="o">=</span> <span class="s">&quot;lower(att.attname)&quot;</span><span class="p">):</span>
        <span class="n">sQuery</span> <span class="o">=</span> <span class="s">&quot;SELECT </span><span class="se">\</span>
<span class="s">        att.attname, </span><span class="se">\</span>
<span class="s">        att.attnum, </span><span class="se">\</span>
<span class="s">        CAST(att.attnotnull as integer) as notnull, </span><span class="se">\</span>
<span class="s">        CAST(att.atthasdef as integer) as hasdef, </span><span class="se">\</span>
<span class="s">        CASE att.attinhcount WHEN 0 THEN 0 ELSE 1 END as ischild, </span><span class="se">\</span>
<span class="s">        CASE att.attlen WHEN -1 THEN att.atttypmod -4 ELSE att.attlen END as length, </span><span class="se">\</span>
<span class="s">        t.typname as typ, </span><span class="se">\</span>
<span class="s">        COALESCE(d.description, &#39;&#39;) as comment, </span><span class="se">\</span>
<span class="s">        COALESCE(ad.adsrc, &#39;&#39;) as default, </span><span class="se">\</span>
<span class="s">        COALESCE(con.contype, &#39;&#39;) as contype, </span><span class="se">\</span>
<span class="s">        COALESCE(con.conkey, ARRAY[]::smallint[]) as constrained_columns </span><span class="se">\</span>
<span class="s">        FROM pg_attribute att </span><span class="se">\</span>
<span class="s">        JOIN pg_type t ON att.atttypid = t.oid </span><span class="se">\</span>
<span class="s">        LEFT JOIN pg_description d ON att.attrelid = d.objoid AND att.attnum = d.objsubid </span><span class="se">\</span>
<span class="s">        LEFT JOIN pg_attrdef ad ON att.attrelid = ad.adrelid AND att.attnum = ad.adnum </span><span class="se">\</span>
<span class="s">        LEFT JOIN (SELECT * FROM pg_constraint WHERE contype = </span><span class="se">\&#39;</span><span class="s">p</span><span class="se">\&#39;</span><span class="s">) con ON att.attrelid = con.conrelid AND att.attnum = ANY (con.conkey) </span><span class="se">\</span>
<span class="s">        WHERE att.attnum &gt; 0 </span><span class="se">\</span>
<span class="s">        AND att.attisdropped = false </span><span class="se">\</span>
<span class="s">        AND att.attrelid = :oid </span><span class="se">\</span>
<span class="s">        ORDER BY &quot;</span> <span class="o">+</span> <span class="n">order</span>
        <span class="c"># contype = \&#39;p\&#39;: only primary key constraints are of interest</span>
        <span class="c"># att.attnum &gt; 0 skip system columns</span>
        <span class="c"># att.attisdropped = false -- skip deleted columns</span>
        <span class="k">return</span> <span class="n">sQuery</span>
</div>
<div class="viewcode-block" id="DdWidget"><a class="viewcode-back" href="../autodoc.html#ddui.DdWidget">[docs]</a><span class="k">class</span> <span class="nc">DdWidget</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;abstract class&#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;&lt;ddui.DdWidget&gt;&quot;</span>

<div class="viewcode-block" id="DdWidget.checkInput"><a class="viewcode-back" href="../autodoc.html#ddui.DdWidget.checkInput">[docs]</a>    <span class="k">def</span> <span class="nf">checkInput</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
       <span class="k">return</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="DdWidget.setupUi"><a class="viewcode-back" href="../autodoc.html#ddui.DdWidget.setupUi">[docs]</a>    <span class="k">def</span> <span class="nf">setupUi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">parent</span><span class="p">,</span>  <span class="n">db</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&quot;Should have implemented setupUi&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="DdWidget.initialize"><a class="viewcode-back" href="../autodoc.html#ddui.DdWidget.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">layer</span><span class="p">,</span>  <span class="n">feature</span><span class="p">,</span>  <span class="n">db</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&quot;Should have implemented initialize&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="DdWidget.save"><a class="viewcode-back" href="../autodoc.html#ddui.DdWidget.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">layer</span><span class="p">,</span>  <span class="n">feature</span><span class="p">,</span>  <span class="n">db</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&quot;Should have implemented save&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="DdWidget.discard"><a class="viewcode-back" href="../autodoc.html#ddui.DdWidget.discard">[docs]</a>    <span class="k">def</span> <span class="nf">discard</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>
</div></div>
<div class="viewcode-block" id="DdDialogWidget"><a class="viewcode-back" href="../autodoc.html#ddui.DdDialogWidget">[docs]</a><span class="k">class</span> <span class="nc">DdDialogWidget</span><span class="p">(</span><span class="n">DdWidget</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">DdWidget</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forms</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;&lt;ddui.DdDialogWidget&gt;&quot;</span>

<div class="viewcode-block" id="DdDialogWidget.setupUi"><a class="viewcode-back" href="../autodoc.html#ddui.DdDialogWidget.setupUi">[docs]</a>    <span class="k">def</span> <span class="nf">setupUi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">DataDrivenInputMask</span><span class="p">,</span>  <span class="n">db</span><span class="p">):</span> <span class="c"># DataDrivenInputMask is a QDialog</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layout</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QVBoxLayout</span><span class="p">(</span><span class="n">DataDrivenInputMask</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">setObjectName</span><span class="p">(</span><span class="s">&quot;layout&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mainTab</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QTabWidget</span><span class="p">(</span><span class="n">DataDrivenInputMask</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mainTab</span><span class="o">.</span><span class="n">setObjectName</span><span class="p">(</span><span class="s">&quot;mainTab&quot;</span><span class="p">)</span>
        <span class="n">DataDrivenInputMask</span><span class="o">.</span><span class="n">setObjectName</span><span class="p">(</span><span class="s">&quot;DataDrivenInputMask&quot;</span><span class="p">)</span>
        <span class="n">DataDrivenInputMask</span><span class="o">.</span><span class="n">setWindowModality</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">ApplicationModal</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">forms</span><span class="p">)):</span>
            <span class="n">aTab</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mainTab</span><span class="p">)</span>
            <span class="n">aTab</span><span class="o">.</span><span class="n">setObjectName</span><span class="p">(</span><span class="s">&quot;tab&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="n">aForm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">aForm</span><span class="o">.</span><span class="n">hasToolBox</span><span class="p">:</span>
                <span class="n">tabLayout</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QVBoxLayout</span><span class="p">(</span><span class="n">aTab</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tabLayout</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QFormLayout</span><span class="p">(</span><span class="n">aTab</span><span class="p">)</span>

            <span class="n">tabLayout</span><span class="o">.</span><span class="n">setObjectName</span><span class="p">(</span><span class="s">&quot;tabLayout&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="n">aForm</span><span class="o">.</span><span class="n">setupUi</span><span class="p">(</span><span class="n">aTab</span><span class="p">,</span>  <span class="n">db</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">aForm</span><span class="o">.</span><span class="n">ddTable</span><span class="o">.</span><span class="n">title</span><span class="p">:</span>
                <span class="n">tabTitle</span> <span class="o">=</span> <span class="n">aForm</span><span class="o">.</span><span class="n">ddTable</span><span class="o">.</span><span class="n">title</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tabTitle</span> <span class="o">=</span> <span class="n">aForm</span><span class="o">.</span><span class="n">ddTable</span><span class="o">.</span><span class="n">tableName</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">mainTab</span><span class="o">.</span><span class="n">addTab</span><span class="p">(</span><span class="n">aTab</span><span class="p">,</span>  <span class="n">tabTitle</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">aForm</span><span class="o">.</span><span class="n">ddTable</span><span class="o">.</span><span class="n">comment</span><span class="o">.</span><span class="n">isEmpty</span><span class="p">():</span>
                <span class="n">aTab</span><span class="o">.</span><span class="n">setToolTip</span><span class="p">(</span><span class="n">aForm</span><span class="o">.</span><span class="n">ddTable</span><span class="o">.</span><span class="n">comment</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mainTab</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buttonBox</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QDialogButtonBox</span><span class="p">(</span><span class="n">DataDrivenInputMask</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buttonBox</span><span class="o">.</span><span class="n">setOrientation</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">Horizontal</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buttonBox</span><span class="o">.</span><span class="n">setStandardButtons</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QDialogButtonBox</span><span class="o">.</span><span class="n">Cancel</span><span class="o">|</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QDialogButtonBox</span><span class="o">.</span><span class="n">Ok</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buttonBox</span><span class="o">.</span><span class="n">setObjectName</span><span class="p">(</span><span class="s">&quot;buttonBox&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buttonBox</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mainTab</span><span class="o">.</span><span class="n">setCurrentIndex</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">QtCore</span><span class="o">.</span><span class="n">QObject</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buttonBox</span><span class="p">,</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">SIGNAL</span><span class="p">(</span><span class="s">&quot;accepted()&quot;</span><span class="p">),</span> <span class="n">DataDrivenInputMask</span><span class="o">.</span><span class="n">accept</span><span class="p">)</span>
        <span class="n">QtCore</span><span class="o">.</span><span class="n">QObject</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buttonBox</span><span class="p">,</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">SIGNAL</span><span class="p">(</span><span class="s">&quot;rejected()&quot;</span><span class="p">),</span> <span class="n">DataDrivenInputMask</span><span class="o">.</span><span class="n">reject</span><span class="p">)</span>
        <span class="n">QtCore</span><span class="o">.</span><span class="n">QMetaObject</span><span class="o">.</span><span class="n">connectSlotsByName</span><span class="p">(</span><span class="n">DataDrivenInputMask</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="DdDialogWidget.addFormWidget"><a class="viewcode-back" href="../autodoc.html#ddui.DdDialogWidget.addFormWidget">[docs]</a>    <span class="k">def</span> <span class="nf">addFormWidget</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">ddFormWidget</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ddFormWidget</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="DdDialogWidget.initialize"><a class="viewcode-back" href="../autodoc.html#ddui.DdDialogWidget.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">layer</span><span class="p">,</span>  <span class="n">feature</span><span class="p">,</span>  <span class="n">db</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">aForm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">forms</span><span class="p">:</span>
            <span class="n">aForm</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span>  <span class="n">feature</span><span class="p">,</span>  <span class="n">db</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="DdDialogWidget.checkInput"><a class="viewcode-back" href="../autodoc.html#ddui.DdDialogWidget.checkInput">[docs]</a>    <span class="k">def</span> <span class="nf">checkInput</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">inputOk</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">for</span> <span class="n">aForm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">forms</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">aForm</span><span class="o">.</span><span class="n">checkInput</span><span class="p">():</span>
                <span class="n">inputOk</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">break</span>

        <span class="k">return</span> <span class="n">inputOk</span>
</div>
<div class="viewcode-block" id="DdDialogWidget.save"><a class="viewcode-back" href="../autodoc.html#ddui.DdDialogWidget.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">layer</span><span class="p">,</span>  <span class="n">feature</span><span class="p">,</span>  <span class="n">db</span><span class="p">):</span>
        <span class="n">hasChanges</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">for</span> <span class="n">aForm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">forms</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">aForm</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span>  <span class="n">feature</span><span class="p">,</span>  <span class="n">db</span><span class="p">):</span>
                <span class="n">hasChanges</span> <span class="o">=</span> <span class="bp">True</span>
        
        <span class="k">return</span> <span class="n">hasChanges</span>
</div>
<div class="viewcode-block" id="DdDialogWidget.discard"><a class="viewcode-back" href="../autodoc.html#ddui.DdDialogWidget.discard">[docs]</a>    <span class="k">def</span> <span class="nf">discard</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">aForm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">forms</span><span class="p">:</span>
            <span class="n">aForm</span><span class="o">.</span><span class="n">discard</span><span class="p">()</span>
</div></div>
<div class="viewcode-block" id="DdFormWidget"><a class="viewcode-back" href="../autodoc.html#ddui.DdFormWidget">[docs]</a><span class="k">class</span> <span class="nc">DdFormWidget</span><span class="p">(</span><span class="n">DdWidget</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;class arranges its input widgets either in a QToolBox or int the DdDialogWidget&#39;s current tab&#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">ddTable</span><span class="p">,</span> <span class="n">hasToolBox</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>  <span class="n">layer</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">DdWidget</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ddTable</span> <span class="o">=</span> <span class="n">ddTable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hasToolBox</span> <span class="o">=</span> <span class="n">hasToolBox</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layer</span> <span class="o">=</span> <span class="n">layer</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">feature</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputWidgets</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;&lt;ddui.DdFormWidget&gt;&quot;</span>

    <span class="k">def</span> <span class="nf">__getLayer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">db</span><span class="p">):</span>
        <span class="n">pParent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span>

        <span class="k">while</span> <span class="p">(</span><span class="bp">True</span><span class="p">):</span>
            <span class="n">pParent</span> <span class="o">=</span> <span class="n">pParent</span><span class="o">.</span><span class="n">parentWidget</span><span class="p">()</span>
            <span class="c">#QtGui.QMessageBox.information(None, &quot;pParent&quot;,  str(parent) + &quot;&quot; + str(pParent))</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pParent</span><span class="p">,</span>  <span class="n">DdDialog</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parentDialog</span> <span class="o">=</span> <span class="n">pParent</span>
                <span class="k">break</span>

        <span class="c"># find the layer in the project</span>
        <span class="n">layer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parentDialog</span><span class="o">.</span><span class="n">ddManager</span><span class="o">.</span><span class="n">findPostgresLayer</span><span class="p">(</span><span class="n">db</span><span class="p">,</span>  <span class="bp">self</span><span class="o">.</span><span class="n">ddTable</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">layer</span><span class="p">:</span>
            <span class="c"># load the layer into the project</span>
            <span class="n">layer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parentDialog</span><span class="o">.</span><span class="n">ddManager</span><span class="o">.</span><span class="n">loadPostGISLayer</span><span class="p">(</span><span class="n">db</span><span class="p">,</span>  <span class="bp">self</span><span class="o">.</span><span class="n">ddTable</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">layer</span>

    <span class="k">def</span> <span class="nf">__setLayerEditable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># put layer in edintg mode</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">isEditable</span><span class="p">()</span> <span class="c"># is already in editMode</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
            <span class="c"># try to start editing</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">startEditing</span><span class="p">()</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
                <span class="n">QtGui</span><span class="o">.</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span>  <span class="n">QtGui</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s">&quot;DdWarning&quot;</span><span class="p">,</span> <span class="s">&quot;Layer cannot be put in editing mode:&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span>
                                                           <span class="n">QtGui</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">UnicodeUTF8</span><span class="p">))</span> <span class="o">+</span> <span class="s">&quot; </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">ok</span>

<div class="viewcode-block" id="DdFormWidget.setupUi"><a class="viewcode-back" href="../autodoc.html#ddui.DdFormWidget.setupUi">[docs]</a>    <span class="k">def</span> <span class="nf">setupUi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">parent</span><span class="p">,</span>  <span class="n">db</span><span class="p">):</span>
        <span class="c">#QtGui.QMessageBox.information(None, &quot;DdFormWidget setupUi&quot;, parent.objectName())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
        <span class="nb">sorted</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ddInputWidget</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputWidgets</span><span class="p">:</span>
            <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ddInputWidget</span><span class="o">.</span><span class="n">getLabel</span><span class="p">())</span>

        <span class="k">if</span> <span class="nb">sorted</span><span class="p">:</span>
            <span class="n">labels</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hasToolBox</span><span class="p">:</span>
            <span class="n">scrollArea</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QScrollArea</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
            <span class="n">scrollArea</span><span class="o">.</span><span class="n">setWidgetResizable</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">scrollArea</span><span class="o">.</span><span class="n">setObjectName</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">objectName</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;_scrollArea&quot;</span><span class="p">)</span>
            <span class="n">scrollAreaWidgetContents</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QWidget</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
            <span class="n">scrollAreaWidgetContents</span><span class="o">.</span><span class="n">setObjectName</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">objectName</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;_scrollAreaWidgetContents&quot;</span><span class="p">)</span>
            <span class="n">formLayout</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QFormLayout</span><span class="p">(</span><span class="n">scrollAreaWidgetContents</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">anWidget</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputWidgets</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">anWidget</span><span class="o">.</span><span class="n">getLabel</span><span class="p">()</span> <span class="o">==</span> <span class="n">label</span><span class="p">:</span>
                        <span class="n">ddInputWidget</span> <span class="o">=</span> <span class="n">anWidget</span>
                        <span class="k">break</span>
                <span class="c">#QtGui.QMessageBox.information(None, &quot;&quot;,  str(ddInputWidget))</span>
                <span class="n">ddInputWidget</span><span class="o">.</span><span class="n">setupUi</span><span class="p">(</span><span class="n">scrollAreaWidgetContents</span><span class="p">,</span>  <span class="n">db</span><span class="p">)</span>

            <span class="n">scrollArea</span><span class="o">.</span><span class="n">setWidget</span><span class="p">(</span><span class="n">scrollAreaWidgetContents</span><span class="p">)</span>
            <span class="n">parent</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">scrollArea</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">anWidget</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputWidgets</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">anWidget</span><span class="o">.</span><span class="n">getLabel</span><span class="p">()</span> <span class="o">==</span> <span class="n">label</span><span class="p">:</span>
                        <span class="n">ddInputWidget</span> <span class="o">=</span> <span class="n">anWidget</span>
                        <span class="k">break</span>
                <span class="n">ddInputWidget</span><span class="o">.</span><span class="n">setupUi</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span>  <span class="n">db</span><span class="p">)</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">layer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getLayer</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="DdFormWidget.addInputWidget"><a class="viewcode-back" href="../autodoc.html#ddui.DdFormWidget.addInputWidget">[docs]</a>    <span class="k">def</span> <span class="nf">addInputWidget</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">ddInputWidget</span><span class="p">):</span>
        <span class="c">#QtGui.QMessageBox.information(None,  &quot;addInputWidget&quot;,  ddInputWidget.attribute.name)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputWidgets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ddInputWidget</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="DdFormWidget.initialize"><a class="viewcode-back" href="../autodoc.html#ddui.DdFormWidget.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">layer</span><span class="p">,</span>  <span class="n">feature</span><span class="p">,</span>  <span class="n">db</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">id</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">id</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">feature</span> <span class="o">=</span> <span class="n">feature</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">feature</span> <span class="o">=</span> <span class="n">QgsFeature</span><span class="p">()</span>
            
            <span class="k">if</span> <span class="n">QGis</span><span class="o">.</span><span class="n">QGIS_VERSION_INT</span> <span class="o">&gt;=</span> <span class="mi">10900</span><span class="p">:</span>
                <span class="n">featureFound</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">getFeatures</span><span class="p">(</span><span class="n">QgsFeatureRequest</span><span class="p">()</span><span class="o">.</span><span class="n">setFilterFid</span><span class="p">(</span><span class="n">feature</span><span class="o">.</span><span class="n">id</span><span class="p">())</span><span class="o">.</span><span class="n">setFlags</span><span class="p">(</span><span class="n">QgsFeatureRequest</span><span class="o">.</span><span class="n">NoGeometry</span><span class="p">))</span><span class="o">.</span><span class="n">nextFeature</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">featureFound</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">featureAtId</span><span class="p">(</span><span class="n">feature</span><span class="o">.</span><span class="n">id</span><span class="p">(),</span>  <span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span>  <span class="bp">True</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="n">featureFound</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">feature</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="n">QtGui</span><span class="o">.</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">information</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span><span class="s">&quot;!featureFound&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">feature</span><span class="o">.</span><span class="n">id</span><span class="p">()))</span>

            <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">isEditable</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__setLayerEditable</span><span class="p">())</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">anInputWidget</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputWidgets</span><span class="p">:</span>
                <span class="n">anInputWidget</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layer</span><span class="p">,</span>  <span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="p">,</span>  <span class="n">db</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
            
        <span class="c">#QtGui.QMessageBox.information(None,  &quot;initializing Form&quot;,  &quot;passed layer: &quot;+ layer.name() + &quot;\n self.layer: &quot; + self.layer.name() + &quot;\n self.ddTable: &quot; + self.ddTable.tableName + &quot;\n self.feature: &quot; + str(self.feature) + &quot;\n self.parent.isEnabled: &quot; + str(self.parent.isEnabled()))</span>
</div>
<div class="viewcode-block" id="DdFormWidget.checkInput"><a class="viewcode-back" href="../autodoc.html#ddui.DdFormWidget.checkInput">[docs]</a>    <span class="k">def</span> <span class="nf">checkInput</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">inputOk</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">isEnabled</span><span class="p">():</span> <span class="c">#only check if the tab is enbaled, e.g. parents are not enabled if this is a new feature</span>
            <span class="k">for</span> <span class="n">anInputWidget</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputWidgets</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">anInputWidget</span><span class="o">.</span><span class="n">checkInput</span><span class="p">():</span>
                    <span class="n">inputOk</span> <span class="o">=</span> <span class="bp">False</span>
                    <span class="k">break</span>

        <span class="k">return</span> <span class="n">inputOk</span>
</div>
<div class="viewcode-block" id="DdFormWidget.save"><a class="viewcode-back" href="../autodoc.html#ddui.DdFormWidget.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">layer</span><span class="p">,</span>  <span class="n">feature</span><span class="p">,</span>  <span class="n">db</span><span class="p">):</span>
        <span class="n">hasChanges</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">isEnabled</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">anInputWidget</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputWidgets</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">anInputWidget</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layer</span><span class="p">,</span>  <span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="p">,</span>  <span class="n">db</span><span class="p">):</span>
                    <span class="n">hasChanges</span> <span class="o">=</span> <span class="bp">True</span>
        
        <span class="k">return</span> <span class="n">hasChanges</span>
</div>
<div class="viewcode-block" id="DdFormWidget.discard"><a class="viewcode-back" href="../autodoc.html#ddui.DdFormWidget.discard">[docs]</a>    <span class="k">def</span> <span class="nf">discard</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">isEnabled</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">anInputWidget</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputWidgets</span><span class="p">:</span>
                <span class="n">anInputWidget</span><span class="o">.</span><span class="n">discard</span><span class="p">()</span>
</div></div>
<div class="viewcode-block" id="DdInputWidget"><a class="viewcode-back" href="../autodoc.html#ddui.DdInputWidget">[docs]</a><span class="k">class</span> <span class="nc">DdInputWidget</span><span class="p">(</span><span class="n">DdWidget</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;abstract super class for all input widgets&#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">attribute</span><span class="p">):</span>
        <span class="n">DdWidget</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attribute</span> <span class="o">=</span> <span class="n">attribute</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hasChanges</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;&lt;ddui.DdInputWidget </span><span class="si">%s</span><span class="s">&gt;&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    
<div class="viewcode-block" id="DdInputWidget.registerChange"><a class="viewcode-back" href="../autodoc.html#ddui.DdInputWidget.registerChange">[docs]</a>    <span class="k">def</span> <span class="nf">registerChange</span><span class="p">(</span><span class="bp">self</span> <span class="p">,</span> <span class="n">thisValue</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;slot to be called by any concrete InputWidget&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hasChanges</span> <span class="o">=</span> <span class="bp">True</span>
        </div>
<div class="viewcode-block" id="DdInputWidget.getLabel"><a class="viewcode-back" href="../autodoc.html#ddui.DdInputWidget.getLabel">[docs]</a>    <span class="k">def</span> <span class="nf">getLabel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">labelString</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">getLabel</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">labelString</span>
</div>
<div class="viewcode-block" id="DdInputWidget.changeLabelColor"><a class="viewcode-back" href="../autodoc.html#ddui.DdInputWidget.changeLabelColor">[docs]</a>    <span class="k">def</span> <span class="nf">changeLabelColor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">valid</span><span class="p">):</span>
        <span class="n">labelString</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getLabel</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">valid</span><span class="p">:</span>
            <span class="n">labelString</span> <span class="o">=</span> <span class="s">&quot;&lt;font color=&#39;Green&#39;&gt;&quot;</span> <span class="o">+</span> <span class="n">labelString</span> <span class="o">+</span> <span class="s">&quot;&lt;/font&gt;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">labelString</span> <span class="o">=</span> <span class="s">&quot;&lt;font color=&#39;Red&#39;&gt;&quot;</span> <span class="o">+</span> <span class="n">labelString</span> <span class="o">+</span> <span class="s">&quot;&lt;/font&gt;&quot;</span>

        <span class="k">return</span> <span class="n">labelString</span>
</div>
<div class="viewcode-block" id="DdInputWidget.createLabel"><a class="viewcode-back" href="../autodoc.html#ddui.DdInputWidget.createLabel">[docs]</a>    <span class="k">def</span> <span class="nf">createLabel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">parent</span><span class="p">):</span>
        <span class="n">labelString</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getLabel</span><span class="p">()</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QLabel</span><span class="p">(</span><span class="n">labelString</span><span class="p">,</span>  <span class="n">parent</span><span class="p">)</span>
        <span class="n">label</span><span class="o">.</span><span class="n">setObjectName</span><span class="p">(</span><span class="s">&quot;lbl&quot;</span> <span class="o">+</span> <span class="n">parent</span><span class="o">.</span><span class="n">objectName</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">label</span>
</div>
<div class="viewcode-block" id="DdInputWidget.getMaxValueFromTable"><a class="viewcode-back" href="../autodoc.html#ddui.DdInputWidget.getMaxValueFromTable">[docs]</a>    <span class="k">def</span> <span class="nf">getMaxValueFromTable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">schemaName</span><span class="p">,</span>  <span class="n">tableName</span><span class="p">,</span>  <span class="n">db</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">QtSql</span><span class="o">.</span><span class="n">QSqlQuery</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
        <span class="n">query</span><span class="o">.</span><span class="n">prepare</span><span class="p">(</span><span class="s">&quot;SELECT </span><span class="se">\&quot;</span><span class="s">&quot;</span> <span class="o">+</span> \
                      <span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> \
                      <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s"> FROM </span><span class="se">\&quot;</span><span class="s">&quot;</span> <span class="o">+</span> \
                      <span class="n">schemaName</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">.</span><span class="se">\&quot;</span><span class="s">&quot;</span> <span class="o">+</span> \
                      <span class="n">tableName</span> <span class="o">+</span> \
                      <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s"> ORDER BY </span><span class="se">\&quot;</span><span class="s">&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s"> DESC LIMIT 1;&quot;</span><span class="p">)</span>
        <span class="n">query</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">isActive</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">first</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">query</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">toString</span><span class="p">()</span><span class="o">.</span><span class="n">toInt</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">0</span>

            <span class="n">query</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">DbError</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</div></div>
<div class="viewcode-block" id="DdLineEdit"><a class="viewcode-back" href="../autodoc.html#ddui.DdLineEdit">[docs]</a><span class="k">class</span> <span class="nc">DdLineEdit</span><span class="p">(</span><span class="n">DdInputWidget</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;abstract class for all Input Widgets that can be represented in one line,</span>
<span class="sd">    creates a QLineEdit as default InputWidget, adds a label and the inputWidget</span>
<span class="sd">    to a QFormLayout. Methods implemented</span>
<span class="sd">    in this class can be overridden by implementations in child classes&#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">attribute</span><span class="p">):</span>
        <span class="n">DdInputWidget</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">attribute</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;&lt;ddui.DdOneLineInputWidget </span><span class="si">%s</span><span class="s">&gt;&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        
<div class="viewcode-block" id="DdLineEdit.getFeatureValue"><a class="viewcode-back" href="../autodoc.html#ddui.DdLineEdit.getFeatureValue">[docs]</a>    <span class="k">def</span> <span class="nf">getFeatureValue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">layer</span><span class="p">,</span>  <span class="n">feature</span><span class="p">,</span>  <span class="n">db</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;returns a QString representing the value in this field for this feature;</span>
<span class="sd">        if it is a new feature the default value is returned</span>
<span class="sd">        default implementation for a QLineEdit&#39;&#39;&#39;</span>

        <span class="n">fieldIndex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getFieldIndex</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">QGis</span><span class="o">.</span><span class="n">QGIS_VERSION_INT</span> <span class="o">&gt;=</span> <span class="mi">10900</span><span class="p">:</span>
            <span class="n">thisValue</span> <span class="o">=</span> <span class="n">feature</span><span class="p">[</span><span class="n">fieldIndex</span><span class="p">]</span><span class="o">.</span><span class="n">toString</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">thisValue</span> <span class="o">=</span> <span class="n">feature</span><span class="o">.</span><span class="n">attributeMap</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">fieldIndex</span><span class="p">)</span><span class="o">.</span><span class="n">toString</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">feature</span><span class="o">.</span><span class="n">id</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">thisValue</span><span class="o">.</span><span class="n">isEmpty</span><span class="p">():</span> <span class="c"># new feature</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">hasDefault</span><span class="p">:</span>
                <span class="n">thisValue</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QString</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">default</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">thisValue</span>
</div>
<div class="viewcode-block" id="DdLineEdit.createInputWidget"><a class="viewcode-back" href="../autodoc.html#ddui.DdLineEdit.createInputWidget">[docs]</a>    <span class="k">def</span> <span class="nf">createInputWidget</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">parent</span><span class="p">):</span>
        <span class="n">inputWidget</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QLineEdit</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span> <span class="c"># defaultInputWidget</span>
        <span class="n">inputWidget</span><span class="o">.</span><span class="n">setObjectName</span><span class="p">(</span><span class="s">&quot;txl&quot;</span> <span class="o">+</span> <span class="n">parent</span><span class="o">.</span><span class="n">objectName</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">inputWidget</span><span class="o">.</span><span class="n">textChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">registerChange</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">inputWidget</span>

    <span class="c"># public methods</span></div>
<div class="viewcode-block" id="DdLineEdit.setValue"><a class="viewcode-back" href="../autodoc.html#ddui.DdLineEdit.setValue">[docs]</a>    <span class="k">def</span> <span class="nf">setValue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">thisValue</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputWidget</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">thisValue</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="DdLineEdit.getValue"><a class="viewcode-back" href="../autodoc.html#ddui.DdLineEdit.getValue">[docs]</a>    <span class="k">def</span> <span class="nf">getValue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">thisValue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputWidget</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">thisValue</span><span class="o">.</span><span class="n">isEmpty</span><span class="p">():</span>
            <span class="n">thisValue</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c">#QtGui.QMessageBox.information(None,  &quot;DdLineEdit&quot;,  &quot;getValue &quot; + self.attribute.label  + &quot; &quot; + str(thisValue))</span>
        <span class="k">return</span> <span class="n">thisValue</span>
</div>
<div class="viewcode-block" id="DdLineEdit.setupUi"><a class="viewcode-back" href="../autodoc.html#ddui.DdLineEdit.setupUi">[docs]</a>    <span class="k">def</span> <span class="nf">setupUi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">parent</span><span class="p">,</span>  <span class="n">db</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;setup the label and add the inputWidget to parents formLayout&#39;&#39;&#39;</span>
        <span class="c">#QtGui.QMessageBox.information(None,  &quot;DdLineEdit&quot;,  &quot;setupUi &quot; + self.attribute.name)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">createLabel</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputWidget</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">createInputWidget</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputWidget</span><span class="o">.</span><span class="n">setToolTip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">comment</span><span class="p">)</span>
        <span class="n">hLayout</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QHBoxLayout</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
        <span class="n">hLayout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputWidget</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chk</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QCheckBox</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s">&quot;DdInfo&quot;</span><span class="p">,</span> <span class="s">&quot;Null&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span>
                                                           <span class="n">QtGui</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">UnicodeUTF8</span><span class="p">),</span>  <span class="n">parent</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chk</span><span class="o">.</span><span class="n">setObjectName</span><span class="p">(</span><span class="s">&quot;chk&quot;</span> <span class="o">+</span> <span class="n">parent</span><span class="o">.</span><span class="n">objectName</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chk</span><span class="o">.</span><span class="n">setToolTip</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s">&quot;DdInfo&quot;</span><span class="p">,</span> <span class="s">&quot;Check this if you want to save an empty date.&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span>
                                                           <span class="n">QtGui</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">UnicodeUTF8</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chk</span><span class="o">.</span><span class="n">stateChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chkStateChanged</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chk</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">notNull</span><span class="p">)</span>
        <span class="n">hLayout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chk</span><span class="p">)</span>
        <span class="n">parent</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addRow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">,</span>  <span class="n">hLayout</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="DdLineEdit.chkStateChanged"><a class="viewcode-back" href="../autodoc.html#ddui.DdLineEdit.chkStateChanged">[docs]</a>    <span class="k">def</span> <span class="nf">chkStateChanged</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">newState</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputWidget</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">newState</span> <span class="o">==</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">Unchecked</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="DdLineEdit.initialize"><a class="viewcode-back" href="../autodoc.html#ddui.DdLineEdit.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">layer</span><span class="p">,</span>  <span class="n">feature</span><span class="p">,</span>  <span class="n">db</span><span class="p">):</span>
        <span class="n">thisValue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getFeatureValue</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span>  <span class="n">feature</span><span class="p">,</span>  <span class="n">db</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">thisValue</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hasChanges</span> <span class="o">=</span> <span class="p">(</span><span class="n">feature</span><span class="o">.</span><span class="n">id</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="c"># register this change only for new feature</span>
</div>
<div class="viewcode-block" id="DdLineEdit.checkInput"><a class="viewcode-back" href="../autodoc.html#ddui.DdLineEdit.checkInput">[docs]</a>    <span class="k">def</span> <span class="nf">checkInput</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">thisValue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getValue</span><span class="p">()</span>
        <span class="c">#QtGui.QMessageBox.information(None, &quot;checkInput&quot;,  self.attribute.name + &quot; &quot; + str(thisValue))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">notNull</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">thisValue</span><span class="p">:</span>
            <span class="n">QtGui</span><span class="o">.</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">text</span><span class="p">(),</span>  <span class="n">QtGui</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s">&quot;DdWarning&quot;</span><span class="p">,</span> <span class="s">&quot;Field must not be empty!&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span>
                                                           <span class="n">QtGui</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">UnicodeUTF8</span><span class="p">)</span> <span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="DdLineEdit.getFieldIndex"><a class="viewcode-back" href="../autodoc.html#ddui.DdLineEdit.getFieldIndex">[docs]</a>    <span class="k">def</span> <span class="nf">getFieldIndex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">layer</span><span class="p">):</span>
        <span class="c">#QtGui.QMessageBox.information(None, &quot;getFieldIndex&quot;,  &quot;layer: &quot; + layer.name() + &quot; attribute: &quot; + self.attribute.name)</span>
        <span class="k">if</span> <span class="n">layer</span><span class="p">:</span>
            <span class="n">fieldIndex</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">fieldNameIndex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fieldIndex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">num</span>

        <span class="k">if</span> <span class="n">fieldIndex</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">DdError</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s">&quot;DdError&quot;</span><span class="p">,</span> <span class="s">&quot;Field not found in layer: &quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span>
                                                           <span class="n">QtGui</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">UnicodeUTF8</span><span class="p">)</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="p">())</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">fieldIndex</span>
</div>
<div class="viewcode-block" id="DdLineEdit.save"><a class="viewcode-back" href="../autodoc.html#ddui.DdLineEdit.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">layer</span><span class="p">,</span>  <span class="n">feature</span><span class="p">,</span>  <span class="n">db</span><span class="p">):</span>
        <span class="n">thisValue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getValue</span><span class="p">()</span>
        <span class="n">fieldIndex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getFieldIndex</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hasChanges</span><span class="p">:</span>
            <span class="n">layer</span><span class="o">.</span><span class="n">changeAttributeValue</span><span class="p">(</span><span class="n">feature</span><span class="o">.</span><span class="n">id</span><span class="p">(),</span>  <span class="n">fieldIndex</span><span class="p">,</span>  <span class="n">QtCore</span><span class="o">.</span><span class="n">QVariant</span><span class="p">(</span><span class="n">thisValue</span><span class="p">),</span>  <span class="bp">False</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">hasChanges</span>
</div></div>
<div class="viewcode-block" id="QInt64Validator"><a class="viewcode-back" href="../autodoc.html#ddui.QInt64Validator">[docs]</a><span class="k">class</span> <span class="nc">QInt64Validator</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QValidator</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">parent</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">QtGui</span><span class="o">.</span><span class="n">QValidator</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">parent</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min</span> <span class="o">=</span> <span class="o">-</span><span class="mi">9223372036854775808</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">9223372036854775807</span>

<div class="viewcode-block" id="QInt64Validator.validate"><a class="viewcode-back" href="../autodoc.html#ddui.QInt64Validator.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
        <span class="n">thisValue</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">toLongLong</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">thisValue</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="c"># boolean</span>
            <span class="n">thisLong</span> <span class="o">=</span> <span class="n">thisValue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">min</span> <span class="o">&lt;</span> <span class="n">thisLong</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">max</span> <span class="o">&gt;</span> <span class="n">thisLong</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QValidator</span><span class="o">.</span><span class="n">Acceptable</span><span class="p">,</span>  <span class="n">pos</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QValidator</span><span class="o">.</span><span class="n">Invalid</span><span class="p">,</span>  <span class="n">pos</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QValidator</span><span class="o">.</span><span class="n">Invalid</span><span class="p">,</span>  <span class="n">pos</span>
</div></div>
<div class="viewcode-block" id="DdLineEditInt"><a class="viewcode-back" href="../autodoc.html#ddui.DdLineEditInt">[docs]</a><span class="k">class</span> <span class="nc">DdLineEditInt</span><span class="p">(</span><span class="n">DdLineEdit</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;QLineEdit for an IntegerValue&#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">attribute</span><span class="p">):</span>
        <span class="n">DdLineEdit</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">attribute</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;&lt;ddui.DdLineEditInt </span><span class="si">%s</span><span class="s">&gt;&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

<div class="viewcode-block" id="DdLineEditInt.getFeatureValue"><a class="viewcode-back" href="../autodoc.html#ddui.DdLineEditInt.getFeatureValue">[docs]</a>    <span class="k">def</span> <span class="nf">getFeatureValue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">layer</span><span class="p">,</span>  <span class="n">feature</span><span class="p">,</span>  <span class="n">db</span><span class="p">):</span>
        <span class="n">fieldIndex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getFieldIndex</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">QGis</span><span class="o">.</span><span class="n">QGIS_VERSION_INT</span> <span class="o">&gt;=</span> <span class="mi">10900</span><span class="p">:</span>
            <span class="n">thisValue</span> <span class="o">=</span> <span class="n">feature</span><span class="p">[</span><span class="n">fieldIndex</span><span class="p">]</span><span class="o">.</span><span class="n">toString</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">thisValue</span> <span class="o">=</span> <span class="n">feature</span><span class="o">.</span><span class="n">attributeMap</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">fieldIndex</span><span class="p">)</span><span class="o">.</span><span class="n">toString</span><span class="p">()</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">feature</span><span class="o">.</span><span class="n">id</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">thisValue</span><span class="o">.</span><span class="n">isEmpty</span><span class="p">()):</span> <span class="c"># new feature and no value set</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">hasDefault</span><span class="p">:</span>
                <span class="n">thisValue</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QString</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">default</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">isPK</span> <span class="p">:</span>
                    <span class="n">thisValue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMaxValueFromTable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">schemaName</span><span class="p">,</span>  <span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">tableName</span><span class="p">,</span>  <span class="n">db</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="n">thisValue</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QString</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">thisValue</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">thisValue</span>
</div>
<div class="viewcode-block" id="DdLineEditInt.setValidator"><a class="viewcode-back" href="../autodoc.html#ddui.DdLineEditInt.setValidator">[docs]</a>    <span class="k">def</span> <span class="nf">setValidator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QString</span><span class="p">(</span><span class="s">&quot;int2&quot;</span><span class="p">):</span>
            <span class="nb">min</span> <span class="o">=</span> <span class="o">-</span><span class="mi">32768</span>
            <span class="nb">max</span> <span class="o">=</span> <span class="mi">32767</span>
            <span class="n">validator</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QIntValidator</span><span class="p">(</span><span class="nb">min</span><span class="p">,</span>  <span class="nb">max</span><span class="p">,</span>  <span class="bp">self</span><span class="o">.</span><span class="n">inputWidget</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QString</span><span class="p">(</span><span class="s">&quot;int4&quot;</span><span class="p">):</span>
            <span class="nb">min</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2147483648</span>
            <span class="nb">max</span> <span class="o">=</span> <span class="mi">2147483647</span>
            <span class="n">validator</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QIntValidator</span><span class="p">(</span><span class="nb">min</span><span class="p">,</span>  <span class="nb">max</span><span class="p">,</span>  <span class="bp">self</span><span class="o">.</span><span class="n">inputWidget</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QString</span><span class="p">(</span><span class="s">&quot;int8&quot;</span><span class="p">):</span>
            <span class="n">validator</span> <span class="o">=</span> <span class="n">QInt64Validator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputWidget</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">inputWidget</span><span class="o">.</span><span class="n">setValidator</span><span class="p">(</span><span class="n">validator</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">setupUi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">parent</span><span class="p">,</span>  <span class="n">db</span><span class="p">):</span>
        <span class="n">DdLineEdit</span><span class="o">.</span><span class="n">setupUi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">parent</span><span class="p">,</span>  <span class="n">db</span><span class="p">)</span>
        <span class="c">#self.setValidator()</span>

<div class="viewcode-block" id="DdLineEditInt.initialize"><a class="viewcode-back" href="../autodoc.html#ddui.DdLineEditInt.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">layer</span><span class="p">,</span>  <span class="n">feature</span><span class="p">,</span>  <span class="n">db</span><span class="p">):</span>
        <span class="n">thisValue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getFeatureValue</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span>  <span class="n">feature</span><span class="p">,</span>  <span class="n">db</span><span class="p">)</span>
        <span class="n">isInt</span> <span class="o">=</span> <span class="n">thisValue</span><span class="o">.</span><span class="n">toInt</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span>  <span class="n">isInt</span><span class="p">:</span> <span class="c"># could be a Longlong, or a serial, i.e. a nextval(sequence) expression</span>
            <span class="n">isInt</span> <span class="o">=</span> <span class="n">thisValue</span><span class="o">.</span><span class="n">toLongLong</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>

            <span class="k">if</span> <span class="ow">not</span>  <span class="n">isInt</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inputWidget</span><span class="o">.</span><span class="n">setValidator</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span> <span class="c"># remove the validator</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">thisValue</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">isInt</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setValidator</span><span class="p">()</span>
</div></div>
<div class="viewcode-block" id="DdLineEditDouble"><a class="viewcode-back" href="../autodoc.html#ddui.DdLineEditDouble">[docs]</a><span class="k">class</span> <span class="nc">DdLineEditDouble</span><span class="p">(</span><span class="n">DdLineEdit</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;QLineEdit for a DoubleValue&#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">attribute</span><span class="p">):</span>
        <span class="n">DdLineEdit</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">attribute</span><span class="p">)</span>
        <span class="c">#QtGui.QMessageBox.information(None,  &quot;DdLineEditDouble&quot;,  &quot;init &quot; + self.attribute.name)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;&lt;ddui.DdLineEditDouble </span><span class="si">%s</span><span class="s">&gt;&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

<div class="viewcode-block" id="DdLineEditDouble.setValue"><a class="viewcode-back" href="../autodoc.html#ddui.DdLineEditDouble.setValue">[docs]</a>    <span class="k">def</span> <span class="nf">setValue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">thisValue</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">thisValue</span><span class="o">.</span><span class="n">isEmpty</span><span class="p">():</span>
            <span class="c"># convert double to a locale string representation</span>
            <span class="n">thisDouble</span><span class="p">,</span>  <span class="n">ok</span> <span class="o">=</span> <span class="n">thisValue</span><span class="o">.</span><span class="n">toDouble</span><span class="p">()</span>
            
            <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
                <span class="n">loc</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QLocale</span><span class="o">.</span><span class="n">system</span><span class="p">()</span>
                <span class="n">thisValue</span> <span class="o">=</span> <span class="n">loc</span><span class="o">.</span><span class="n">toString</span><span class="p">(</span><span class="n">thisDouble</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">chk</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">inputWidget</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">thisValue</span><span class="p">)</span>
    </div>
<div class="viewcode-block" id="DdLineEditDouble.getValue"><a class="viewcode-back" href="../autodoc.html#ddui.DdLineEditDouble.getValue">[docs]</a>    <span class="k">def</span> <span class="nf">getValue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">thisValue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputWidget</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">thisValue</span><span class="o">.</span><span class="n">isEmpty</span><span class="p">():</span>
            <span class="n">thisValue</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">loc</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QLocale</span><span class="o">.</span><span class="n">system</span><span class="p">()</span>
            <span class="n">thisDouble</span> <span class="o">=</span> <span class="n">loc</span><span class="o">.</span><span class="n">toDouble</span><span class="p">(</span><span class="n">thisValue</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">thisDouble</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">thisValue</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QString</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">thisDouble</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">thisValue</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">return</span> <span class="n">thisValue</span>
</div>
<div class="viewcode-block" id="DdLineEditDouble.setValidator"><a class="viewcode-back" href="../autodoc.html#ddui.DdLineEditDouble.setValidator">[docs]</a>    <span class="k">def</span> <span class="nf">setValidator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">validator</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QDoubleValidator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputWidget</span><span class="p">)</span>
        <span class="n">validator</span><span class="o">.</span><span class="n">setNotation</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QDoubleValidator</span><span class="o">.</span><span class="n">StandardNotation</span><span class="p">)</span>
        <span class="n">validator</span><span class="o">.</span><span class="n">setLocale</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QLocale</span><span class="o">.</span><span class="n">system</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputWidget</span><span class="o">.</span><span class="n">setValidator</span><span class="p">(</span><span class="n">validator</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">__textChanged</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">thisValue</span><span class="p">):</span>
        <span class="n">loc</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QLocale</span><span class="o">.</span><span class="n">system</span><span class="p">()</span>
        <span class="n">thisDouble</span> <span class="o">=</span> <span class="n">loc</span><span class="o">.</span><span class="n">toDouble</span><span class="p">(</span><span class="n">thisValue</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">thisDouble</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">QtGui</span><span class="o">.</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">text</span><span class="p">(),</span>  <span class="n">QtGui</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s">&quot;DdWarning&quot;</span><span class="p">,</span> <span class="s">&quot;Input in Field is not a double according to local settings! &quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span>
                                                           <span class="n">QtGui</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">UnicodeUTF8</span><span class="p">))</span>

<div class="viewcode-block" id="DdLineEditDouble.setupUi"><a class="viewcode-back" href="../autodoc.html#ddui.DdLineEditDouble.setupUi">[docs]</a>    <span class="k">def</span> <span class="nf">setupUi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">parent</span><span class="p">,</span>  <span class="n">db</span><span class="p">):</span>
        <span class="c">#QtGui.QMessageBox.information(None,  &quot;DdLineEditFloat&quot;,  &quot;setupUi &quot; + self.attribute.name)</span>
        <span class="n">DdLineEdit</span><span class="o">.</span><span class="n">setupUi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">parent</span><span class="p">,</span>  <span class="n">db</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setValidator</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputWidget</span><span class="o">.</span><span class="n">textChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__textChanged</span><span class="p">)</span>
</div></div>
<div class="viewcode-block" id="DdLineEditChar"><a class="viewcode-back" href="../autodoc.html#ddui.DdLineEditChar">[docs]</a><span class="k">class</span> <span class="nc">DdLineEditChar</span><span class="p">(</span><span class="n">DdLineEdit</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;QLineEdit for a char or varchar&#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">attribute</span><span class="p">):</span>
        <span class="n">DdLineEdit</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">attribute</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;&lt;ddui.DdLineEditChar </span><span class="si">%s</span><span class="s">&gt;&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

<div class="viewcode-block" id="DdLineEditChar.checkInput"><a class="viewcode-back" href="../autodoc.html#ddui.DdLineEditChar.checkInput">[docs]</a>    <span class="k">def</span> <span class="nf">checkInput</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="n">DdLineEdit</span><span class="o">.</span><span class="n">checkInput</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
            <span class="n">thisValue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getValue</span><span class="p">()</span>
            <span class="n">size</span> <span class="o">=</span> <span class="n">thisValue</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">length</span><span class="p">:</span>
                <span class="n">QtGui</span><span class="o">.</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">text</span><span class="p">(),</span>  <span class="n">QtGui</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s">&quot;DdWarning&quot;</span><span class="p">,</span> <span class="s">&quot;Input in Field is too long! &quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span>
                                                           <span class="n">QtGui</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">UnicodeUTF8</span><span class="p">)</span> <span class="p">)</span>
                <span class="k">return</span> <span class="bp">False</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s">&quot;char&quot;</span> <span class="ow">and</span> <span class="n">size</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">length</span><span class="p">:</span>
                <span class="n">QtGui</span><span class="o">.</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">text</span><span class="p">(),</span>  <span class="n">QtGui</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s">&quot;DdWarning&quot;</span><span class="p">,</span> <span class="s">&quot;Input in Field is too short!&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span>
                                                           <span class="n">QtGui</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">UnicodeUTF8</span><span class="p">)</span> <span class="p">)</span>
                <span class="k">return</span> <span class="bp">False</span>

        <span class="k">return</span> <span class="n">ok</span>
</div></div>
<div class="viewcode-block" id="DdComboBox"><a class="viewcode-back" href="../autodoc.html#ddui.DdComboBox">[docs]</a><span class="k">class</span> <span class="nc">DdComboBox</span><span class="p">(</span><span class="n">DdLineEdit</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;QComboBox for a foreign key&#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">attribute</span><span class="p">):</span>
        <span class="n">DdLineEdit</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">attribute</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;&lt;ddui.DdComboBox </span><span class="si">%s</span><span class="s">&gt;&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

<div class="viewcode-block" id="DdComboBox.getFeatureValue"><a class="viewcode-back" href="../autodoc.html#ddui.DdComboBox.getFeatureValue">[docs]</a>    <span class="k">def</span> <span class="nf">getFeatureValue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">layer</span><span class="p">,</span>  <span class="n">feature</span><span class="p">,</span>  <span class="n">db</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;returns a value representing the value in this field for this feature&#39;&#39;&#39;</span>

        <span class="n">fieldIndex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getFieldIndex</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">isTypeInt</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">QGis</span><span class="o">.</span><span class="n">QGIS_VERSION_INT</span> <span class="o">&gt;=</span> <span class="mi">10900</span><span class="p">:</span>
                <span class="n">thisValue</span> <span class="o">=</span> <span class="n">feature</span><span class="p">[</span><span class="n">fieldIndex</span><span class="p">]</span><span class="o">.</span><span class="n">toString</span><span class="p">()</span>
                
                <span class="k">if</span> <span class="n">thisValue</span><span class="o">.</span><span class="n">isEmpty</span><span class="p">():</span>
                    <span class="n">thisValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">9999</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">thisValue</span> <span class="o">=</span> <span class="n">feature</span><span class="o">.</span><span class="n">attributeMap</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">fieldIndex</span><span class="p">,</span>  <span class="n">QtCore</span><span class="o">.</span><span class="n">QVariant</span><span class="p">(</span><span class="o">-</span><span class="mi">9999</span><span class="p">))</span><span class="o">.</span><span class="n">toInt</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span>  <span class="n">feature</span><span class="o">.</span><span class="n">id</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">thisValue</span> <span class="o">==</span> <span class="o">-</span><span class="mi">9999</span><span class="p">:</span> <span class="c"># new feature and no value set</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">hasDefault</span><span class="p">:</span>
                    <span class="n">thisValue</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QVariant</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">default</span><span class="p">)</span><span class="o">.</span><span class="n">toInt</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">isTypeChar</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">QGis</span><span class="o">.</span><span class="n">QGIS_VERSION_INT</span> <span class="o">&gt;=</span> <span class="mi">10900</span><span class="p">:</span>
                <span class="n">thisValue</span> <span class="o">=</span> <span class="n">feature</span><span class="p">[</span><span class="n">fieldIndex</span><span class="p">]</span><span class="o">.</span><span class="n">toString</span><span class="p">()</span>
                
                <span class="k">if</span> <span class="n">thisValue</span><span class="o">.</span><span class="n">isEmpty</span><span class="p">():</span>
                    <span class="n">thisValue</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QString</span><span class="p">(</span><span class="s">&quot;-9999&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">thisValue</span> <span class="o">=</span> <span class="n">feature</span><span class="o">.</span><span class="n">attributeMap</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">fieldIndex</span><span class="p">,</span>  <span class="s">&quot;-9999&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">toString</span><span class="p">()</span>

            <span class="k">if</span>  <span class="n">feature</span><span class="o">.</span><span class="n">id</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">thisValue</span> <span class="o">==</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QString</span><span class="p">(</span><span class="s">&quot;-9999&quot;</span><span class="p">):</span> <span class="c"># new feature and no value set</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">hasDefault</span><span class="p">:</span>
                    <span class="n">thisValue</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QVariant</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">default</span><span class="p">)</span><span class="o">.</span><span class="n">toString</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">thisValue</span>
</div>
<div class="viewcode-block" id="DdComboBox.createInputWidget"><a class="viewcode-back" href="../autodoc.html#ddui.DdComboBox.createInputWidget">[docs]</a>    <span class="k">def</span> <span class="nf">createInputWidget</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">parent</span><span class="p">):</span>
        <span class="n">inputWidget</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QComboBox</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span> <span class="c"># defaultInputWidget</span>
        <span class="n">inputWidget</span><span class="o">.</span><span class="n">setObjectName</span><span class="p">(</span><span class="s">&quot;cbx&quot;</span> <span class="o">+</span> <span class="n">parent</span><span class="o">.</span><span class="n">objectName</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">inputWidget</span><span class="o">.</span><span class="n">currentIndexChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">registerChange</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">inputWidget</span>
</div>
<div class="viewcode-block" id="DdComboBox.fill"><a class="viewcode-back" href="../autodoc.html#ddui.DdComboBox.fill">[docs]</a>    <span class="k">def</span> <span class="nf">fill</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">db</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">QtSql</span><span class="o">.</span><span class="n">QSqlQuery</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
        <span class="n">query</span><span class="o">.</span><span class="n">prepare</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">queryForCbx</span><span class="p">)</span>
        <span class="n">query</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">isActive</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inputWidget</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">notNull</span><span class="p">:</span>
                <span class="c">#nullString = QtGui.QApplication.translate(&quot;DdInput&quot;, &quot;Please choose&quot;, None, QtGui.QApplication.UnicodeUTF8)</span>
                <span class="n">nullString</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QString</span><span class="p">()</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">isTypeChar</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">inputWidget</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">nullString</span><span class="p">,</span> <span class="s">&quot;-9999&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">isTypeInt</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">inputWidget</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">nullString</span><span class="p">,</span> <span class="o">-</span><span class="mi">9999</span><span class="p">)</span>

            <span class="k">while</span> <span class="n">query</span><span class="o">.</span><span class="n">next</span><span class="p">():</span> <span class="c"># returns false when all records are done</span>
                <span class="n">sValue</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QString</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">toString</span><span class="p">())</span>
                <span class="n">keyValue</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">isTypeChar</span><span class="p">():</span>
                    <span class="n">keyValue</span> <span class="o">=</span> <span class="n">keyValue</span><span class="o">.</span><span class="n">toString</span><span class="p">()</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">isTypeInt</span><span class="p">():</span>
                    <span class="n">keyValue</span> <span class="o">=</span> <span class="n">keyValue</span><span class="o">.</span><span class="n">toInt</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">inputWidget</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">sValue</span><span class="p">,</span> <span class="n">keyValue</span><span class="p">)</span>

            <span class="n">query</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">DbError</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="DdComboBox.setValue"><a class="viewcode-back" href="../autodoc.html#ddui.DdComboBox.setValue">[docs]</a>    <span class="k">def</span> <span class="nf">setValue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">thisValue</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">thisValue</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inputWidget</span><span class="o">.</span><span class="n">setCurrentIndex</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">chk</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputWidget</span><span class="o">.</span><span class="n">count</span><span class="p">()):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputWidget</span><span class="o">.</span><span class="n">itemData</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">==</span> <span class="n">thisValue</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">inputWidget</span><span class="o">.</span><span class="n">setCurrentIndex</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="k">break</span>
</div>
<div class="viewcode-block" id="DdComboBox.getValue"><a class="viewcode-back" href="../autodoc.html#ddui.DdComboBox.getValue">[docs]</a>    <span class="k">def</span> <span class="nf">getValue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">thisValue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputWidget</span><span class="o">.</span><span class="n">itemData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputWidget</span><span class="o">.</span><span class="n">currentIndex</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QString</span><span class="p">(</span><span class="s">&quot;-9999&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">thisValue</span><span class="o">.</span><span class="n">toString</span><span class="p">():</span> <span class="c"># Null selected</span>
            <span class="n">thisValue</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">thisValue</span> <span class="o">=</span> <span class="n">thisValue</span><span class="o">.</span><span class="n">toString</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">thisValue</span>
</div>
<div class="viewcode-block" id="DdComboBox.setupUi"><a class="viewcode-back" href="../autodoc.html#ddui.DdComboBox.setupUi">[docs]</a>    <span class="k">def</span> <span class="nf">setupUi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">parent</span><span class="p">,</span>  <span class="n">db</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;setup the label and add the inputWidget to parents formLayout&#39;&#39;&#39;</span>
        <span class="c">#QtGui.QMessageBox.information(None,  &quot;DdLineEdit&quot;,  &quot;setupUi &quot; + self.attribute.name)</span>
        <span class="n">DdLineEdit</span><span class="o">.</span><span class="n">setupUi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">parent</span><span class="p">,</span>  <span class="n">db</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
</div></div>
<div class="viewcode-block" id="DdDateEdit"><a class="viewcode-back" href="../autodoc.html#ddui.DdDateEdit">[docs]</a><span class="k">class</span> <span class="nc">DdDateEdit</span><span class="p">(</span><span class="n">DdLineEdit</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;QDateEdit for a date field&#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">attribute</span><span class="p">):</span>
        <span class="n">DdLineEdit</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">attribute</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;&lt;ddui.DdDateEdit </span><span class="si">%s</span><span class="s">&gt;&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

<div class="viewcode-block" id="DdDateEdit.getNullValue"><a class="viewcode-back" href="../autodoc.html#ddui.DdDateEdit.getNullValue">[docs]</a>    <span class="k">def</span> <span class="nf">getNullValue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QDate</span><span class="o">.</span><span class="n">fromString</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QString</span><span class="p">(</span><span class="s">&quot;2999.12.31&quot;</span><span class="p">),</span>  <span class="n">QtCore</span><span class="o">.</span><span class="n">QString</span><span class="p">(</span><span class="s">&quot;yyyy.MM.dd&quot;</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="DdDateEdit.getFeatureValue"><a class="viewcode-back" href="../autodoc.html#ddui.DdDateEdit.getFeatureValue">[docs]</a>    <span class="k">def</span> <span class="nf">getFeatureValue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">layer</span><span class="p">,</span>  <span class="n">feature</span><span class="p">,</span>  <span class="n">db</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;returns a QDate representing the value in this field for this feature&#39;&#39;&#39;</span>

        <span class="n">fieldIndex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getFieldIndex</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">QGis</span><span class="o">.</span><span class="n">QGIS_VERSION_INT</span> <span class="o">&gt;=</span> <span class="mi">10900</span><span class="p">:</span>
            <span class="n">thisValue</span> <span class="o">=</span> <span class="n">feature</span><span class="p">[</span><span class="n">fieldIndex</span><span class="p">]</span><span class="o">.</span><span class="n">toString</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">thisValue</span> <span class="o">=</span> <span class="n">feature</span><span class="o">.</span><span class="n">attributeMap</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">fieldIndex</span><span class="p">)</span><span class="o">.</span><span class="n">toString</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">thisValue</span><span class="o">.</span><span class="n">isEmpty</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">feature</span><span class="o">.</span><span class="n">id</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">hasDefault</span><span class="p">:</span>
                <span class="n">thisValue</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QVariant</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">default</span><span class="p">)</span><span class="o">.</span><span class="n">toDate</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">notNull</span><span class="p">:</span>
                    <span class="n">thisValue</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QDate</span><span class="o">.</span><span class="n">currentDate</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">thisValue</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">QGis</span><span class="o">.</span><span class="n">QGIS_VERSION_INT</span> <span class="o">&gt;=</span> <span class="mi">10900</span><span class="p">:</span>
                <span class="n">thisValue</span> <span class="o">=</span> <span class="n">feature</span><span class="p">[</span><span class="n">fieldIndex</span><span class="p">]</span><span class="o">.</span><span class="n">toDate</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">thisValue</span> <span class="o">=</span> <span class="n">feature</span><span class="o">.</span><span class="n">attributeMap</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">fieldIndex</span><span class="p">)</span><span class="o">.</span><span class="n">toDate</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">thisValue</span>
</div>
<div class="viewcode-block" id="DdDateEdit.createInputWidget"><a class="viewcode-back" href="../autodoc.html#ddui.DdDateEdit.createInputWidget">[docs]</a>    <span class="k">def</span> <span class="nf">createInputWidget</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">parent</span><span class="p">):</span>
        <span class="n">inputWidget</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QDateEdit</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
        <span class="n">inputWidget</span><span class="o">.</span><span class="n">setCalendarPopup</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">inputWidget</span><span class="o">.</span><span class="n">setDisplayFormat</span><span class="p">(</span><span class="s">&quot;dd.MM.yyyy&quot;</span><span class="p">)</span>
        <span class="n">inputWidget</span><span class="o">.</span><span class="n">setObjectName</span><span class="p">(</span><span class="s">&quot;dat&quot;</span> <span class="o">+</span> <span class="n">parent</span><span class="o">.</span><span class="n">objectName</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">inputWidget</span><span class="o">.</span><span class="n">setToolTip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">comment</span><span class="p">)</span>
        <span class="n">inputWidget</span><span class="o">.</span><span class="n">dateChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">registerChange</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">inputWidget</span>
</div>
<div class="viewcode-block" id="DdDateEdit.setValue"><a class="viewcode-back" href="../autodoc.html#ddui.DdDateEdit.setValue">[docs]</a>    <span class="k">def</span> <span class="nf">setValue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">thisValue</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">thisValue</span><span class="p">:</span> <span class="c"># i.e. None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inputWidget</span><span class="o">.</span><span class="n">setDate</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QDate</span><span class="o">.</span><span class="n">currentDate</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">chk</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inputWidget</span><span class="o">.</span><span class="n">setDate</span><span class="p">(</span><span class="n">thisValue</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="DdDateEdit.getValue"><a class="viewcode-back" href="../autodoc.html#ddui.DdDateEdit.getValue">[docs]</a>    <span class="k">def</span> <span class="nf">getValue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">chk</span><span class="o">.</span><span class="n">isChecked</span><span class="p">():</span>
            <span class="n">thisValue</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">thisValue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputWidget</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">thisValue</span>
</div></div>
<div class="viewcode-block" id="DdCheckBox"><a class="viewcode-back" href="../autodoc.html#ddui.DdCheckBox">[docs]</a><span class="k">class</span> <span class="nc">DdCheckBox</span><span class="p">(</span><span class="n">DdLineEdit</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;QCheckBox for a boolean field&#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">attribute</span><span class="p">):</span>
        <span class="n">DdLineEdit</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">attribute</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;&lt;ddui.DdCheckBox </span><span class="si">%s</span><span class="s">&gt;&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

<div class="viewcode-block" id="DdCheckBox.getFeatureValue"><a class="viewcode-back" href="../autodoc.html#ddui.DdCheckBox.getFeatureValue">[docs]</a>    <span class="k">def</span> <span class="nf">getFeatureValue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">layer</span><span class="p">,</span>  <span class="n">feature</span><span class="p">,</span>  <span class="n">db</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;returns a boolean representing the value in this field for this feature&#39;&#39;&#39;</span>

        <span class="n">fieldIndex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getFieldIndex</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">QGis</span><span class="o">.</span><span class="n">QGIS_VERSION_INT</span> <span class="o">&gt;=</span> <span class="mi">10900</span><span class="p">:</span>
            <span class="n">thisValue</span> <span class="o">=</span> <span class="n">feature</span><span class="p">[</span><span class="n">fieldIndex</span><span class="p">]</span><span class="o">.</span><span class="n">toString</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">thisValue</span> <span class="o">=</span> <span class="n">feature</span><span class="o">.</span><span class="n">attributeMap</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">fieldIndex</span><span class="p">)</span><span class="o">.</span><span class="n">toString</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">thisValue</span><span class="o">.</span><span class="n">isEmpty</span><span class="p">():</span>
            <span class="n">thisValue</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">elif</span> <span class="n">thisValue</span> <span class="o">==</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QString</span><span class="p">(</span><span class="s">&quot;f&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">thisValue</span> <span class="o">==</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QString</span><span class="p">(</span><span class="s">&quot;false&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">thisValue</span> <span class="o">==</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QString</span><span class="p">(</span><span class="s">&quot;False&quot;</span><span class="p">):</span>
            <span class="n">thisValue</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">thisValue</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">if</span> <span class="n">feature</span><span class="o">.</span><span class="n">id</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">thisValue</span><span class="p">:</span> <span class="c"># new feature and no value set</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">hasDefault</span><span class="p">:</span>
                <span class="n">thisValue</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QVariant</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">default</span><span class="p">)</span><span class="o">.</span><span class="n">toBool</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">thisValue</span>
</div>
<div class="viewcode-block" id="DdCheckBox.createInputWidget"><a class="viewcode-back" href="../autodoc.html#ddui.DdCheckBox.createInputWidget">[docs]</a>    <span class="k">def</span> <span class="nf">createInputWidget</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">parent</span><span class="p">):</span>
        <span class="n">inputWidget</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QCheckBox</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
        <span class="n">inputWidget</span><span class="o">.</span><span class="n">setObjectName</span><span class="p">(</span><span class="s">&quot;chk&quot;</span> <span class="o">+</span> <span class="n">parent</span><span class="o">.</span><span class="n">objectName</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">inputWidget</span><span class="o">.</span><span class="n">stateChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">registerChange</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">inputWidget</span>
</div>
<div class="viewcode-block" id="DdCheckBox.setValue"><a class="viewcode-back" href="../autodoc.html#ddui.DdCheckBox.setValue">[docs]</a>    <span class="k">def</span> <span class="nf">setValue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">thisValue</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">None</span> <span class="o">==</span> <span class="n">thisValue</span><span class="p">:</span> <span class="c">#handle Null values</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inputWidget</span><span class="o">.</span><span class="n">setTristate</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inputWidget</span><span class="o">.</span><span class="n">setCheckState</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inputWidget</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="n">thisValue</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="DdCheckBox.stateChanged"><a class="viewcode-back" href="../autodoc.html#ddui.DdCheckBox.stateChanged">[docs]</a>    <span class="k">def</span> <span class="nf">stateChanged</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">newState</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputWidget</span><span class="o">.</span><span class="n">isTristate</span><span class="p">()</span> <span class="ow">and</span> <span class="n">newState</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inputWidget</span><span class="o">.</span><span class="n">setTristate</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="DdCheckBox.getValue"><a class="viewcode-back" href="../autodoc.html#ddui.DdCheckBox.getValue">[docs]</a>    <span class="k">def</span> <span class="nf">getValue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputWidget</span><span class="o">.</span><span class="n">checkState</span><span class="p">()</span>
        <span class="c">#QtGui.QMessageBox.information(None, &quot;&quot;, str(state))</span>
        <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">thisValue</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">thisValue</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">thisValue</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">return</span> <span class="n">thisValue</span>
</div>
<div class="viewcode-block" id="DdCheckBox.checkInput"><a class="viewcode-back" href="../autodoc.html#ddui.DdCheckBox.checkInput">[docs]</a>    <span class="k">def</span> <span class="nf">checkInput</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">thisValue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getValue</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">notNull</span> <span class="ow">and</span> <span class="n">thisValue</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">QtGui</span><span class="o">.</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">text</span><span class="p">(),</span>  <span class="n">QtGui</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s">&quot;DdWarning&quot;</span><span class="p">,</span> <span class="s">&quot;Field must not be empty!&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span>
                                                           <span class="n">QtGui</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">UnicodeUTF8</span><span class="p">)</span> <span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
</div></div>
<div class="viewcode-block" id="DdTextEdit"><a class="viewcode-back" href="../autodoc.html#ddui.DdTextEdit">[docs]</a><span class="k">class</span> <span class="nc">DdTextEdit</span><span class="p">(</span><span class="n">DdLineEdit</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;QTextEdit  for a text field&#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">attribute</span><span class="p">):</span>
        <span class="n">DdLineEdit</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">attribute</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;&lt;ddui.DdTextEdit </span><span class="si">%s</span><span class="s">&gt;&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

<div class="viewcode-block" id="DdTextEdit.registerChange"><a class="viewcode-back" href="../autodoc.html#ddui.DdTextEdit.registerChange">[docs]</a>    <span class="k">def</span> <span class="nf">registerChange</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hasChanges</span> <span class="o">=</span> <span class="bp">True</span>
    </div>
<div class="viewcode-block" id="DdTextEdit.createInputWidget"><a class="viewcode-back" href="../autodoc.html#ddui.DdTextEdit.createInputWidget">[docs]</a>    <span class="k">def</span> <span class="nf">createInputWidget</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">parent</span><span class="p">):</span>
        <span class="n">inputWidget</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QTextEdit</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
        <span class="n">inputWidget</span><span class="o">.</span><span class="n">setObjectName</span><span class="p">(</span><span class="s">&quot;txt&quot;</span> <span class="o">+</span> <span class="n">parent</span><span class="o">.</span><span class="n">objectName</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">inputWidget</span><span class="o">.</span><span class="n">textChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">registerChange</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">inputWidget</span>
</div>
<div class="viewcode-block" id="DdTextEdit.setValue"><a class="viewcode-back" href="../autodoc.html#ddui.DdTextEdit.setValue">[docs]</a>    <span class="k">def</span> <span class="nf">setValue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">thisValue</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">thisValue</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">chk</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">inputWidget</span><span class="o">.</span><span class="n">setPlainText</span><span class="p">(</span><span class="n">thisValue</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="DdTextEdit.getValue"><a class="viewcode-back" href="../autodoc.html#ddui.DdTextEdit.getValue">[docs]</a>    <span class="k">def</span> <span class="nf">getValue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">thisValue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputWidget</span><span class="o">.</span><span class="n">toPlainText</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">thisValue</span><span class="o">.</span><span class="n">isEmpty</span><span class="p">():</span>
            <span class="n">thisValue</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">return</span> <span class="n">thisValue</span>
</div></div>
<div class="viewcode-block" id="DdN2mWidget"><a class="viewcode-back" href="../autodoc.html#ddui.DdN2mWidget">[docs]</a><span class="k">class</span> <span class="nc">DdN2mWidget</span><span class="p">(</span><span class="n">DdInputWidget</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">attribute</span><span class="p">):</span>
        <span class="n">DdInputWidget</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">attribute</span><span class="p">)</span>

<div class="viewcode-block" id="DdN2mWidget.setupUi"><a class="viewcode-back" href="../autodoc.html#ddui.DdN2mWidget.setupUi">[docs]</a>    <span class="k">def</span> <span class="nf">setupUi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">parent</span><span class="p">,</span>  <span class="n">db</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;setup the label and add the inputWidget to parents formLayout&#39;&#39;&#39;</span>
        <span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">createLabel</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputWidget</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">createInputWidget</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputWidget</span><span class="o">.</span><span class="n">setToolTip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">comment</span><span class="p">)</span>
        <span class="n">parent</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addRow</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="n">parent</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addRow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputWidget</span><span class="p">)</span>
</div></div>
<div class="viewcode-block" id="DdN2mListWidget"><a class="viewcode-back" href="../autodoc.html#ddui.DdN2mListWidget">[docs]</a><span class="k">class</span> <span class="nc">DdN2mListWidget</span><span class="p">(</span><span class="n">DdN2mWidget</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;a clickable list widget for simple n2m relations&#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">attribute</span><span class="p">):</span>
        <span class="n">DdN2mWidget</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">attribute</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;&lt;ddui.DdN2mListWidget </span><span class="si">%s</span><span class="s">&gt;&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

<div class="viewcode-block" id="DdN2mListWidget.registerChange"><a class="viewcode-back" href="../autodoc.html#ddui.DdN2mListWidget.registerChange">[docs]</a>    <span class="k">def</span> <span class="nf">registerChange</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">thisItem</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hasChanges</span> <span class="o">=</span> <span class="bp">True</span>
        </div>
<div class="viewcode-block" id="DdN2mListWidget.createInputWidget"><a class="viewcode-back" href="../autodoc.html#ddui.DdN2mListWidget.createInputWidget">[docs]</a>    <span class="k">def</span> <span class="nf">createInputWidget</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">parent</span><span class="p">):</span>
        <span class="n">inputWidget</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QListWidget</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span> <span class="c"># defaultInputWidget</span>
        <span class="n">inputWidget</span><span class="o">.</span><span class="n">setObjectName</span><span class="p">(</span><span class="s">&quot;lst&quot;</span> <span class="o">+</span> <span class="n">parent</span><span class="o">.</span><span class="n">objectName</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">inputWidget</span><span class="o">.</span><span class="n">itemChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">registerChange</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">inputWidget</span>
</div>
<div class="viewcode-block" id="DdN2mListWidget.initialize"><a class="viewcode-back" href="../autodoc.html#ddui.DdN2mListWidget.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">layer</span><span class="p">,</span>  <span class="n">feature</span><span class="p">,</span>  <span class="n">db</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">QtSql</span><span class="o">.</span><span class="n">QSqlQuery</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
        <span class="n">query</span><span class="o">.</span><span class="n">prepare</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">displayStatement</span><span class="p">)</span>
        <span class="n">query</span><span class="o">.</span><span class="n">bindValue</span><span class="p">(</span><span class="s">&quot;:featureId&quot;</span><span class="p">,</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QVariant</span><span class="p">(</span><span class="n">feature</span><span class="o">.</span><span class="n">id</span><span class="p">()))</span>
        <span class="n">query</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">isActive</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inputWidget</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

            <span class="k">while</span> <span class="n">query</span><span class="o">.</span><span class="n">next</span><span class="p">():</span> <span class="c"># returns false when all records are done</span>
                <span class="n">parentId</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">toString</span><span class="p">())</span>
                <span class="n">parent</span> <span class="o">=</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">toString</span><span class="p">())</span>
                <span class="n">checked</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">toString</span><span class="p">())</span>
                <span class="n">parentItem</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QListWidgetItem</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QString</span><span class="p">(</span><span class="n">parent</span><span class="p">))</span>
                <span class="n">parentItem</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">parentId</span>
                <span class="n">parentItem</span><span class="o">.</span><span class="n">setCheckState</span><span class="p">(</span><span class="n">checked</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inputWidget</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">parentItem</span><span class="p">)</span>
            <span class="n">query</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">DbError</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="DdN2mListWidget.save"><a class="viewcode-back" href="../autodoc.html#ddui.DdN2mListWidget.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">layer</span><span class="p">,</span>  <span class="n">feature</span><span class="p">,</span>  <span class="n">db</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hasChanges</span><span class="p">:</span>
            <span class="n">featureId</span> <span class="o">=</span> <span class="n">feature</span><span class="o">.</span><span class="n">id</span><span class="p">()</span>
            <span class="n">deleteQuery</span> <span class="o">=</span> <span class="n">QtSql</span><span class="o">.</span><span class="n">QSqlQuery</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
            <span class="n">deleteQuery</span><span class="o">.</span><span class="n">prepare</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">deleteStatement</span><span class="p">)</span>
            <span class="n">deleteQuery</span><span class="o">.</span><span class="n">bindValue</span><span class="p">(</span><span class="s">&quot;:featureId&quot;</span><span class="p">,</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QVariant</span><span class="p">(</span><span class="n">featureId</span><span class="p">))</span>
            <span class="n">deleteQuery</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">deleteQuery</span><span class="o">.</span><span class="n">isActive</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputWidget</span><span class="o">.</span><span class="n">count</span><span class="p">()):</span>
                    <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputWidget</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">checkState</span><span class="p">()</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">featureId</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">QtGui</span><span class="o">.</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">information</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span>  <span class="s">&quot;&quot;</span><span class="p">,</span>  <span class="n">QtGui</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s">&quot;DdInfo&quot;</span><span class="p">,</span> <span class="s">&quot;n-to-m relation for new feature cannot be saved&quot;</span><span class="p">,</span>
                                                                                                  <span class="bp">None</span><span class="p">,</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">UnicodeUTF8</span><span class="p">)</span> <span class="p">)</span>
                            <span class="k">break</span>

                        <span class="n">itemId</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">id</span>
                        <span class="n">insertQuery</span> <span class="o">=</span> <span class="n">QtSql</span><span class="o">.</span><span class="n">QSqlQuery</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
                        <span class="n">insertQuery</span><span class="o">.</span><span class="n">prepare</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">insertStatement</span><span class="p">)</span>
                        <span class="n">insertQuery</span><span class="o">.</span><span class="n">bindValue</span><span class="p">(</span><span class="s">&quot;:featureId&quot;</span><span class="p">,</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QVariant</span><span class="p">(</span><span class="n">featureId</span><span class="p">))</span>
                        <span class="n">insertQuery</span><span class="o">.</span><span class="n">bindValue</span><span class="p">(</span><span class="s">&quot;:itemId&quot;</span><span class="p">,</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QVariant</span><span class="p">(</span><span class="n">itemId</span><span class="p">))</span>
                        <span class="n">insertQuery</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span>

                        <span class="k">if</span> <span class="n">insertQuery</span><span class="o">.</span><span class="n">isActive</span><span class="p">():</span>
                            <span class="n">insertQuery</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">DbError</span><span class="p">(</span><span class="n">insertQuery</span><span class="p">)</span>
                            <span class="k">return</span> <span class="bp">False</span>

                <span class="n">deleteQuery</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
                <span class="k">return</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">DbError</span><span class="p">(</span><span class="n">deleteQuery</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
</div></div>
<div class="viewcode-block" id="DdN2mTreeWidget"><a class="viewcode-back" href="../autodoc.html#ddui.DdN2mTreeWidget">[docs]</a><span class="k">class</span> <span class="nc">DdN2mTreeWidget</span><span class="p">(</span><span class="n">DdN2mWidget</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;a clickable tree widget for simple n2m relations&#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">attribute</span><span class="p">):</span>
        <span class="n">DdN2mWidget</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">attribute</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;&lt;ddui.DdN2mTreeWidget </span><span class="si">%s</span><span class="s">&gt;&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

<div class="viewcode-block" id="DdN2mTreeWidget.registerChange"><a class="viewcode-back" href="../autodoc.html#ddui.DdN2mTreeWidget.registerChange">[docs]</a>    <span class="k">def</span> <span class="nf">registerChange</span><span class="p">(</span><span class="n">selfthisItem</span><span class="p">,</span>  <span class="n">thisColumn</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">thisColumn</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hasChanges</span> <span class="o">=</span> <span class="bp">True</span>
            </div>
<div class="viewcode-block" id="DdN2mTreeWidget.createInputWidget"><a class="viewcode-back" href="../autodoc.html#ddui.DdN2mTreeWidget.createInputWidget">[docs]</a>    <span class="k">def</span> <span class="nf">createInputWidget</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">parent</span><span class="p">):</span>
        <span class="n">inputWidget</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QTreeWidget</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
        <span class="n">inputWidget</span><span class="o">.</span><span class="n">setEditTriggers</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QAbstractItemView</span><span class="o">.</span><span class="n">NoEditTriggers</span><span class="p">)</span>
        <span class="n">inputWidget</span><span class="o">.</span><span class="n">setHeaderHidden</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">inputWidget</span><span class="o">.</span><span class="n">setColumnCount</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">inputWidget</span><span class="o">.</span><span class="n">setObjectName</span><span class="p">(</span><span class="s">&quot;tre&quot;</span> <span class="o">+</span> <span class="n">parent</span><span class="o">.</span><span class="n">objectName</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">inputWidget</span><span class="o">.</span><span class="n">itemChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">registerChange</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">inputWidget</span>
</div>
<div class="viewcode-block" id="DdN2mTreeWidget.initialize"><a class="viewcode-back" href="../autodoc.html#ddui.DdN2mTreeWidget.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">layer</span><span class="p">,</span>  <span class="n">feature</span><span class="p">,</span>  <span class="n">db</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">QtSql</span><span class="o">.</span><span class="n">QSqlQuery</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
        <span class="n">query</span><span class="o">.</span><span class="n">prepare</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">displayStatement</span><span class="p">)</span>
        <span class="n">query</span><span class="o">.</span><span class="n">bindValue</span><span class="p">(</span><span class="s">&quot;:featureId&quot;</span><span class="p">,</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QVariant</span><span class="p">(</span><span class="n">feature</span><span class="o">.</span><span class="n">id</span><span class="p">()))</span>
        <span class="n">query</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">isActive</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inputWidget</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

            <span class="k">while</span> <span class="n">query</span><span class="o">.</span><span class="n">next</span><span class="p">():</span> <span class="c"># returns false when all records are done</span>
                <span class="n">parentId</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">toString</span><span class="p">())</span>
                <span class="n">parent</span> <span class="o">=</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">toString</span><span class="p">())</span>
                <span class="n">checked</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">toString</span><span class="p">())</span>
                <span class="n">parentItem</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QTreeWidgetItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputWidget</span><span class="p">)</span>
                <span class="n">parentItem</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">parentId</span>
                <span class="n">parentItem</span><span class="o">.</span><span class="n">setCheckState</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span>  <span class="n">checked</span><span class="p">)</span>
                <span class="n">parentItem</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span>  <span class="n">QtCore</span><span class="o">.</span><span class="n">QString</span><span class="p">(</span><span class="n">parent</span><span class="p">))</span>

                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">fieldList</span><span class="p">)):</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">val</span><span class="o">.</span><span class="n">isValid</span><span class="p">():</span>
                        <span class="n">childItem</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QTreeWidgetItem</span><span class="p">(</span><span class="n">parentItem</span><span class="p">)</span>
                        <span class="n">childItem</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span>  <span class="n">val</span><span class="o">.</span><span class="n">toString</span><span class="p">())</span>
                        <span class="n">parentItem</span><span class="o">.</span><span class="n">addChild</span><span class="p">(</span><span class="n">childItem</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span> <span class="c"># no more fields left</span>
                        <span class="k">break</span>

                <span class="n">parentItem</span><span class="o">.</span><span class="n">setExpanded</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inputWidget</span><span class="o">.</span><span class="n">addTopLevelItem</span><span class="p">(</span><span class="n">parentItem</span><span class="p">)</span>
            <span class="n">query</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">DbError</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="DdN2mTreeWidget.save"><a class="viewcode-back" href="../autodoc.html#ddui.DdN2mTreeWidget.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">layer</span><span class="p">,</span>  <span class="n">feature</span><span class="p">,</span>  <span class="n">db</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hasChanges</span><span class="p">:</span>
            <span class="n">featureId</span> <span class="o">=</span> <span class="n">feature</span><span class="o">.</span><span class="n">id</span><span class="p">()</span>
            <span class="n">deleteQuery</span> <span class="o">=</span> <span class="n">QtSql</span><span class="o">.</span><span class="n">QSqlQuery</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
            <span class="n">deleteQuery</span><span class="o">.</span><span class="n">prepare</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">deleteStatement</span><span class="p">)</span>
            <span class="n">deleteQuery</span><span class="o">.</span><span class="n">bindValue</span><span class="p">(</span><span class="s">&quot;:featureId&quot;</span><span class="p">,</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QVariant</span><span class="p">(</span><span class="n">featureId</span><span class="p">))</span>
            <span class="n">deleteQuery</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">deleteQuery</span><span class="o">.</span><span class="n">isActive</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputWidget</span><span class="o">.</span><span class="n">topLevelItemCount</span><span class="p">()):</span>
                    <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputWidget</span><span class="o">.</span><span class="n">topLevelItem</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">checkState</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">featureId</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">QtGui</span><span class="o">.</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">information</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span>  <span class="s">&quot;&quot;</span><span class="p">,</span>  <span class="n">QtGui</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s">&quot;DdInfo&quot;</span><span class="p">,</span> <span class="s">&quot;n-to-m relation for new feature cannot be saved&quot;</span><span class="p">,</span>
                                                                                                  <span class="bp">None</span><span class="p">,</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">UnicodeUTF8</span><span class="p">)</span> <span class="p">)</span>
                            <span class="k">break</span>

                        <span class="n">itemId</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">id</span>
                        <span class="n">insertQuery</span> <span class="o">=</span> <span class="n">QtSql</span><span class="o">.</span><span class="n">QSqlQuery</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
                        <span class="n">insertQuery</span><span class="o">.</span><span class="n">prepare</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">insertStatement</span><span class="p">)</span>
                        <span class="n">insertQuery</span><span class="o">.</span><span class="n">bindValue</span><span class="p">(</span><span class="s">&quot;:featureId&quot;</span><span class="p">,</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QVariant</span><span class="p">(</span><span class="n">featureId</span><span class="p">))</span>
                        <span class="n">insertQuery</span><span class="o">.</span><span class="n">bindValue</span><span class="p">(</span><span class="s">&quot;:itemId&quot;</span><span class="p">,</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QVariant</span><span class="p">(</span><span class="n">itemId</span><span class="p">))</span>
                        <span class="n">insertQuery</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span>

                        <span class="k">if</span> <span class="n">insertQuery</span><span class="o">.</span><span class="n">isActive</span><span class="p">():</span>
                            <span class="n">insertQuery</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">DbError</span><span class="p">(</span><span class="n">insertQuery</span><span class="p">)</span>
                            <span class="k">return</span> <span class="bp">False</span>

                <span class="n">deleteQuery</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
                <span class="k">return</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">DbError</span><span class="p">(</span><span class="n">deleteQuery</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
</div></div>
<div class="viewcode-block" id="DdN2mTableWidget"><a class="viewcode-back" href="../autodoc.html#ddui.DdN2mTableWidget">[docs]</a><span class="k">class</span> <span class="nc">DdN2mTableWidget</span><span class="p">(</span><span class="n">DdN2mWidget</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;a table&#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">attribute</span><span class="p">):</span>
        <span class="n">DdN2mWidget</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">attribute</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fkValues</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tableLayer</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;&lt;ddui.DdN2mTableWidget </span><span class="si">%s</span><span class="s">&gt;&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

<div class="viewcode-block" id="DdN2mTableWidget.createInputWidget"><a class="viewcode-back" href="../autodoc.html#ddui.DdN2mTableWidget.createInputWidget">[docs]</a>    <span class="k">def</span> <span class="nf">createInputWidget</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">parent</span><span class="p">):</span>
        <span class="n">inputWidget</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QTableWidget</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
        <span class="n">inputWidget</span><span class="o">.</span><span class="n">setEditTriggers</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QAbstractItemView</span><span class="o">.</span><span class="n">NoEditTriggers</span><span class="p">)</span>
        <span class="n">inputWidget</span><span class="o">.</span><span class="n">setColumnCount</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">attributes</span><span class="p">))</span>
        <span class="n">fieldNames</span> <span class="o">=</span>  <span class="p">[]</span>

        <span class="k">for</span> <span class="n">anAtt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">attributes</span><span class="p">:</span>
            <span class="n">fieldNames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">anAtt</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">horizontalHeaders</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QStringList</span><span class="p">(</span><span class="n">fieldNames</span><span class="p">)</span>

        <span class="n">inputWidget</span><span class="o">.</span><span class="n">setHorizontalHeaderLabels</span><span class="p">(</span><span class="n">horizontalHeaders</span><span class="p">)</span>
        <span class="n">inputWidget</span><span class="o">.</span><span class="n">setSelectionMode</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QAbstractItemView</span><span class="o">.</span><span class="n">SingleSelection</span><span class="p">)</span>
        <span class="n">inputWidget</span><span class="o">.</span><span class="n">setSelectionBehavior</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QAbstractItemView</span><span class="o">.</span><span class="n">SelectRows</span><span class="p">)</span>
        <span class="n">inputWidget</span><span class="o">.</span><span class="n">setEditTriggers</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QAbstractItemView</span><span class="o">.</span><span class="n">NoEditTriggers</span><span class="p">)</span>
        <span class="n">inputWidget</span><span class="o">.</span><span class="n">setSortingEnabled</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">inputWidget</span><span class="o">.</span><span class="n">cellDoubleClicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">doubleClick</span><span class="p">)</span>
        <span class="n">inputWidget</span><span class="o">.</span><span class="n">itemSelectionChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selectionChanged</span><span class="p">)</span>
        <span class="n">inputWidget</span><span class="o">.</span><span class="n">setObjectName</span><span class="p">(</span><span class="s">&quot;tbl&quot;</span> <span class="o">+</span> <span class="n">parent</span><span class="o">.</span><span class="n">objectName</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">inputWidget</span>
</div>
<div class="viewcode-block" id="DdN2mTableWidget.createFeature"><a class="viewcode-back" href="../autodoc.html#ddui.DdN2mTableWidget.createFeature">[docs]</a>    <span class="k">def</span> <span class="nf">createFeature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fid</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">fid</span><span class="p">:</span>
            <span class="n">newFeature</span> <span class="o">=</span> <span class="n">QgsFeature</span><span class="p">(</span><span class="n">fid</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">newFeature</span> <span class="o">=</span> <span class="n">QgsFeature</span><span class="p">()</span> <span class="c"># gid wird automatisch vergeben</span>
        
        <span class="n">provider</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tableLayer</span><span class="o">.</span><span class="n">dataProvider</span><span class="p">()</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tableLayer</span><span class="o">.</span><span class="n">pendingFields</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">QGis</span><span class="o">.</span><span class="n">QGIS_VERSION_INT</span> <span class="o">&gt;=</span> <span class="mi">10900</span><span class="p">:</span>
            <span class="n">newFeature</span><span class="o">.</span><span class="n">initAttributes</span><span class="p">(</span><span class="n">fields</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>			
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">fields</span><span class="o">.</span><span class="n">count</span><span class="p">()):</span>
                <span class="n">newFeature</span><span class="o">.</span><span class="n">setAttribute</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">provider</span><span class="o">.</span><span class="n">defaultValue</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
                <span class="n">newFeature</span><span class="o">.</span><span class="n">addAttribute</span><span class="p">(</span><span class="n">i</span><span class="p">,</span>  <span class="n">provider</span><span class="o">.</span><span class="n">defaultValue</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">newFeature</span>
</div>
<div class="viewcode-block" id="DdN2mTableWidget.initialize"><a class="viewcode-back" href="../autodoc.html#ddui.DdN2mTableWidget.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">layer</span><span class="p">,</span>  <span class="n">feature</span><span class="p">,</span>  <span class="n">db</span><span class="p">):</span>
        <span class="c">#self.inputWidget.clear()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">featureId</span> <span class="o">=</span> <span class="n">feature</span><span class="o">.</span><span class="n">id</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">featureId</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">forEdit</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addButton</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">forEdit</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">isEditable</span><span class="p">()</span>
            <span class="c"># read the values for any foreignKeys</span>
            <span class="k">for</span> <span class="n">anAtt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">attributes</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">anAtt</span><span class="o">.</span><span class="n">isFK</span><span class="p">:</span>
                    <span class="n">values</span> <span class="o">=</span> <span class="p">{}</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">anAtt</span><span class="o">.</span><span class="n">notNull</span><span class="p">:</span>
                        <span class="n">values</span><span class="p">[</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QString</span><span class="p">()]</span> <span class="o">=</span> <span class="bp">None</span>

                    <span class="n">query</span> <span class="o">=</span> <span class="n">QtSql</span><span class="o">.</span><span class="n">QSqlQuery</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
                    <span class="n">query</span><span class="o">.</span><span class="n">prepare</span><span class="p">(</span><span class="n">anAtt</span><span class="o">.</span><span class="n">queryForCbx</span><span class="p">)</span>
                    <span class="n">query</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span>

                    <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">isActive</span><span class="p">():</span>
                        <span class="k">while</span> <span class="n">query</span><span class="o">.</span><span class="n">next</span><span class="p">():</span> <span class="c"># returns false when all records are done</span>
                            <span class="n">sValue</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QString</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">toString</span><span class="p">())</span>
                            <span class="n">keyValue</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">toString</span><span class="p">()</span>
                            <span class="n">values</span><span class="p">[</span><span class="n">keyValue</span><span class="p">]</span> <span class="o">=</span> <span class="n">sValue</span>
                        <span class="n">query</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">DbError</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">fkValues</span><span class="p">[</span><span class="n">anAtt</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span>

            <span class="c"># reduce the features in self.tableLayer to those related to feature</span>
            <span class="n">subsetString</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QString</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">subsetString</span><span class="p">))</span>
            <span class="n">subsetString</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QString</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">featureId</span><span class="p">)))</span>
            <span class="c">#QtGui.QMessageBox.information(None, &quot;&quot;,  subsetString + &quot;\n&quot; + self.attribute.name)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tableLayer</span><span class="o">.</span><span class="n">setSubsetString</span><span class="p">(</span><span class="n">subsetString</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tableLayer</span><span class="o">.</span><span class="n">reload</span><span class="p">()</span>
            <span class="c"># display the features in the QTableWidget</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tableLayer</span><span class="o">.</span><span class="n">removeSelection</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tableLayer</span><span class="o">.</span><span class="n">invertSelection</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">aFeat</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tableLayer</span><span class="o">.</span><span class="n">selectedFeatures</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">appendRow</span><span class="p">(</span><span class="n">aFeat</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">tableLayer</span><span class="o">.</span><span class="n">removeSelection</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">forEdit</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">forEdit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tableLayer</span><span class="o">.</span><span class="n">startEditing</span><span class="p">()</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">forEdit</span><span class="p">:</span>
                    <span class="n">QtGui</span><span class="o">.</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Warning</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span>  <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s">&quot;DdInfo&quot;</span><span class="p">,</span> <span class="s">&quot;Layer cannot be edited: &quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span>
                                                               <span class="n">QtGui</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">UnicodeUTF8</span><span class="p">)</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tableLayer</span><span class="o">.</span><span class="n">name</span><span class="p">()))</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">forEdit</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">maxRows</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">addButton</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputWidget</span><span class="o">.</span><span class="n">rowCount</span><span class="p">()</span>  <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">maxRows</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">addButton</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="DdN2mTableWidget.fillRow"><a class="viewcode-back" href="../autodoc.html#ddui.DdN2mTableWidget.fillRow">[docs]</a>    <span class="k">def</span> <span class="nf">fillRow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">thisRow</span><span class="p">,</span> <span class="n">thisFeature</span><span class="p">):</span>
        <span class="c">#QtGui.QMessageBox.information(None,&#39;&#39;,str(thisRow))</span>
        <span class="k">if</span> <span class="n">QGis</span><span class="o">.</span><span class="n">QGIS_VERSION_INT</span> <span class="o">&lt;</span> <span class="mi">10900</span><span class="p">:</span>
            <span class="n">attMap</span> <span class="o">=</span> <span class="n">thisFeature</span><span class="o">.</span><span class="n">attributeMap</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">attributes</span><span class="p">)):</span>
            <span class="n">anAtt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">QGis</span><span class="o">.</span><span class="n">QGIS_VERSION_INT</span> <span class="o">&gt;=</span> <span class="mi">10900</span><span class="p">:</span>
                <span class="n">aValue</span> <span class="o">=</span> <span class="n">thisFeature</span><span class="p">[</span><span class="n">anAtt</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">toString</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">aValue</span> <span class="o">=</span> <span class="n">attMap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tableLayer</span><span class="o">.</span><span class="n">fieldNameIndex</span><span class="p">(</span><span class="n">anAtt</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>  <span class="s">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">toString</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">anAtt</span><span class="o">.</span><span class="n">isFK</span><span class="p">:</span>
                <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fkValues</span><span class="p">[</span><span class="n">anAtt</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
                <span class="n">aValue</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">aValue</span><span class="p">]</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">aValue</span><span class="p">:</span> <span class="c"># i.e. aVAlue == None</span>
                    <span class="n">aValue</span> <span class="o">=</span> <span class="s">&#39;NULL&#39;</span>

            <span class="n">item</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QTableWidgetItem</span><span class="p">(</span><span class="n">aValue</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">item</span><span class="o">.</span><span class="n">feature</span> <span class="o">=</span> <span class="n">thisFeature</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">inputWidget</span><span class="o">.</span><span class="n">setItem</span><span class="p">(</span><span class="n">thisRow</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="DdN2mTableWidget.appendRow"><a class="viewcode-back" href="../autodoc.html#ddui.DdN2mTableWidget.appendRow">[docs]</a>    <span class="k">def</span> <span class="nf">appendRow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">thisFeature</span><span class="p">):</span>
        <span class="n">thisRow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputWidget</span><span class="o">.</span><span class="n">rowCount</span><span class="p">()</span> <span class="c"># identical with index of row to be appended as row indices are 0 based</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputWidget</span><span class="o">.</span><span class="n">setRowCount</span><span class="p">(</span><span class="n">thisRow</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="c"># append a row</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fillRow</span><span class="p">(</span><span class="n">thisRow</span><span class="p">,</span> <span class="n">thisFeature</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="DdN2mTableWidget.save"><a class="viewcode-back" href="../autodoc.html#ddui.DdN2mTableWidget.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">layer</span><span class="p">,</span>  <span class="n">feature</span><span class="p">,</span>  <span class="n">db</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hasChanges</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tableLayer</span><span class="o">.</span><span class="n">isEditable</span><span class="p">():</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tableLayer</span><span class="o">.</span><span class="n">isModified</span><span class="p">():</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tableLayer</span><span class="o">.</span><span class="n">commitChanges</span><span class="p">():</span>
                        <span class="k">return</span> <span class="bp">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">DdError</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s">&quot;DdError&quot;</span><span class="p">,</span> <span class="s">&quot;Could not save changes to layer: &quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span>
                                                                   <span class="n">QtGui</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">UnicodeUTF8</span><span class="p">)</span> <span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tableLayer</span><span class="o">.</span><span class="n">name</span><span class="p">()))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">discard</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="DdN2mTableWidget.discard"><a class="viewcode-back" href="../autodoc.html#ddui.DdN2mTableWidget.discard">[docs]</a>    <span class="k">def</span> <span class="nf">discard</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tableLayer</span><span class="o">.</span><span class="n">isEditable</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">tableLayer</span><span class="o">.</span><span class="n">rollBack</span><span class="p">():</span>
                <span class="n">DdError</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s">&quot;DdError&quot;</span><span class="p">,</span> <span class="s">&quot;Could not discard changes for layer:&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span>
                                                   <span class="n">QtGui</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">UnicodeUTF8</span><span class="p">)</span><span class="o">.</span><span class="n">appned</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tableLayer</span><span class="o">.</span><span class="n">name</span><span class="p">()))</span>
                <span class="k">return</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="DdN2mTableWidget.setupUi"><a class="viewcode-back" href="../autodoc.html#ddui.DdN2mTableWidget.setupUi">[docs]</a>    <span class="k">def</span> <span class="nf">setupUi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">parent</span><span class="p">,</span>  <span class="n">db</span><span class="p">):</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QFrame</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
        <span class="n">frame</span><span class="o">.</span><span class="n">setFrameShape</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QFrame</span><span class="o">.</span><span class="n">StyledPanel</span><span class="p">)</span>
        <span class="n">frame</span><span class="o">.</span><span class="n">setFrameShadow</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QFrame</span><span class="o">.</span><span class="n">Raised</span><span class="p">)</span>
        <span class="n">frame</span><span class="o">.</span><span class="n">setObjectName</span><span class="p">(</span><span class="s">&quot;frame&quot;</span> <span class="o">+</span> <span class="n">parent</span><span class="o">.</span><span class="n">objectName</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">createLabel</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputWidget</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">createInputWidget</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputWidget</span><span class="o">.</span><span class="n">setToolTip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">comment</span><span class="p">)</span>
        <span class="n">verticalLayout</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QVBoxLayout</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
        <span class="n">verticalLayout</span><span class="o">.</span><span class="n">setObjectName</span><span class="p">(</span><span class="s">&quot;vlayout&quot;</span> <span class="o">+</span> <span class="n">parent</span><span class="o">.</span><span class="n">objectName</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">horizontalLayout</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QHBoxLayout</span><span class="p">(</span> <span class="p">)</span>
        <span class="n">horizontalLayout</span><span class="o">.</span><span class="n">setObjectName</span><span class="p">(</span><span class="s">&quot;hlayout&quot;</span> <span class="o">+</span> <span class="n">parent</span><span class="o">.</span><span class="n">objectName</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">horizontalLayout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="n">spacerItem</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QSpacerItem</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Minimum</span><span class="p">)</span>
        <span class="n">horizontalLayout</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">spacerItem</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addButton</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QPushButton</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s">&quot;DdInput&quot;</span><span class="p">,</span> <span class="s">&quot;Add&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span>
                                                           <span class="n">QtGui</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">UnicodeUTF8</span><span class="p">)</span> <span class="p">,</span>  <span class="n">frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">removeButton</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QPushButton</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s">&quot;DdInput&quot;</span><span class="p">,</span> <span class="s">&quot;Remove&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span>
                                                           <span class="n">QtGui</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">UnicodeUTF8</span><span class="p">)</span> <span class="p">,</span>  <span class="n">frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addButton</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">removeButton</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remove</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">removeButton</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">horizontalLayout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addButton</span><span class="p">)</span>
        <span class="n">horizontalLayout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">removeButton</span><span class="p">)</span>
        <span class="n">verticalLayout</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">horizontalLayout</span><span class="p">)</span>
        <span class="n">verticalLayout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputWidget</span><span class="p">)</span>
        <span class="n">parent</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addRow</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

        <span class="n">pParent</span> <span class="o">=</span> <span class="n">parent</span>

        <span class="k">while</span> <span class="p">(</span><span class="bp">True</span><span class="p">):</span>
            <span class="n">pParent</span> <span class="o">=</span> <span class="n">pParent</span><span class="o">.</span><span class="n">parentWidget</span><span class="p">()</span>
            <span class="c">#QtGui.QMessageBox.information(None, &quot;pParent&quot;,  str(parent) + &quot;&quot; + str(pParent))</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pParent</span><span class="p">,</span>  <span class="n">DdDialog</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parentDialog</span> <span class="o">=</span> <span class="n">pParent</span>
                <span class="k">break</span>

        <span class="c"># find the layer in the project</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tableLayer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parentDialog</span><span class="o">.</span><span class="n">ddManager</span><span class="o">.</span><span class="n">findPostgresLayer</span><span class="p">(</span><span class="n">db</span><span class="p">,</span>  <span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">table</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">tableLayer</span><span class="p">:</span>
            <span class="c"># load the layer into the project</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tableLayer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parentDialog</span><span class="o">.</span><span class="n">ddManager</span><span class="o">.</span><span class="n">loadPostGISLayer</span><span class="p">(</span><span class="n">db</span><span class="p">,</span>  <span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">table</span><span class="p">)</span>

        <span class="c">#QtGui.QMessageBox.information(None, &quot;setupUi&quot;,  self.attribute.name + &quot;: &quot; + self.tableLayer.name())</span>
        <span class="c"># create a DdUi for the layer without the featureIdField it it has not yet been created</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parentDialog</span><span class="o">.</span><span class="n">ddManager</span><span class="o">.</span><span class="n">ddLayers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tableLayer</span><span class="o">.</span><span class="n">id</span><span class="p">()]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parentDialog</span><span class="o">.</span><span class="n">ddManager</span><span class="o">.</span><span class="n">initLayer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tableLayer</span><span class="p">,</span>  <span class="n">skip</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">relationFeatureIdField</span><span class="p">],</span>  <span class="n">showParents</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">showParents</span><span class="p">)</span>

    <span class="c"># SLOTS</span></div>
<div class="viewcode-block" id="DdN2mTableWidget.selectionChanged"><a class="viewcode-back" href="../autodoc.html#ddui.DdN2mTableWidget.selectionChanged">[docs]</a>    <span class="k">def</span> <span class="nf">selectionChanged</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">removeButton</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputWidget</span><span class="o">.</span><span class="n">selectedItems</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="DdN2mTableWidget.doubleClick"><a class="viewcode-back" href="../autodoc.html#ddui.DdN2mTableWidget.doubleClick">[docs]</a>    <span class="k">def</span> <span class="nf">doubleClick</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">thisRow</span><span class="p">,</span>  <span class="n">thisColumn</span><span class="p">):</span>
        <span class="n">featureItem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputWidget</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="n">thisRow</span><span class="p">,</span>  <span class="mi">0</span><span class="p">)</span>
        <span class="n">thisFeature</span> <span class="o">=</span> <span class="n">featureItem</span><span class="o">.</span><span class="n">feature</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parentDialog</span><span class="o">.</span><span class="n">ddManager</span><span class="o">.</span><span class="n">showFeatureForm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tableLayer</span><span class="p">,</span>  <span class="n">thisFeature</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">result</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c"># user clicked OK</span>
            <span class="c"># make sure user did not change parentFeatureId</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tableLayer</span><span class="o">.</span><span class="n">changeAttributeValue</span><span class="p">(</span><span class="n">thisFeature</span><span class="o">.</span><span class="n">id</span><span class="p">(),</span>  <span class="bp">self</span><span class="o">.</span><span class="n">tableLayer</span><span class="o">.</span><span class="n">fieldNameIndex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">relationFeatureIdField</span><span class="p">),</span>  <span class="n">QtCore</span><span class="o">.</span><span class="n">QVariant</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">featureId</span><span class="p">),</span>  <span class="bp">False</span><span class="p">)</span>
            <span class="c"># refresh thisFeature with the new values</span>
            <span class="k">if</span> <span class="n">QGis</span><span class="o">.</span><span class="n">QGIS_VERSION_INT</span> <span class="o">&gt;=</span> <span class="mi">10900</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tableLayer</span><span class="o">.</span><span class="n">getFeatures</span><span class="p">(</span><span class="n">QgsFeatureRequest</span><span class="p">()</span><span class="o">.</span><span class="n">setFilterFid</span><span class="p">(</span><span class="n">thisFeature</span><span class="o">.</span><span class="n">id</span><span class="p">())</span><span class="o">.</span><span class="n">setFlags</span><span class="p">(</span><span class="n">QgsFeatureRequest</span><span class="o">.</span><span class="n">NoGeometry</span><span class="p">))</span><span class="o">.</span><span class="n">nextFeature</span><span class="p">(</span><span class="n">thisFeature</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tableLayer</span><span class="o">.</span><span class="n">featureAtId</span><span class="p">(</span><span class="n">thisFeature</span><span class="o">.</span><span class="n">id</span><span class="p">(),</span>  <span class="n">thisFeature</span><span class="p">,</span>  <span class="bp">False</span><span class="p">,</span>  <span class="bp">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fillRow</span><span class="p">(</span><span class="n">thisRow</span><span class="p">,</span>  <span class="n">thisFeature</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hasChanges</span> <span class="o">=</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="DdN2mTableWidget.add"><a class="viewcode-back" href="../autodoc.html#ddui.DdN2mTableWidget.add">[docs]</a>    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">thisFeature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">createFeature</span><span class="p">()</span>
        <span class="c"># set the parentFeature&#39;s id</span>
        <span class="k">if</span> <span class="n">QGis</span><span class="o">.</span><span class="n">QGIS_VERSION_INT</span> <span class="o">&gt;=</span> <span class="mi">10900</span><span class="p">:</span>
            <span class="n">thisFeature</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tableLayer</span><span class="o">.</span><span class="n">fieldNameIndex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">relationFeatureIdField</span><span class="p">)]</span> <span class="o">=</span>  <span class="n">QtCore</span><span class="o">.</span><span class="n">QVariant</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">featureId</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">thisFeature</span><span class="o">.</span><span class="n">changeAttribute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tableLayer</span><span class="o">.</span><span class="n">fieldNameIndex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">relationFeatureIdField</span><span class="p">),</span>  <span class="n">QtCore</span><span class="o">.</span><span class="n">QVariant</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">featureId</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tableLayer</span><span class="o">.</span><span class="n">addFeature</span><span class="p">(</span><span class="n">thisFeature</span><span class="p">,</span>  <span class="bp">False</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parentDialog</span><span class="o">.</span><span class="n">ddManager</span><span class="o">.</span><span class="n">showFeatureForm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tableLayer</span><span class="p">,</span>  <span class="n">thisFeature</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">result</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c"># user clicked OK</span>
                <span class="k">if</span> <span class="n">QGis</span><span class="o">.</span><span class="n">QGIS_VERSION_INT</span> <span class="o">&gt;=</span> <span class="mi">10900</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tableLayer</span><span class="o">.</span><span class="n">getFeatures</span><span class="p">(</span><span class="n">QgsFeatureRequest</span><span class="p">()</span><span class="o">.</span><span class="n">setFilterFid</span><span class="p">(</span><span class="n">thisFeature</span><span class="o">.</span><span class="n">id</span><span class="p">())</span><span class="o">.</span><span class="n">setFlags</span><span class="p">(</span><span class="n">QgsFeatureRequest</span><span class="o">.</span><span class="n">NoGeometry</span><span class="p">))</span><span class="o">.</span><span class="n">nextFeature</span><span class="p">(</span><span class="n">thisFeature</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tableLayer</span><span class="o">.</span><span class="n">featureAtId</span><span class="p">(</span><span class="n">thisFeature</span><span class="o">.</span><span class="n">id</span><span class="p">(),</span>  <span class="n">thisFeature</span><span class="p">,</span>  <span class="bp">False</span><span class="p">,</span>  <span class="bp">True</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">appendRow</span><span class="p">(</span><span class="n">thisFeature</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hasChanges</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tableLayer</span><span class="o">.</span><span class="n">deleteFeature</span><span class="p">(</span><span class="n">thisFeature</span><span class="o">.</span><span class="n">id</span><span class="p">())</span>
</div>
<div class="viewcode-block" id="DdN2mTableWidget.remove"><a class="viewcode-back" href="../autodoc.html#ddui.DdN2mTableWidget.remove">[docs]</a>    <span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">thisRow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputWidget</span><span class="o">.</span><span class="n">currentRow</span><span class="p">()</span>
        <span class="n">featureItem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputWidget</span><span class="o">.</span><span class="n">takeItem</span><span class="p">(</span><span class="n">thisRow</span><span class="p">,</span>  <span class="mi">0</span><span class="p">)</span>
        <span class="n">thisFeature</span> <span class="o">=</span> <span class="n">featureItem</span><span class="o">.</span><span class="n">feature</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tableLayer</span><span class="o">.</span><span class="n">deleteFeature</span><span class="p">(</span><span class="n">thisFeature</span><span class="o">.</span><span class="n">id</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputWidget</span><span class="o">.</span><span class="n">removeRow</span><span class="p">(</span><span class="n">thisRow</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hasChanges</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">maxRows</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addButton</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputWidget</span><span class="o">.</span><span class="n">rowCount</span><span class="p">()</span>  <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">maxRows</span><span class="p">)</span>
</div></div>
<div class="viewcode-block" id="DdPushButton"><a class="viewcode-back" href="../autodoc.html#ddui.DdPushButton">[docs]</a><span class="k">class</span> <span class="nc">DdPushButton</span><span class="p">(</span><span class="n">DdInputWidget</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;abstract class, needs subclassing&#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">attribute</span><span class="p">):</span>
        <span class="n">DdInputWidget</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">attribute</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;&lt;ddui.DdPushButton </span><span class="si">%s</span><span class="s">&gt;&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>

<div class="viewcode-block" id="DdPushButton.setupUi"><a class="viewcode-back" href="../autodoc.html#ddui.DdPushButton.setupUi">[docs]</a>    <span class="k">def</span> <span class="nf">setupUi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">parent</span><span class="p">,</span>  <span class="n">db</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getLabel</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputWidget</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QPushButton</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">,</span>  <span class="n">parent</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputWidget</span><span class="o">.</span><span class="n">setToolTip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">comment</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputWidget</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clicked</span><span class="p">)</span>
        <span class="n">parent</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputWidget</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="DdPushButton.clicked"><a class="viewcode-back" href="../autodoc.html#ddui.DdPushButton.clicked">[docs]</a>    <span class="k">def</span> <span class="nf">clicked</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">QtGui</span><span class="o">.</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">information</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span>  <span class="s">&quot;&quot;</span><span class="p">,</span>  <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">+</span> <span class="s">&quot; has been clicked&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="DdPushButton.initialize"><a class="viewcode-back" href="../autodoc.html#ddui.DdPushButton.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">layer</span><span class="p">,</span>  <span class="n">feature</span><span class="p">,</span>  <span class="n">db</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;must be implemented in child class&#39;&#39;&#39;</span>
        <span class="k">pass</span>
</div>
<div class="viewcode-block" id="DdPushButton.save"><a class="viewcode-back" href="../autodoc.html#ddui.DdPushButton.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">layer</span><span class="p">,</span>  <span class="n">feature</span><span class="p">,</span>  <span class="n">db</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;must be implemented in child class&#39;&#39;&#39;</span>
        <span class="k">pass</span>
</pre></div></div></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">DataDrivenInputMask 0.1 documentation</a> &raquo;</li>
          <li><a href="index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Bernhard Ströbl / Kommunale Immobilien Jena.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>